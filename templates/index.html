{% extends "base.html" %}

{% block sticky_tabs %}
<!-- Sticky Tab Navigation -->
<div class="sticky-tabs">
    <div class="container">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link{% if tab == 'players' %} active{% endif %}" id="players-main-tab" data-bs-toggle="tab" data-bs-target="#players-tab-content" type="button" role="tab">
                    üë§ Spelare
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link{% if tab == 'teams' %} active{% endif %}" id="teams-main-tab" data-bs-toggle="tab" data-bs-target="#teams-tab-content" type="button" role="tab">
                    üë• Lag
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/series_matches{% if league == 'riksserien' %}?league=riksserien{% endif %}">
                    üìã Seriematcher
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link{% if tab == 'stats' %} active{% endif %}" id="stats-main-tab" data-bs-toggle="tab" data-bs-target="#stats-tab-content" type="button" role="tab">
                    üéØ Topplistor
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link{% if tab == 'weekly' %} active{% endif %}" id="weekly-main-tab" data-bs-toggle="tab" data-bs-target="#weekly-tab-content" type="button" role="tab">
                    ‚≠ê {% if league == 'riksserien' %}Omg√•ngens b√§sta{% else %}Veckans prestationer!{% endif %}
                </button>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block content %}

<!-- Tab Content -->
<div class="tab-content" id="mainTabContent">
    <!-- Players Tab -->
    <div class="tab-pane fade{% if tab == 'players' %} show active{% endif %}" id="players-tab-content" role="tabpanel">

<!-- Nyhetsbanner -->
<div class="news-banner mb-4">
    <div class="news-banner-header">
        <span class="news-icon">üéâ</span>
        <strong>Nyheter</strong>
        <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="alert" aria-label="Close" onclick="this.closest('.news-banner').style.display='none'"></button>
    </div>
    <div class="news-banner-body">
        <a href="/tournaments" class="news-item-link" onclick="trackClick('news_cupstatistik')">
            <span class="news-item-icon">üèÜ</span>
            <div>
                <strong>Cupstatistik</strong> - Nu finns detaljerad statistik fr√•n cuper och turneringar! S√∂k spelare, se matcher, legs och kaststatistik.
            </div>
        </a>
        {% if league == 'riksserien' %}
        <a href="/series_matches?league=riksserien" class="news-item-link" onclick="trackClick('news_seriematcher_riksserien')">
            <span class="news-item-icon">üìã</span>
            <div>
                <strong>Seriematcher</strong> - Se alla spelade seriematcher i Riksserien, grupperat per vecka och division. Klicka p√• en match f√∂r att se detaljer!
            </div>
        </a>
        {% else %}
        <a href="/?league=riksserien" class="news-item-link" onclick="trackClick('news_riksserien')">
            <span class="news-item-icon"><svg class="flag-icon-lg" viewBox="0 0 16 10" width="24" height="15"><rect width="16" height="10" fill="#006AA7"/><rect x="5" width="2" height="10" fill="#FECC00"/><rect y="4" width="16" height="2" fill="#FECC00"/></svg></span>
            <div>
                <strong>Riksserien</strong> - Nu finns √§ven Riksserien p√• EasyStat! Klicka h√§r f√∂r att utforska statistik fr√•n Sveriges nationella dartserie!
            </div>
        </a>
        <a href="/series_matches" class="news-item-link" onclick="trackClick('news_seriematcher')">
            <span class="news-item-icon">üìã</span>
            <div>
                <strong>Seriematcher</strong> - Se alla spelade seriematcher, grupperat per vecka och division. Klicka p√• en match f√∂r att se detaljer!
            </div>
        </a>
        {% endif %}
    </div>
</div>

<!-- S√∂ksektion f√∂r spelare -->
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="search-hero">
            <h2 class="search-hero-title">üéØ Hitta en spelare</h2>
            <div class="search-box-wrapper">
                <div class="search-input-wrapper">
                    <div class="input-group input-group-lg">
                        <input type="text"
                               id="playerSearch"
                               class="form-control"
                               placeholder="Skriv namnet h√§r..."
                               autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearPlayerSearch()" id="clearPlayerBtn" style="display: none;">
                            ‚úï
                        </button>
                        <button class="btn btn-primary" type="button" onclick="searchByText()">
                            üîç S√∂k
                        </button>
                    </div>
                    <div id="searchSuggestions" class="list-group" style="display: none;"></div>
                </div>

                <!-- Search Results List (for text search) -->
                <div id="searchResultsList" class="mt-3" style="display: none;">
                    <h6 class="text-muted mb-2">S√∂kresultat:</h6>
                    <div id="searchResultsContent" class="list-group"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Spelarresultatsektion -->
<div id="playerResultsSection" class="row justify-content-center mt-4" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="playerResultsTitle">Spelarstatistik</h5>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearPlayerResults()">
                    <i class="bi bi-x-lg"></i> St√§ng
                </button>
            </div>
            <div class="card-body" id="playerResultsBody">
                <!-- Player stats will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Lagresultatsektion -->
<div id="teamResultsSection" class="row justify-content-center mt-4" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="teamResultsTitle">Laguppst√§llning</h5>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearTeamResults()">
                    <i class="bi bi-x-lg"></i> St√§ng
                </button>
            </div>
            <div class="card-body" id="teamResultsBody">
                <!-- Team lineup will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Beta-varning l√§ngst ner -->
<div class="row justify-content-center mt-5">
    <div class="col-md-10 col-lg-8">
        <div class="alert alert-warning alert-dismissible d-flex align-items-center py-2" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div class="flex-grow-1">
                <small class="text-muted mb-0">Statistik f√∂r spelade seriematcher baserat p√• data fr√•n nakka.com</small>
                <strong>Betaversion:</strong> Det kan f√∂rekomma fel i hur data visas.
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>

    </div>
    <!-- End Players Tab -->

    <!-- Teams Tab -->
    <div class="tab-pane fade{% if tab == 'teams' %} show active{% endif %}" id="teams-tab-content" role="tabpanel">

<!-- S√∂ksektion f√∂r lag -->
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="search-hero">
            <h2 class="search-hero-title">üë• Hitta ett lag</h2>
            <div class="search-box-wrapper">
                <div class="search-input-wrapper">
                    <div class="input-group input-group-lg">
                        <input type="text"
                               id="teamSearch"
                               class="form-control"
                               placeholder="Skriv lagnamnet h√§r..."
                               autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearTeamSearch()" id="clearTeamBtn" style="display: none;">
                            ‚úï
                        </button>
                        <button class="btn btn-primary" type="button" onclick="searchTeamByText()">
                            üîç S√∂k
                        </button>
                    </div>
                    <div id="teamSearchSuggestions" class="list-group" style="display: none;"></div>
                </div>

                <!-- Team Search Results List -->
                <div id="teamSearchResultsList" class="mt-3" style="display: none;">
                    <h6 class="text-muted mb-2">S√∂kresultat:</h6>
                    <div id="teamSearchResultsContent" class="list-group"></div>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- Lagresultatsektion i lagfliken -->
        <div id="teamResultsSectionTab" class="row justify-content-center mt-4" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="teamResultsTitleTab">Laguppst√§llning</h5>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearTeamResults()">
                            <i class="bi bi-x-lg"></i> St√§ng
                        </button>
                    </div>
                    <div class="card-body" id="teamResultsBodyTab">
                        <!-- Team lineup will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- End Teams Tab -->

    <!-- Stats Tab -->
    <div class="tab-pane fade{% if tab == 'stats' %} show active{% endif %}" id="stats-tab-content" role="tabpanel">

        <div class="row justify-content-center mb-4 mt-4">
            <div class="col-md-10">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4 text-center">
                        <!-- Season toggle buttons -->
                        <div class="btn-group mb-3" role="group" aria-label="S√§songsfilter">
                            <button type="button" class="btn btn-outline-primary active" id="currentSeasonBtn" onclick="switchToCurrentSeason()">
                                S√§songen 2025/2026
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="allSeasonsBtn" onclick="switchToAllSeasons()">
                                Alla s√§songer
                            </button>
                        </div>

                        <p class="text-muted mb-0 mt-3" id="statsDescription">De mest imponerande prestationerna under s√§songen 2025/2026</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="statsLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laddar statistik...</span>
            </div>
            <p class="mt-2 text-muted">Laddar statistik...</p>
        </div>

        <!-- Stats content -->
        <div id="statsContent" style="display: none;">

            <!-- Highest Average in a Match -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">üî• H√∂gsta pilsnitt i en match (Singel)</h6>
                        </div>
                        <div class="card-body">
                            <div id="topAverages" class="list-group list-group-flush">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Highest Checkout -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">üéØ H√∂gsta utg√•ng</h6>
                        </div>
                        <div class="card-body">
                            <div id="topCheckouts" class="list-group list-group-flush">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shortest Sets -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">‚ö° Kortast leg</h6>
                        </div>
                        <div class="card-body">
                            <div id="topShortestSets" class="list-group list-group-flush">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Most 180s in a Match -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">üíØ Flest gjorda 180 i en match</h6>
                        </div>
                        <div class="card-body">
                            <div id="topMost180s" class="list-group list-group-flush">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
    <!-- End Stats Tab -->

    <!-- Weekly Stats Tab -->
    <div class="tab-pane fade{% if tab == 'weekly' %} show active{% endif %}" id="weekly-tab-content" role="tabpanel">

        <div class="row justify-content-center mb-4 mt-4">
            <div class="col-md-10">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4 text-center">
                        <p class="text-muted mb-0" id="weeklyDescription">{% if league == 'riksserien' %}De b√§sta prestationerna denna omg√•ng{% else %}De b√§sta prestationerna denna vecka{% endif %}</p>
                        <p class="text-muted mb-0 mt-2" id="weeklyDateRange">Laddar...</p>
                        <p class="text-muted mb-0 mt-1" id="weeklyMatchCount"></p>

                        <!-- Week/Round navigation -->
                        <div class="row justify-content-center mt-3 align-items-center">
                            <div class="col-auto">
                                <button class="btn btn-outline-secondary btn-sm" id="prevWeekBtn" onclick="navigateWeek(-1)">
                                    &larr; {% if league == 'riksserien' %}F√∂reg√•ende omg√•ng{% else %}F√∂reg√•ende vecka{% endif %}
                                </button>
                            </div>
                            <div class="col-md-3">
                                <select id="weeklyWeekSelector" class="form-select form-select-sm" onchange="selectWeek()">
                                    <option value="0">{% if league == 'riksserien' %}Senaste omg√•ngen{% else %}Denna vecka{% endif %}</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-outline-secondary btn-sm" id="nextWeekBtn" onclick="navigateWeek(1)" disabled>
                                    {% if league == 'riksserien' %}N√§sta omg√•ng{% else %}N√§sta vecka{% endif %} &rarr;
                                </button>
                            </div>
                        </div>

                        <!-- Division filter -->
                        <div class="row justify-content-center mt-3">
                            <div class="col-md-4">
                                <label for="weeklyDivisionFilter" class="form-label small mb-1">Filtrera per division</label>
                                <select id="weeklyDivisionFilter" class="form-select form-select-sm" onchange="filterWeeklyStats()">
                                    <option value="">Alla divisioner</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="weeklyLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laddar {% if league == 'riksserien' %}omg√•ngens{% else %}veckans{% endif %} statistik...</span>
            </div>
            <p class="mt-2 text-muted">Laddar {% if league == 'riksserien' %}omg√•ngens{% else %}veckans{% endif %} statistik...</p>
        </div>

        <!-- Weekly content -->
        <div id="weeklyContent" style="display: none;">

            <!-- Highest Average this week -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">üî• H√∂gsta pilsnitt (Singel)</h6>
                        </div>
                        <div class="card-body">
                            <div id="weeklyTopAverages" class="list-group list-group-flush">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Highest Checkout this week -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">üéØ H√∂gsta utg√•ng</h6>
                        </div>
                        <div class="card-body">
                            <div id="weeklyTopCheckouts" class="list-group list-group-flush">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shortest Sets this week -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">‚ö° Kortast leg</h6>
                        </div>
                        <div class="card-body">
                            <div id="weeklyShortestSets" class="list-group list-group-flush">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Most 100+ throws this week -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-10">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">üíØ Flest 100+ kast</h6>
                        </div>
                        <div class="card-body">
                            <div id="weeklyMost100plus" class="list-group list-group-flush">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
    <!-- End Weekly Tab -->

</div>
<!-- End Tab Content -->

{% endblock %}

{% block scripts %}
<script>

// Globala variabler
let currentFilters = {
    season: ''
};
let allTeams = [];
// Use window.isNavigatingHistory to share state with app.js
window.isNavigatingHistory = false;
let isNavigatingHistory = false; // Keep for backward compatibility, but sync with window

// Track click events
function trackClick(eventName) {
    fetch('/api/track-click', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ event: eventName })
    }).catch(err => console.debug('Click tracking failed:', err));
}

// Parse match position from match_name (e.g., "Team A vs Team B Singles1" -> "S1")
function parseMatchPosition(matchName) {
    if (!matchName) return '';
    if (matchName.includes(' AD')) return 'AD';
    const singlesMatch = matchName.match(/Singles(\d+)/);
    if (singlesMatch) return 'S' + singlesMatch[1];
    const doublesMatch = matchName.match(/Doubles(\d+)/);
    if (doublesMatch) return 'D' + doublesMatch[1];
    return '';
}

// Load player list on page load
document.addEventListener('DOMContentLoaded', async function() {
    loadPlayerList();
    loadTeamList();
    await loadFilters();
    // Check URL parameters
    const urlParams = new URLSearchParams(window.location.search);

    // Load data for the active tab (tab is set server-side, no .click() needed)
    const activeTab = urlParams.get('tab') || 'players';
    if (activeTab === 'teams') {
        const teamParam = urlParams.get('team');
        if (teamParam) {
            document.getElementById('teamSearch').value = teamParam;
            searchTeam();
        }
    } else if (activeTab === 'stats') {
        loadCurrentSeasonStats();
    } else if (activeTab === 'weekly') {
        loadWeeklyStats();
    }

    // Track tab navigation
    function trackTabNavigation(tabName) {
        fetch('/api/track-tab', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ tab: tabName })
        }).catch(err => console.debug('Tab tracking failed:', err));
    }

    // Make trackTabNavigation available globally for sub-tabs
    window.trackSubTab = function(subTabName) {
        const teamName = window.currentTeamName || '';
        fetch('/api/track-tab', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ tab: 'team-sub:' + subTabName, context: teamName })
        }).catch(err => console.debug('Sub-tab tracking failed:', err));
    };

    // Load stats when stats tab is clicked
    document.getElementById('stats-main-tab').addEventListener('click', function() {
        trackTabNavigation('stats');
        if (currentStatsView === 'season') {
            loadCurrentSeasonStats();
        } else {
            loadTopStats();
        }
    });

    // Load weekly stats when weekly tab is clicked
    document.getElementById('weekly-main-tab').addEventListener('click', function() {
        trackTabNavigation('weekly');
        loadWeeklyStats();
    });

    // Track players tab
    document.getElementById('players-main-tab').addEventListener('click', function() {
        trackTabNavigation('players');
    });

    // Track teams tab
    document.getElementById('teams-main-tab').addEventListener('click', function() {
        trackTabNavigation('teams');
    });

    // Check for URL parameter for automatic player search
    const playerParam = urlParams.get('player');
    if (playerParam) {
        document.getElementById('playerSearch').value = playerParam;
        searchPlayer();
    }

    // Setup filter change handlers
    const seasonFilterEl = document.getElementById('seasonFilter');
    if (seasonFilterEl) {
        seasonFilterEl.addEventListener('change', updateFilters);
    }

    // Setup browser history navigation
    setupHistoryNavigation();
});

// Browser history navigation
function setupHistoryNavigation() {
    // Add click listeners to tab buttons to update URL
    document.getElementById('players-main-tab').addEventListener('click', function() {
        if (!window.isNavigatingHistory && !isNavigatingHistory) {
            const url = new URL(window.location);
            url.searchParams.delete('tab');
            url.searchParams.delete('team');
            window.history.pushState({ tab: 'players' }, '', url);
        }
    });

    document.getElementById('teams-main-tab').addEventListener('click', function() {
        if (!window.isNavigatingHistory && !isNavigatingHistory) {
            const url = new URL(window.location);
            url.searchParams.set('tab', 'teams');
            url.searchParams.delete('player');
            window.history.pushState({ tab: 'teams' }, '', url);
        }
    });

    document.getElementById('stats-main-tab').addEventListener('click', function() {
        if (!window.isNavigatingHistory && !isNavigatingHistory) {
            const url = new URL(window.location);
            url.searchParams.set('tab', 'stats');
            url.searchParams.delete('player');
            url.searchParams.delete('team');
            window.history.pushState({ tab: 'stats' }, '', url);
        }
    });

    // Handle back/forward buttons
    window.addEventListener('popstate', function(event) {
        window.isNavigatingHistory = true;
        isNavigatingHistory = true;

        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        const player = urlParams.get('player');
        const team = urlParams.get('team');

        if (tab === 'teams') {
            document.getElementById('teams-main-tab').click();
            if (team) {
                // Restore team search
                document.getElementById('teamSearch').value = team;
                searchTeam();
            }
        } else if (tab === 'stats') {
            document.getElementById('stats-main-tab').click();
        } else {
            document.getElementById('players-main-tab').click();
            if (player) {
                // Restore player search
                document.getElementById('playerSearch').value = player;
                searchPlayer();
            }
        }

        setTimeout(() => {
            window.isNavigatingHistory = false;
            isNavigatingHistory = false;
        }, 100);
    });
}

async function loadFilters() {
    try {
        const response = await fetch('/api/leagues');
        const data = await response.json();
        
        // Set current season to latest available
        const validSeasons = data.seasons.filter(s => s && s !== 'Unknown');
        if (validSeasons.length > 0) {
            currentFilters.season = validSeasons[0];
        }
        
        
    } catch (error) {
        console.error('Kunde inte ladda filter:', error);
    }
}

function updateFilters() {
    currentFilters.season = document.getElementById('seasonFilter').value;
    
    // Update filter info text
    const filterInfo = document.getElementById('filterInfo');
    let infoText = 'Visar data f√∂r ';
    
    if (currentFilters.season) {
        infoText += `s√§song ${currentFilters.season}`;
    } else {
        infoText += 'alla s√§songer';
    }
    
    filterInfo.textContent = infoText;
    
    // If a player is currently searched, refresh their stats with new filters
    const currentPlayer = document.getElementById('playerSearch').value.trim();
    if (currentPlayer) {
        searchPlayer();
    }
}

let allPlayers = [];

async function loadPlayerList() {
    try {
        const response = await fetch('/api/players');
        allPlayers = await response.json();
    } catch (error) {
        console.error('Kunde inte ladda spelare:', error);
    }
}

async function loadTeamList() {
    try {
        const response = await fetch('/api/teams', {
            cache: 'no-cache'  // Disable cache
        });
        allTeams = await response.json();
        console.log(`Loaded ${allTeams.length} teams from API`);

    } catch (error) {
        console.error('Kunde inte ladda lag:', error);
    }
}

// Clear player search
function clearPlayerSearch() {
    document.getElementById('playerSearch').value = '';
    document.getElementById('clearPlayerBtn').style.display = 'none';
    document.getElementById('searchSuggestions').style.display = 'none';
    document.getElementById('searchResultsList').style.display = 'none';
    clearPlayerResults();
}

// Clear team search
function clearTeamSearch() {
    document.getElementById('teamSearch').value = '';
    document.getElementById('clearTeamBtn').style.display = 'none';
    document.getElementById('teamSearchSuggestions').style.display = 'none';
    document.getElementById('teamSearchResultsList').style.display = 'none';
    clearTeamResults();
}

// S√∂kfunktionalitet
document.getElementById('playerSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();

    // Show/hide clear button
    document.getElementById('clearPlayerBtn').style.display = query.length > 0 ? '' : 'none';

    // Hide search results list when typing
    document.getElementById('searchResultsList').style.display = 'none';

    if (query.length < 2) {
        document.getElementById('searchSuggestions').style.display = 'none';
        return;
    }
    
    const suggestions = allPlayers.filter(player => 
        player.toLowerCase().includes(query)
    ).slice(0, 10);
    
    const suggestionsContainer = document.getElementById('searchSuggestions');
    if (suggestions.length > 0) {
        suggestionsContainer.innerHTML = suggestions.map(player => 
            `<button type="button" class="list-group-item list-group-item-action" onclick="selectPlayer('${player}')">${player}</button>`
        ).join('');
        suggestionsContainer.style.display = 'block';
    } else {
        suggestionsContainer.style.display = 'none';
    }
});

// New search function for text-based search
function searchByText() {
    const query = document.getElementById('playerSearch').value.trim().toLowerCase();
    if (query.length < 2) {
        alert('Skriv minst 2 tecken f√∂r att s√∂ka');
        return;
    }
    
    // Hide autocomplete suggestions
    document.getElementById('searchSuggestions').style.display = 'none';
    
    // Find all matching players
    const matchingPlayers = allPlayers.filter(player => 
        player.toLowerCase().includes(query)
    );
    
    if (matchingPlayers.length === 0) {
        alert('Inga spelare hittades som matchar din s√∂kning');
        return;
    }
    
    if (matchingPlayers.length === 1) {
        // Only one match, select it directly
        selectPlayer(matchingPlayers[0]);
        return;
    }
    
    // Multiple matches, show list
    const resultsContainer = document.getElementById('searchResultsContent');
    resultsContainer.innerHTML = matchingPlayers.map(player => 
        `<button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="selectPlayer('${player}')">
            <span>${player}</span>
            <small class="text-primary">Visa statistik ‚Üí</small>
        </button>`
    ).join('');
    
    document.getElementById('searchResultsList').style.display = 'block';
    
    // Scroll to results
    document.getElementById('searchResultsList').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
};

function selectPlayer(playerName) {
    document.getElementById('playerSearch').value = playerName;
    document.getElementById('searchSuggestions').style.display = 'none';
    document.getElementById('searchResultsList').style.display = 'none';
    searchPlayer();
}

async function searchPlayer() {
    const playerName = document.getElementById('playerSearch').value.trim();
    if (!playerName) return;

    // Track search
    fetch('/api/track-search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: playerName })
    }).catch(err => console.debug('Search tracking failed:', err));

    try {
        const url = `/api/player/${encodeURIComponent(playerName)}`;

        const response = await fetch(url);
        const data = await response.json();

        if (response.ok) {
            showPlayerStats(data);
        } else {
            alert(`Spelare hittades inte: ${data.error}`);
        }
    } catch (error) {
        console.error('S√∂kning misslyckades:', error);
        alert('S√∂kfel');
    }
}

async function showPlayerStats(stats) {
    // Store matches data for filtering/sorting
    storeMatchesData(stats.recent_matches);
    
    // Get the original searched player name (with team if applicable)
    const searchedPlayerName = document.getElementById('playerSearch').value.trim();
    
    // Uppdatera titel och visa laddning
    document.getElementById('playerResultsTitle').textContent = `${stats.player_name} - Spelarstatistik`;
    document.getElementById('playerResultsBody').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laddar kast-analys...</span>
            </div>
            <p>H√§mtar detaljerad spelanalys...</p>
        </div>
    `;
    
    // Show the results section
    document.getElementById('playerResultsSection').style.display = 'block';
    
    // Scroll to the results section
    document.getElementById('playerResultsSection').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
    
    // Ladda sedan kastanalys i bakgrunden - use original searched name for team filtering
    const throwData = await goldenStat.fetchThrowAnalysis(searchedPlayerName, currentFilters);

    console.log('Mottagen throwData:', throwData); // Debug

    // Calculate doubles season stats
    const currentSeason = currentFilters.season || '2025/2026';
    const seasonDoubles = stats.recent_matches.filter(m => m.match_type === 'Doubles' && m.season === currentSeason);
    const seasonDoublesWins = seasonDoubles.filter(m => m.won === 1).length;
    const seasonDoublesTotal = seasonDoubles.length;
    const seasonDoublesWinPct = seasonDoublesTotal > 0 ? ((seasonDoublesWins / seasonDoublesTotal) * 100).toFixed(1) : 0;

    document.getElementById('playerResultsBody').innerHTML = `
        <!-- Navigation tabs -->
        <ul class="nav nav-tabs nav-fill mb-3" id="playerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active fw-bold" id="matches-tab" data-bs-toggle="tab" data-bs-target="#matches" type="button">
                    üéØ Matcher (${stats.recent_matches.length})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                    üîç √ñversikt
                </button>
            </li>
        </ul>
        
        <!-- Flikinneh√•ll -->
        <div class="tab-content mt-3" id="playerTabsContent">
            <!-- √ñversiktsflik -->
            <div class="tab-pane fade" id="overview" role="tabpanel">
                
                <!-- Singlarstatistik - Innevarande s√§song -->
                ${throwData && throwData.statistics && (throwData.statistics.won_matches_count > 0 || throwData.statistics.lost_matches_count > 0) ? `
                <div class="mb-3">
                    <h6 class="text-muted mb-2">üéØ Singlar - Innevarande s√§song</h6>
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100 card-clickable" onclick="switchToMatchesTab()" style="cursor: pointer;" title="Klicka f√∂r att se alla matcher">
                                <div class="card-body py-2">
                                    <h5 class="text-dark mb-1">${throwData.statistics.won_matches_count + throwData.statistics.lost_matches_count}</h5>
                                    <small class="card-text">Matcher üìã</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-primary mb-1">${throwData.statistics.average_score}</h5>
                                    <small class="card-text">Pilsnitt</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-success mb-1">${throwData.statistics.won_matches_count}</h5>
                                    <small class="card-text">Vinster</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-dark mb-1">${((throwData.statistics.won_matches_count / (throwData.statistics.won_matches_count + throwData.statistics.lost_matches_count)) * 100).toFixed(1)}%</h5>
                                    <small class="card-text">Vinstprocent</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Kaststatistik - Innevarande s√§song -->
                    <div class="row g-2 mt-2">
                        <div class="col-6 col-lg-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-dark mb-1">${throwData.statistics.throws_over_100 || 0}</h6>
                                    <small class="card-text">100+ kast</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-dark mb-1">${throwData.statistics.throws_over_140 || 0}</h6>
                                    <small class="card-text">140+ kast</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-dark mb-1">${throwData.statistics.throws_180 || 0}</h6>
                                    <small class="card-text">180-kast</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-dark mb-1">${throwData.statistics.high_finishes || 0}</h6>
                                    <small class="card-text">H√∂ga utg√•ngar</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Singlarstatistik - Totalt -->
                <div class="mb-3">
                    <h6 class="text-muted mb-2">üéØ Singlar - Totalt (alla s√§songer)</h6>
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100 card-clickable" onclick="switchToMatchesTab()" style="cursor: pointer;" title="Klicka f√∂r att se alla matcher">
                                <div class="card-body py-2">
                                    <h5 class="text-dark mb-1">${stats.singles.total_matches}</h5>
                                    <small class="card-text">Matcher üìã</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-primary mb-1">${stats.singles.average_score}</h5>
                                    <small class="card-text">Pilsnitt</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-success mb-1">${stats.singles.wins}</h5>
                                    <small class="card-text">Vinster</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-dark mb-1">${stats.singles.win_percentage.toFixed(1)}%</h5>
                                    <small class="card-text">Vinstprocent</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Kaststatistik - Totalt -->
                    ${throwData && throwData.all_time_statistics && Object.keys(throwData.all_time_statistics).length > 0 ? `
                    <div class="row g-2 mt-2">
                        <div class="col-6 col-lg-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-dark mb-1">${throwData.all_time_statistics.throws_over_100 || 0}</h6>
                                    <small class="card-text">100+ kast</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-dark mb-1">${throwData.all_time_statistics.throws_over_140 || 0}</h6>
                                    <small class="card-text">140+ kast</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-dark mb-1">${throwData.all_time_statistics.throws_180 || 0}</h6>
                                    <small class="card-text">180-kast</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-dark mb-1">${throwData.all_time_statistics.high_finishes || 0}</h6>
                                    <small class="card-text">H√∂ga utg√•ngar</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- Dubblarstatistik - Innevarande s√§song -->
                ${seasonDoublesTotal > 0 ? `
                <div class="mb-3">
                    <h6 class="text-muted mb-2">üë• Dubblar - Innevarande s√§song</h6>
                    <div class="row g-2">
                        <div class="col-6 col-md-4">
                            <div class="card text-center bg-light h-100 card-clickable" onclick="switchToMatchesTab()" style="cursor: pointer;" title="Klicka f√∂r att se alla matcher">
                                <div class="card-body py-2">
                                    <h5 class="text-dark mb-1">${seasonDoublesTotal}</h5>
                                    <small class="card-text">Matcher üìã</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-success mb-1">${seasonDoublesWins}</h5>
                                    <small class="card-text">Vinster</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-dark mb-1">${seasonDoublesWinPct}%</h5>
                                    <small class="card-text">Vinstprocent</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Dubblarstatistik - Totalt -->
                <div class="mb-3">
                    <h6 class="text-muted mb-2">üë• Dubblar - Totalt (alla s√§songer)</h6>
                    <div class="row g-2">
                        <div class="col-6 col-md-4">
                            <div class="card text-center bg-light h-100 card-clickable" onclick="switchToMatchesTab()" style="cursor: pointer;" title="Klicka f√∂r att se alla matcher">
                                <div class="card-body py-2">
                                    <h5 class="text-dark mb-1">${stats.doubles.total_matches}</h5>
                                    <small class="card-text">Matcher üìã</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-success mb-1">${stats.doubles.wins}</h5>
                                    <small class="card-text">Vinster</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-dark mb-1">${stats.doubles.win_percentage.toFixed(1)}%</h5>
                                    <small class="card-text">Vinstprocent</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Chart -->
                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="progressChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Throw Distribution Chart -->
                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="throwDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Match Position Chart -->
                {% if league != 'riksserien' %}
                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="matchPositionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}


            </div>
            <!-- Matcherflik -->
            <div class="tab-pane fade show active" id="matches" role="tabpanel">
                
                <div class="d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm" id="matchesTable">
                            <thead>
                                <tr>
                                    <th class="sortable-header" data-sort="date" onclick="sortByColumn('date')">Datum <span class="sort-indicator" id="sort-date">‚ñº</span></th>
                                    <th class="sortable-header" data-sort="type" onclick="sortByColumn('type')">Typ <span class="sort-indicator" id="sort-type"></span></th>
                                    <th>Motst√•ndare</th>
                                    <th>Resultat</th>
                                    <th class="sortable-header" data-sort="average" onclick="sortByColumn('average')">Snitt <span class="sort-indicator" id="sort-average"></span></th>
                                    <th>Resultat</th>
                                </tr>
                            </thead>
                            <tbody id="matchesTableBody">
                                ${stats.recent_matches.map(match => `
                                    <tr class="${match.sub_match_id ? 'table-row-clickable' : ''}" ${match.sub_match_id ? 'onclick="navigateTo(\'/sub_match_throws?sub_match_id=' + match.sub_match_id + '&team=' + match.team_number + '\')" title="Klicka f√∂r att se kastomg√•ngar"' : ''} data-match-type="${match.match_type}" data-match-date="${match.match_date}" data-average="${match.player_avg || 0}">
                                        <td><small style="white-space: nowrap;">${match.match_date ? new Date(match.match_date).toLocaleDateString('sv-SE') : 'N/A'}</small></td>
                                        <td><small><span class="badge ${match.match_type === 'Singles' ? 'bg-primary' : 'bg-secondary'}">${parseMatchPosition(match.match_name) || (match.match_type === 'Singles' ? 'S' : 'D')}</span></small></td>
                                        <td><small>
                                            ${(match.match_type === 'Doubles' || (match.match_name && match.match_name.includes(' AD'))) && match.teammate ?
                                                `<div><strong>Du spelade med:</strong> ${match.teammate}</div>` :
                                                ''
                                            }
                                            <div><strong>Motst√•ndare:</strong> ${match.opponent || match.team1_name + ' vs ' + match.team2_name}</div>
                                            <span class="text-muted">(${match.opponent_team || match.match_type})</span><br>
                                            <span class="text-muted" style="font-size: 0.8em;">(${match.player_team}${match.season ? ', ' + match.season : ''}${match.division && match.division !== 'Unknown' ? ', ' + match.division : ''})</span>
                                        </small></td>
                                        <td><small>${match.team1_legs} - ${match.team2_legs}</small></td>
                                        <td><small>${match.player_avg ? match.player_avg.toFixed(2) : 'N/A'}</small></td>
                                        <td>
                                            ${match.won ? 
                                                `<span class="badge bg-success badge-sm">Vinst</span>` : 
                                                `<span class="badge bg-danger badge-sm">F√∂rlust</span>`
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Mobilvy -->
                <div class="d-md-none">
                    <!-- Mobile sort buttons -->
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" class="btn btn-sm btn-outline-primary mobile-sort-btn active" data-sort="date" onclick="mobileSortByColumn('date', this)">
                            Datum <span class="sort-indicator">‚ñº</span>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary mobile-sort-btn" data-sort="type" onclick="mobileSortByColumn('type', this)">
                            Typ
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary mobile-sort-btn" data-sort="average" onclick="mobileSortByColumn('average', this)">
                            Snitt
                        </button>
                    </div>

                    <div id="mobileMatchesList">
                    ${stats.recent_matches.map(match => `
                        <div class="card mb-2 ${match.sub_match_id ? 'card-clickable' : ''}" ${match.sub_match_id ? 'title="Klicka f√∂r att se kastomg√•ngar"' : ''} data-match-type="${match.match_type}" data-match-date="${match.match_date}" data-average="${match.player_avg || 0}">
                            <div class="card-body py-2" ${match.sub_match_id ? 'onclick="navigateTo(\'/sub_match_throws?sub_match_id=' + match.sub_match_id + '&team=' + match.team_number + '\')"' : ''}>
                                <div class="row">
                                    <div class="col-8">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <small class="text-muted" style="white-space: nowrap;">${match.match_date ? new Date(match.match_date).toLocaleDateString('sv-SE') : 'N/A'}</small>
                                                    <span class="badge ${match.match_type === 'Singles' ? 'bg-primary' : 'bg-secondary'} badge-sm">${parseMatchPosition(match.match_name) || (match.match_type === 'Singles' ? 'S' : 'D')}</span>
                                                </div>
                                                ${(match.match_type === 'Doubles' || (match.match_name && match.match_name.includes(' AD'))) && match.teammate ?
                                                    `<div><small><strong>Med:</strong> ${match.teammate}</small></div>` :
                                                    ''
                                                }
                                                <div><strong>${match.opponent || match.team1_name + ' vs ' + match.team2_name}</strong> <small class="text-muted">(${match.opponent_team || match.match_type})</small></div>
                                                <div><small class="text-muted" style="font-size: 0.8em;">(${match.player_team}${match.season ? ', ' + match.season : ''}${match.division && match.division !== 'Unknown' ? ', ' + match.division : ''})</small></div>
                                                <div>
                                                    <span class="fw-bold">${match.team1_legs} - ${match.team2_legs}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div>
                                            ${match.won ? 
                                                `<span class="badge bg-success">Vinst</span>` : 
                                                `<span class="badge bg-danger">F√∂rlust</span>`
                                            }
                                        </div>
                                        <div><small class="text-muted">Snitt: ${match.player_avg ? match.player_avg.toFixed(2) : 'N/A'}</small></div>
                                        ${match.sub_match_id ? '<div><small class="text-primary">üéØ Visa match</small></div>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Skapa diagram efter att inneh√•ll har laddats
    setTimeout(() => {
        // √ñversiktsdiagram
        goldenStat.createProgressChart('progressChart', stats.recent_matches);
        
        // Kastf√∂rdelningsdiagram i √∂versikt (fallback till all-time om s√§songsdata saknas)
        const scoreRanges = (throwData && throwData.statistics && throwData.statistics.score_ranges)
            ? throwData.statistics.score_ranges
            : (throwData && throwData.all_time_statistics && throwData.all_time_statistics.score_ranges)
                ? throwData.all_time_statistics.score_ranges
                : null;
        if (scoreRanges) {
            goldenStat.createThrowDistributionChart('throwDistributionChart', scoreRanges);
        }
        
        // Matchpositionsdiagram (ej relevant f√∂r riksserien)
        if (!IS_RIKSSERIEN) {
            const positionStats = goldenStat.calculateMatchPositions(stats.recent_matches);
            goldenStat.createMatchPositionChart('matchPositionChart', positionStats);
        }
    }, 100);
}

// Ladda och visa minnesv√§rda matcher
async function loadMemorableMatches(playerId) {
    try {
        const response = await fetch(`/api/player/${playerId}/memorable-matches`);
        const data = await response.json();

        if (response.ok && data.memorable_matches && data.memorable_matches.length > 0) {
            displayMemorableMatches(data.memorable_matches);
            document.getElementById('memorableMatchesSection').style.display = 'block';
        } else {
            // D√∂lj sektionen om inga matcher finns
            document.getElementById('memorableMatchesSection').style.display = 'none';
        }
    } catch (error) {
        console.error('Fel vid h√§mtning av minnesv√§rda matcher:', error);
        document.getElementById('memorableMatchesSection').style.display = 'none';
    }
}

// Visa minnesv√§rda matcher
function displayMemorableMatches(matches) {
    const container = document.getElementById('memorableMatchesList');

    if (!matches || matches.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3">Inga minnesv√§rda matcher hittades</div>';
        return;
    }

    const matchItems = matches.map((match, index) => {
        const date = new Date(match.date).toLocaleDateString('sv-SE');
        const resultIcon = match.won_match ? 'üü¢' : 'üî¥';
        const resultText = match.won_match ? 'Vinst' : 'F√∂rlust';

        // Skapa statistikikoner
        const stats = [];
        if (match.average_score >= 45) stats.push(`üéØ ${match.average_score}`);
        if (match.short_sets > 0) stats.push(`‚ö° ${match.short_sets} kort set`);
        if (match.high_finishes > 0) stats.push(`üî• ${match.high_finishes} h√∂g utg√•ng`);

        const statsText = stats.length > 0 ? stats.join(' ‚Ä¢ ') : 'Bra prestanda';

        return `
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
                 style="cursor: pointer;" onclick="showSubMatchThrows(${match.sub_match_id})">
                <div class="ms-2 me-auto">
                    <div class="d-flex align-items-center mb-1">
                        <span class="badge bg-primary rounded-pill me-2">#${index + 1}</span>
                        <div class="fw-bold">${match.opponent_team}</div>
                        <span class="ms-2">${resultIcon} ${resultText}</span>
                    </div>
                    <small class="text-muted d-block">${date} ‚Ä¢ ${match.season || 'Ok√§nd s√§song'}</small>
                    <small class="text-info">${statsText}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-warning text-dark" title="Minnesv√§rdighetspo√§ng">
                        ${match.memorability_score}
                    </span>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = matchItems;
}

// Hantera Enter-tangent i s√∂kning
document.getElementById('playerSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('searchSuggestions').style.display = 'none';
        
        // Check if there are visible suggestions, select first one
        const suggestions = document.querySelectorAll('#searchSuggestions .list-group-item');
        if (suggestions.length > 0 && document.getElementById('searchSuggestions').style.display !== 'none') {
            const firstSuggestion = suggestions[0].textContent;
            selectPlayer(firstSuggestion);
        } else {
            // No suggestions visible, do text search
            searchByText();
        }
    }
});

// Funktion f√∂r att v√§xla till Matcher-fliken
function switchToMatchesTab() {
    const matchesTab = document.getElementById('matches-tab');
    if (matchesTab) {
        matchesTab.click();
        
        // Scroll to top of matches section
        setTimeout(() => {
            document.getElementById('playerTabs').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }, 100);
    }
}

// Global variable to store original matches data
let originalMatchesData = [];

// Current sort state
let currentSortColumn = 'date';
let currentSortDirection = 'desc';

// Store matches data when player stats are loaded
function storeMatchesData(matches) {
    originalMatchesData = matches.slice(); // Create a copy
}

// Sort by column header click
function sortByColumn(column) {
    // Toggle direction if same column, otherwise default to desc
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'desc' ? 'asc' : 'desc';
    } else {
        currentSortColumn = column;
        currentSortDirection = 'desc';
    }

    // Update sort indicators
    updateSortIndicators();

    // Apply sort
    let sortedMatches = applySortToMatches(originalMatchesData.slice());

    // Update display
    updateMatchesDisplay(sortedMatches);
}

// Update sort indicator arrows
function updateSortIndicators() {
    // Clear all desktop indicators
    document.querySelectorAll('#matchesTable .sort-indicator').forEach(el => el.textContent = '');

    // Set active desktop indicator
    const activeIndicator = document.getElementById('sort-' + currentSortColumn);
    if (activeIndicator) {
        activeIndicator.textContent = currentSortDirection === 'desc' ? '‚ñº' : '‚ñ≤';
    }

    // Update mobile buttons
    document.querySelectorAll('.mobile-sort-btn').forEach(btn => {
        const btnSort = btn.dataset.sort;
        const indicator = btn.querySelector('.sort-indicator');

        if (btnSort === currentSortColumn) {
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-primary', 'active');
            if (indicator) {
                indicator.textContent = currentSortDirection === 'desc' ? '‚ñº' : '‚ñ≤';
            } else {
                // Add indicator if not exists
                btn.innerHTML = btn.textContent.trim().split(' ')[0] + ' <span class="sort-indicator">' + (currentSortDirection === 'desc' ? '‚ñº' : '‚ñ≤') + '</span>';
            }
        } else {
            btn.classList.remove('btn-outline-primary', 'active');
            btn.classList.add('btn-outline-secondary');
            if (indicator) {
                indicator.textContent = '';
            }
        }
    });
}

// Mobile sort button handler
function mobileSortByColumn(column, button) {
    sortByColumn(column);
}

// Apply sorting logic based on current sort state
function applySortToMatches(matches) {
    return matches.sort((a, b) => {
        let comparison = 0;

        switch (currentSortColumn) {
            case 'date':
                comparison = new Date(b.match_date || 0) - new Date(a.match_date || 0);
                break;
            case 'type':
                const typeA = a.match_type || '';
                const typeB = b.match_type || '';
                comparison = typeA.localeCompare(typeB);
                break;
            case 'average':
                comparison = (b.player_avg || 0) - (a.player_avg || 0);
                break;
            default:
                return 0;
        }

        // Reverse for ascending order
        return currentSortDirection === 'asc' ? -comparison : comparison;
    });
}

// Update matches display with filtered/sorted data
function updateMatchesDisplay(matches) {
    // Update desktop table
    const tableBody = document.getElementById('matchesTableBody');
    if (tableBody) {
        tableBody.innerHTML = matches.map(match => `
            <tr class="${match.sub_match_id ? 'table-row-clickable' : ''}" ${match.sub_match_id ? 'onclick="navigateTo(\'/sub_match_throws?sub_match_id=' + match.sub_match_id + '&team=' + match.team_number + '\')" title="Klicka f√∂r att se kastomg√•ngar"' : ''} data-match-type="${match.match_type}" data-match-date="${match.match_date}" data-average="${match.player_avg || 0}">
                <td><small style="white-space: nowrap;">${match.match_date ? new Date(match.match_date).toLocaleDateString('sv-SE') : 'N/A'}</small></td>
                <td><small><span class="badge ${match.match_type === 'Singles' ? 'bg-primary' : 'bg-secondary'}">${parseMatchPosition(match.match_name) || (match.match_type === 'Singles' ? 'S' : 'D')}</span></small></td>
                <td><small>
                    ${(match.match_type === 'Doubles' || (match.match_name && match.match_name.includes(' AD'))) && match.teammate ?
                        `<div><strong>Du spelade med:</strong> ${match.teammate}</div>` :
                        ''
                    }
                    <div>${match.opponent || match.team1_name + ' vs ' + match.team2_name} <span class="text-muted">(${match.opponent_team || match.match_type})</span></div>
                    <span class="text-muted" style="font-size: 0.8em;">(${match.player_team}${match.season ? ', ' + match.season : ''}${match.division && match.division !== 'Unknown' ? ', ' + match.division : ''})</span>
                </small></td>
                <td><small>${match.team1_legs} - ${match.team2_legs}</small></td>
                <td><small>${match.player_avg ? match.player_avg.toFixed(2) : 'N/A'}</small></td>
                <td>
                    ${match.won ? 
                        '<span class="badge bg-success badge-sm">Vinst</span>' : 
                        '<span class="badge bg-danger badge-sm">F√∂rlust</span>'
                    }
                </td>
            </tr>
        `).join('');
    }
    
    // Update mobile list
    const mobileList = document.getElementById('mobileMatchesList');
    if (mobileList) {
        mobileList.innerHTML = matches.map(match => `
            <div class="card mb-2 ${match.sub_match_id ? 'card-clickable' : ''}" ${match.sub_match_id ? 'title="Klicka f√∂r att se kastomg√•ngar"' : ''} data-match-type="${match.match_type}" data-match-date="${match.match_date}" data-average="${match.player_avg || 0}">
                <div class="card-body py-2" ${match.sub_match_id ? 'onclick="navigateTo(\'/sub_match_throws?sub_match_id=' + match.sub_match_id + '&team=' + match.team_number + '\')"' : ''}>
                    <div class="row">
                        <div class="col-8">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <small class="text-muted" style="white-space: nowrap;">${match.match_date ? new Date(match.match_date).toLocaleDateString('sv-SE') : 'N/A'}</small>
                                        <span class="badge ${match.match_type === 'Singles' ? 'bg-primary' : 'bg-secondary'} badge-sm">${parseMatchPosition(match.match_name) || (match.match_type === 'Singles' ? 'S' : 'D')}</span>
                                    </div>
                                    ${(match.match_type === 'Doubles' || (match.match_name && match.match_name.includes(' AD'))) && match.teammate ?
                                        `<div><small><strong>Med:</strong> ${match.teammate}</small></div>` :
                                        ''
                                    }
                                    <div><strong>Ni m√∂tte:</strong> ${match.opponent || match.team1_name + ' vs ' + match.team2_name} <small class="text-muted">(${match.opponent_team || match.match_type})</small></div>
                                    <div><small class="text-muted" style="font-size: 0.8em;">(${match.player_team}${match.season ? ', ' + match.season : ''}${match.division && match.division !== 'Unknown' ? ', ' + match.division : ''})</small></div>
                                    <div>
                                        <span class="fw-bold">${match.team1_legs} - ${match.team2_legs}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div>
                                ${match.won ? 
                                    '<span class="badge bg-success">Vinst</span>' : 
                                    '<span class="badge bg-danger">F√∂rlust</span>'
                                }
                            </div>
                            <div><small class="text-muted">Snitt: ${match.player_avg ? match.player_avg.toFixed(2) : 'N/A'}</small></div>
                            ${match.sub_match_id ? '<div><small class="text-primary">üéØ Visa match</small></div>' : ''}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
}


// Team search functionality
document.getElementById('teamSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();

    // Show/hide clear button
    document.getElementById('clearTeamBtn').style.display = query.length > 0 ? '' : 'none';

    // Hide search results list when typing
    document.getElementById('teamSearchResultsList').style.display = 'none';

    if (query.length < 2) {
        document.getElementById('teamSearchSuggestions').style.display = 'none';
        return;
    }
    
    const suggestions = allTeams.filter(team =>
        team.toLowerCase().includes(query)
    ).sort((a, b) => {
        // Extract season from team name (e.g., "Team (DIV) (2025-2026)" -> "2025-2026")
        const seasonRegex = /\((\d{4}-\d{4})\)$/;
        const seasonA = a.match(seasonRegex)?.[1] || '';
        const seasonB = b.match(seasonRegex)?.[1] || '';

        // Sort by season descending (newest first), then alphabetically by team name
        if (seasonA !== seasonB) {
            return seasonB.localeCompare(seasonA);
        }
        return a.localeCompare(b);
    }).slice(0, 10);
    
    const suggestionsContainer = document.getElementById('teamSearchSuggestions');
    if (suggestions.length > 0) {
        suggestionsContainer.innerHTML = suggestions.map(team => 
            `<button type="button" class="list-group-item list-group-item-action" onclick="selectTeam('${team}')">${team}</button>`
        ).join('');
        suggestionsContainer.style.display = 'block';
    } else {
        suggestionsContainer.style.display = 'none';
    }
});

// Team search by text
function searchTeamByText() {
    const query = document.getElementById('teamSearch').value.trim().toLowerCase();
    if (query.length < 2) {
        alert('Skriv minst 2 tecken f√∂r att s√∂ka');
        return;
    }
    
    // Hide autocomplete suggestions
    document.getElementById('teamSearchSuggestions').style.display = 'none';
    
    // Find all matching teams
    const matchingTeams = allTeams.filter(team => 
        team.toLowerCase().includes(query)
    );
    
    if (matchingTeams.length === 0) {
        alert('Inga lag hittades som matchar din s√∂kning');
        return;
    }
    
    if (matchingTeams.length === 1) {
        // Only one match, select it directly
        selectTeam(matchingTeams[0]);
        return;
    }
    
    // Multiple matches, show list
    const resultsContainer = document.getElementById('teamSearchResultsContent');
    resultsContainer.innerHTML = matchingTeams.map(team => 
        `<button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="selectTeam('${team}')">
            <span>${team}</span>
            <small class="text-success">Visa uppst√§llning ‚Üí</small>
        </button>`
    ).join('');
    
    document.getElementById('teamSearchResultsList').style.display = 'block';
    
    // Scroll to results
    document.getElementById('teamSearchResultsList').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

function selectTeam(teamName) {
    document.getElementById('teamSearch').value = teamName;
    document.getElementById('teamSearchSuggestions').style.display = 'none';
    document.getElementById('teamSearchResultsList').style.display = 'none';
    searchTeam();
}

async function searchTeam() {
    const teamName = document.getElementById('teamSearch').value.trim();
    if (!teamName) return;

    // Reset club players tab state for new search
    clubPlayersLoaded = false;
    clubPlayersAllTime = false;
    doublesPairsLoaded = false;

    // Update URL with team parameter (only if not navigating via history)
    if (!isNavigatingHistory) {
        const url = new URL(window.location);
        url.searchParams.set('tab', 'teams');
        url.searchParams.set('team', teamName);
        url.searchParams.delete('player');
        window.history.pushState({ tab: 'teams', team: teamName }, '', url);
    }

    try {
        // Build query parameters with filters
        const params = new URLSearchParams();
        if (currentFilters.season) params.append('season', currentFilters.season);

        const queryString = params.toString();

        // Fetch both players and lineup data
        const [playersResponse, lineupResponse] = await Promise.all([
            fetch(`/api/team/${encodeURIComponent(teamName)}/players${queryString ? '?' + queryString : ''}`),
            fetch(`/api/team/${encodeURIComponent(teamName)}/lineup${queryString ? '?' + queryString : ''}`)
        ]);

        const playersData = await playersResponse.json();
        const lineupData = await lineupResponse.json();

        if (playersResponse.ok && lineupResponse.ok) {
            showTeamData(playersData, lineupData);
        } else {
            alert(`Lag hittades inte: ${playersData.error || lineupData.error}`);
        }
    } catch (error) {
        console.error('S√∂kning misslyckades:', error);
        alert('S√∂kfel');
    }
}

function showTeamData(playersData, lineupData) {
    // Show the team results section in teams tab
    document.getElementById('teamResultsSectionTab').style.display = 'block';

    // Get division from API response, or extract from team name as fallback
    const divMatch = playersData.team_name.match(/\(([^)]+)\)$/);
    const division = playersData.division || (divMatch ? divMatch[1] : '');
    const baseClubName = playersData.team_name.replace(/\s*\([^)]*\)$/, '').trim();

    document.getElementById('teamResultsTitleTab').textContent = baseClubName;

    // Store team name, season and division for other tabs
    window.currentTeamName = playersData.team_name;
    window.currentTeamSeason = playersData.season;
    window.currentTeamDivision = playersData.division;

    document.getElementById('teamResultsBodyTab').innerHTML = `
        <!-- Nav tabs for switching between views -->
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="players-list-tab" data-bs-toggle="tab" data-bs-target="#players-list" type="button">
                    üìã Spelare i ${division}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="club-players-tab" data-bs-toggle="tab" data-bs-target="#club-players" type="button" onclick="loadClubPlayers(); trackSubTab('alla-i-klubben')">
                    üè† Alla i klubben
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="doubles-pairs-tab" data-bs-toggle="tab" data-bs-target="#doubles-pairs" type="button" onclick="loadDoublesPairs(); trackSubTab('dubbelpar')">
                    üë• Dubbelpar
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="lineup-tab" data-bs-toggle="tab" data-bs-target="#lineup" type="button" onclick="trackSubTab('trolig-uppstallning')">
                    üéØ Trolig uppst√§llning
                </button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content">
            <!-- Players list tab -->
            <div class="tab-pane fade show active" id="players-list" role="tabpanel">
                <div class="text-center mb-4">
                    <h6 class="text-muted">
                        ${playersData.player_count} spelare har spelat i ${playersData.total_matches} matcher
                        ${playersData.season ? ` under ${playersData.season}` : ''}
                        ${!playersData.season ? ' fr√•n alla s√§songer' : ''}
                    </h6>
                </div>

                <div class="player-cards-sort-bar" id="teamPlayersSortBar">
                    <span class="sort-label">Sortera:</span>
                    <button class="sort-btn active" onclick="sortTeamPlayerCards('name')">Namn <span class="sort-arrow">‚Üï</span></button>
                    <button class="sort-btn" onclick="sortTeamPlayerCards('average')">Snitt <span class="sort-arrow">‚Üï</span></button>
                    <button class="sort-btn" onclick="sortTeamPlayerCards('singles_win_pct')">S-vinst <span class="sort-arrow">‚Üï</span></button>
                    <button class="sort-btn" onclick="sortTeamPlayerCards('doubles_win_pct')">D-vinst <span class="sort-arrow">‚Üï</span></button>
                </div>
                <div class="player-cards-container" id="teamPlayersCards">
                    ${playersData.players.map(player => `
                        <div class="player-card" data-name="${player.name}" data-average="${player.average || 0}" data-singles-win-pct="${player.singles_win_pct}" data-doubles-win-pct="${player.doubles_win_pct}">
                            <div class="player-card-header">
                                <span class="player-card-name">${goldenStat.makePlayerNameClickable(player.name)}</span>
                                <span class="player-card-avg ${player.average >= 20 ? 'avg-high' : player.average >= 15 ? 'avg-mid' : 'avg-low'}">${player.average ? player.average.toFixed(1) : '-'}</span>
                            </div>
                            <div class="player-card-stats">
                                <div class="player-card-stat">
                                    <span class="stat-label">Singlar:</span>
                                    <span class="stat-value">${player.singles_played}</span>
                                    <span class="stat-pct ${player.singles_win_pct >= 50 ? 'pct-good' : 'pct-bad'}">${player.singles_played > 0 ? '(' + player.singles_win_pct + '%)' : ''}</span>
                                </div>
                                <div class="player-card-stat">
                                    <span class="stat-label">Dubblar:</span>
                                    <span class="stat-value">${player.doubles_played}</span>
                                    <span class="stat-pct ${player.doubles_win_pct >= 50 ? 'pct-good' : 'pct-bad'}">${player.doubles_played > 0 ? '(' + player.doubles_win_pct + '%)' : ''}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Club players tab -->
            <div class="tab-pane fade" id="club-players" role="tabpanel">
                <div class="text-center py-4" id="clubPlayersLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laddar...</span>
                    </div>
                    <p class="text-muted mt-2">Laddar spelare fr√•n alla divisioner...</p>
                </div>
                <div id="clubPlayersContent" style="display: none;"></div>
            </div>

            <!-- Doubles pairs tab -->
            <div class="tab-pane fade" id="doubles-pairs" role="tabpanel">
                <div class="text-center py-4" id="doublesPairsLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laddar...</span>
                    </div>
                    <p class="text-muted mt-2">Laddar dubbelpar-statistik...</p>
                </div>
                <div id="doublesPairsContent" style="display: none;"></div>
            </div>

            <!-- Lineup tab -->
            <div class="tab-pane fade" id="lineup" role="tabpanel">
                ${generateLineupHTML(lineupData)}
            </div>
        </div>
    `;

    // Scroll to results
    document.getElementById('teamResultsSectionTab').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
    });
}

function generateLineupHTML(data) {
    return `
        <div class="text-center mb-4">
            <h6 class="text-muted">Baserat p√• ${data.total_matches} matcher${data.season ? ` i ${data.season}` : ''}${data.division ? ` (${data.division})` : ''}${!data.season && !data.division ? ' fr√•n alla s√§songer' : ''}</h6>
        </div>

        <!-- Doubles positions -->
        <div class="mb-4">
            <h6 class="text-muted mb-3">üë• Dubblar</h6>
            <div class="row g-3">
                ${['D1', 'D2', 'D3'].map(position => {
                    const posData = data.positions[position];
                    return posData ? `
                        <div class="col-md-4">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">${position}</h6>
                                    <div class="mb-2">
                                        ${posData.players.map(p =>
                                            `<div><strong>${goldenStat.makePlayerNameClickable(p.name)}</strong></div>
                                             <small class="text-muted">${p.percentage}% (${p.matches} matcher)</small>`
                                        ).join('<hr class="my-2">')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="col-md-4">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-muted">${position}</h6>
                                    <small class="text-muted">Ingen data</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>

        <!-- Singles positions -->
        <div class="mb-4">
            <h6 class="text-muted mb-3">üéØ Singlar</h6>
            <div class="row g-3">
                ${['S1', 'S2', 'S3', 'S4', 'S5', 'S6'].map(position => {
                    const posData = data.positions[position];
                    return posData ? `
                        <div class="col-6 col-sm-4 col-md-4 col-lg-2">
                            <div class="card text-center h-100">
                                <div class="card-body py-2">
                                    <h6 class="card-title text-success">${position}</h6>
                                    <div>
                                        <strong>${goldenStat.makePlayerNameClickable(posData.top_player.name)}</strong>
                                    </div>
                                    <small class="text-muted">${posData.top_player.percentage}%</small>
                                    <div><small class="text-muted">${posData.top_player.matches} matcher</small></div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="col-6 col-sm-4 col-md-4 col-lg-2">
                            <div class="card text-center h-100">
                                <div class="card-body py-2">
                                    <h6 class="card-title text-muted">${position}</h6>
                                    <small class="text-muted">Ingen data</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>

        <!-- AD position if exists -->
        ${data.positions['AD'] ? `
            <div class="mb-4">
                <h6 class="text-muted mb-3">‚ö° Avg√∂rande dubbel (AD)</h6>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-title text-warning">AD</h6>
                                <div class="mb-2">
                                    ${data.positions['AD'].players.map(p =>
                                        `<div><strong>${goldenStat.makePlayerNameClickable(p.name)}</strong></div>
                                         <small class="text-muted">${p.percentage}% (${p.matches} matcher)</small>`
                                    ).join('<hr class="my-2">')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
    `;
}

function showTeamPlayers(data) {
    // Legacy function - keeping for compatibility
    showTeamData(data, {positions: {}, total_matches: 0});
}

let clubPlayersLoaded = false;
let clubPlayersAllTime = false;

async function loadClubPlayers(forceReload = false) {
    // Only load once per team search (unless forcing reload for toggle)
    if (clubPlayersLoaded && !forceReload) return;

    const teamName = window.currentTeamName;
    if (!teamName) return;

    // Show loading state when reloading
    if (forceReload) {
        document.getElementById('clubPlayersLoading').style.display = 'block';
        document.getElementById('clubPlayersContent').style.display = 'none';
    }

    try {
        const params = new URLSearchParams();
        // Only add season if not showing all-time
        if (!clubPlayersAllTime && currentFilters.season) {
            params.append('season', currentFilters.season);
        }
        const queryString = params.toString();

        const response = await fetch(`/api/club/${encodeURIComponent(teamName)}/players${queryString ? '?' + queryString : ''}`);
        const data = await response.json();

        if (response.ok) {
            document.getElementById('clubPlayersLoading').style.display = 'none';
            document.getElementById('clubPlayersContent').style.display = 'block';
            document.getElementById('clubPlayersContent').innerHTML = generateClubPlayersHTML(data);
            clubPlayersLoaded = true;
        } else {
            document.getElementById('clubPlayersLoading').innerHTML = `
                <p class="text-danger">Kunde inte ladda klubbdata: ${data.error}</p>
            `;
        }
    } catch (error) {
        console.error('Kunde inte ladda klubbspelare:', error);
        document.getElementById('clubPlayersLoading').innerHTML = `
            <p class="text-danger">Ett fel uppstod vid laddning</p>
        `;
    }
}

function toggleClubPlayersAllTime() {
    clubPlayersAllTime = !clubPlayersAllTime;
    clubPlayersLoaded = false;
    loadClubPlayers(true);
}

let doublesPairsLoaded = false;

async function loadDoublesPairs(forceReload = false) {
    if (doublesPairsLoaded && !forceReload) return;

    const teamName = window.currentTeamName;
    if (!teamName) return;

    try {
        const params = new URLSearchParams();
        // Use season from team search, not global filter
        const season = window.currentTeamSeason || currentFilters.season;
        if (season) {
            params.append('season', season);
        }
        // Add division filter if available
        if (window.currentTeamDivision) {
            params.append('division', window.currentTeamDivision);
        }
        const queryString = params.toString();

        const response = await fetch(`/api/team/${encodeURIComponent(teamName)}/doubles-pairs${queryString ? '?' + queryString : ''}`);
        const data = await response.json();

        if (response.ok) {
            document.getElementById('doublesPairsLoading').style.display = 'none';
            document.getElementById('doublesPairsContent').style.display = 'block';
            document.getElementById('doublesPairsContent').innerHTML = generateDoublesPairsHTML(data);
            doublesPairsLoaded = true;
        } else {
            document.getElementById('doublesPairsLoading').innerHTML = `
                <p class="text-danger">Kunde inte ladda dubbelpar: ${data.error}</p>
            `;
        }
    } catch (error) {
        console.error('Kunde inte ladda dubbelpar:', error);
        document.getElementById('doublesPairsLoading').innerHTML = `
            <p class="text-danger">Ett fel uppstod vid laddning</p>
        `;
    }
}

function generateDoublesPairsHTML(data) {
    return `
        <div class="text-center mb-4">
            <h6 class="text-muted">
                ${data.total_doubles_matches} dubbelmatcher f√∂r ${data.team_name}
                ${data.season ? ` under ${data.season}` : ''}
            </h6>
        </div>

        <div class="doubles-pairs-container">
            ${data.players.map(player => `
                <div class="doubles-player-card mb-3">
                    <div class="doubles-player-header">
                        <div class="doubles-player-info">
                            <span class="doubles-player-name">${goldenStat.makePlayerNameClickable(player.player)}</span>
                            <span class="doubles-player-positions">(${Object.entries(player.positions || {}).sort((a, b) => {
                                    // Sort D1, D2, D3 first, then D, then AD last
                                    const order = {'D1': 1, 'D2': 2, 'D3': 3, 'D': 4, 'AD': 5};
                                    return (order[a[0]] || 99) - (order[b[0]] || 99);
                                }).map(([pos, count]) => `${pos}: ${count}`).join(', ')})</span>
                        </div>
                        <span class="badge bg-secondary">${player.total_doubles} ${player.total_doubles === 1 ? 'dubbel' : 'dubblar'}</span>
                    </div>
                    <div class="doubles-partners-list">
                        ${player.partners.map(partner => `
                            <div class="doubles-partner-row">
                                <div class="partner-info">
                                    <span class="partner-name">${goldenStat.makePlayerNameClickable(partner.partner)}</span>
                                    <span class="partner-positions">
                                        ${Object.entries(partner.positions).sort((a, b) => {
                                            const order = {'D1': 1, 'D2': 2, 'D3': 3, 'D': 4, 'AD': 5};
                                            return (order[a[0]] || 99) - (order[b[0]] || 99);
                                        }).map(([pos, count]) =>
                                            `<span class="position-badge">${pos}: ${count}</span>`
                                        ).join(' ')}
                                    </span>
                                </div>
                                <div class="partner-stats">
                                    <span class="partner-matches">${partner.total} matcher</span>
                                    <span class="partner-winrate ${partner.win_pct >= 50 ? 'text-success' : 'text-danger'}">
                                        ${partner.wins} ${partner.wins === 1 ? 'vinst' : 'vinster'}, ${partner.total - partner.wins} ${(partner.total - partner.wins) === 1 ? 'f√∂rlust' : 'f√∂rluster'} (${partner.win_pct}%)
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function generateClubPlayersHTML(data) {
    const currentSeasonLabel = currentFilters.season || 'Nuvarande s√§song';
    return `
        <div class="text-center mb-4">
            <div class="mb-2">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn ${!clubPlayersAllTime ? 'btn-primary' : 'btn-outline-primary'}" onclick="if(clubPlayersAllTime) toggleClubPlayersAllTime()">
                        ${currentSeasonLabel}
                    </button>
                    <button type="button" class="btn ${clubPlayersAllTime ? 'btn-primary' : 'btn-outline-primary'}" onclick="if(!clubPlayersAllTime) toggleClubPlayersAllTime()">
                        Alla s√§songer
                    </button>
                </div>
            </div>
            <h6 class="text-muted">
                ${data.player_count} spelare har spelat i ${data.total_matches} matcher f√∂r ${data.club_name}
                ${data.season ? ` under ${data.season}` : ' fr√•n alla s√§songer'}
            </h6>
            <small class="text-muted">Divisioner: ${(() => {
                const divs = data.teams.map(t => { const m = t.match(/\(([^)]+)\)$/); return m ? m[1] : null; }).filter(d => d);
                const priority = ['Superligan', 'SL6', 'SL4'];
                const priorityDivs = priority.filter(p => divs.includes(p));
                const otherDivs = divs.filter(d => !priority.includes(d)).sort();
                return [...priorityDivs, ...otherDivs].join(', ');
            })()}</small>
        </div>

        <div class="player-cards-sort-bar" id="clubPlayersSortBar">
            <span class="sort-label">Sortera:</span>
            <button class="sort-btn active" onclick="sortClubPlayerCards('name')">Namn <span class="sort-arrow">‚Üï</span></button>
            <button class="sort-btn" onclick="sortClubPlayerCards('average')">Snitt <span class="sort-arrow">‚Üï</span></button>
            <button class="sort-btn" onclick="sortClubPlayerCards('singles_win_pct')">S-vinst <span class="sort-arrow">‚Üï</span></button>
            <button class="sort-btn" onclick="sortClubPlayerCards('doubles_win_pct')">D-vinst <span class="sort-arrow">‚Üï</span></button>
        </div>
        <div class="player-cards-container" id="clubPlayersCards">
            ${data.players.map(player => `
                <div class="player-card" data-name="${player.name}" data-average="${player.average || 0}" data-singles-win-pct="${player.singles_win_pct}" data-doubles-win-pct="${player.doubles_win_pct}">
                    <div class="player-card-header">
                        <span class="player-card-name">${goldenStat.makePlayerNameClickable(player.name)}</span>
                        <span class="player-card-avg ${player.average >= 20 ? 'avg-high' : player.average >= 15 ? 'avg-mid' : 'avg-low'}">${player.average ? player.average.toFixed(1) : '-'}</span>
                    </div>
                    <div class="player-card-stats">
                        <div class="player-card-stat">
                            <span class="stat-label">Singlar:</span>
                            <span class="stat-value">${player.singles_played}</span>
                            <span class="stat-pct ${player.singles_win_pct >= 50 ? 'pct-good' : 'pct-bad'}">${player.singles_played > 0 ? '(' + player.singles_win_pct + '%)' : ''}</span>
                        </div>
                        <div class="player-card-stat">
                            <span class="stat-label">Dubblar:</span>
                            <span class="stat-value">${player.doubles_played}</span>
                            <span class="stat-pct ${player.doubles_win_pct >= 50 ? 'pct-good' : 'pct-bad'}">${player.doubles_played > 0 ? '(' + player.doubles_win_pct + '%)' : ''}</span>
                        </div>
                    </div>
                    ${player.divisions_played ? `<div class="player-card-teams"><small class="text-muted">${player.divisions_played}</small></div>` : ''}
                </div>
            `).join('')}
        </div>
    `;
}

let clubPlayersSortState = { field: 'name', direction: 'asc' };

function sortClubPlayerCards(field) {
    const container = document.getElementById('clubPlayersCards');
    if (!container) return;

    const cards = Array.from(container.querySelectorAll('.player-card'));

    // Toggle direction if same field
    if (clubPlayersSortState.field === field) {
        clubPlayersSortState.direction = clubPlayersSortState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        clubPlayersSortState.field = field;
        clubPlayersSortState.direction = field === 'name' ? 'asc' : 'desc';
    }

    cards.sort((a, b) => {
        let aVal, bVal;
        if (field === 'name') {
            aVal = a.dataset.name.toLowerCase();
            bVal = b.dataset.name.toLowerCase();
        } else {
            aVal = parseFloat(a.dataset[field.replace(/_([a-z])/g, (m, c) => c.toUpperCase())]) || 0;
            bVal = parseFloat(b.dataset[field.replace(/_([a-z])/g, (m, c) => c.toUpperCase())]) || 0;
        }

        if (clubPlayersSortState.direction === 'asc') {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
        } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
        }
    });

    container.innerHTML = '';
    cards.forEach(card => container.appendChild(card));

    // Update button states
    document.querySelectorAll('#clubPlayersSortBar .sort-btn').forEach(btn => {
        btn.classList.remove('active');
        const arrow = btn.querySelector('.sort-arrow');
        if (arrow) arrow.textContent = '‚Üï';
    });

    const activeBtn = document.querySelector(`#clubPlayersSortBar .sort-btn[onclick*="${field}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        const arrow = activeBtn.querySelector('.sort-arrow');
        if (arrow) arrow.textContent = clubPlayersSortState.direction === 'asc' ? '‚Üë' : '‚Üì';
    }
}

function showTeamLineup(data) {
    // Show the team results section in teams tab
    document.getElementById('teamResultsSectionTab').style.display = 'block';
    document.getElementById('teamResultsTitleTab').textContent = `${data.team_name} - Trolig uppst√§llning`;

    document.getElementById('teamResultsBodyTab').innerHTML = `
        <div class="text-center mb-4">
            <h6 class="text-muted">Baserat p√• ${data.total_matches} matcher${data.season ? ` i ${data.season}` : ''}${data.division ? ` (${data.division})` : ''}${!data.season && !data.division ? ' fr√•n alla s√§songer' : ''}</h6>
        </div>
        
        <!-- Doubles positions -->
        <div class="mb-4">
            <h6 class="text-muted mb-3">üë• Dubblar</h6>
            <div class="row g-3">
                ${['D1', 'D2', 'D3'].map(position => {
                    const posData = data.positions[position];
                    return posData ? `
                        <div class="col-12 col-sm-6 col-md-4">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">${position}</h6>
                                    <div class="mb-2">
                                        ${posData.players.map(p =>
                                            `<div><strong>${goldenStat.makePlayerNameClickable(p.name)}</strong></div>
                                             <small class="text-muted">${p.percentage}% (${p.matches} matcher)</small>`
                                        ).join('<hr class="my-2">')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="col-12 col-sm-6 col-md-4">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-muted">${position}</h6>
                                    <small class="text-muted">Ingen data</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <!-- Singles positions -->
        <div class="mb-4">
            <h6 class="text-muted mb-3">üéØ Singlar</h6>
            <div class="row g-3">
                ${['S1', 'S2', 'S3', 'S4', 'S5', 'S6'].map(position => {
                    const posData = data.positions[position];
                    return posData ? `
                        <div class="col-6 col-sm-4 col-md-4 col-lg-2">
                            <div class="card text-center h-100">
                                <div class="card-body py-2">
                                    <h6 class="card-title text-success">${position}</h6>
                                    <div>
                                        <strong>${goldenStat.makePlayerNameClickable(posData.top_player.name)}</strong>
                                    </div>
                                    <small class="text-muted">${posData.top_player.percentage}%</small>
                                    <div><small class="text-muted">${posData.top_player.matches} matcher</small></div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="col-6 col-sm-4 col-md-4 col-lg-2">
                            <div class="card text-center h-100">
                                <div class="card-body py-2">
                                    <h6 class="card-title text-muted">${position}</h6>
                                    <small class="text-muted">Ingen data</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <!-- AD position if exists -->
        ${data.positions['AD'] ? `
            <div class="mb-4">
                <h6 class="text-muted mb-3">‚ö° Avg√∂rande dubbel (AD)</h6>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-title text-warning">AD</h6>
                                <div class="mb-2">
                                    ${data.positions['AD'].players.map(p => 
                                        `<div><strong>${goldenStat.makePlayerNameClickable(p.name)}</strong></div>
                                         <small class="text-muted">${p.percentage}% (${p.matches} matcher)</small>`
                                    ).join('<hr class="my-2">')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
    `;

    // Scroll to results
    document.getElementById('teamResultsSectionTab').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
    });
}

// Team enter key handling
document.getElementById('teamSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('teamSearchSuggestions').style.display = 'none';
        
        // Check if there are visible suggestions, select first one
        const suggestions = document.querySelectorAll('#teamSearchSuggestions .list-group-item');
        if (suggestions.length > 0 && document.getElementById('teamSearchSuggestions').style.display !== 'none') {
            const firstSuggestion = suggestions[0].textContent;
            selectTeam(firstSuggestion);
        } else {
            // No suggestions visible, do text search
            searchTeamByText();
        }
    }
});

// Funktion f√∂r att rensa lagresultat
function clearTeamResults() {
    document.getElementById('teamResultsSectionTab').style.display = 'none';
    document.getElementById('teamResultsBodyTab').innerHTML = '';
    document.getElementById('teamSearchResultsList').style.display = 'none';
    document.getElementById('teamSearch').value = '';
}

let teamPlayersTableSortOrder = {};

function sortTeamPlayerCards(field) {
    const container = document.getElementById('teamPlayersCards');
    const cards = Array.from(container.querySelectorAll('.player-card'));
    const sortBar = document.getElementById('teamPlayersSortBar');
    const buttons = sortBar.querySelectorAll('.sort-btn');

    // Find active button and toggle direction
    let activeBtn = null;
    buttons.forEach(btn => {
        if (btn.textContent.trim().startsWith(field === 'name' ? 'Namn' : field === 'average' ? 'Snitt' : field === 'singles_win_pct' ? 'S-vinst' : 'D-vinst')) {
            activeBtn = btn;
        }
    });

    // Toggle sort order
    if (!teamPlayersTableSortOrder[field]) {
        teamPlayersTableSortOrder[field] = field === 'name' ? 'asc' : 'desc';
    } else if (teamPlayersTableSortOrder[field] === 'asc') {
        teamPlayersTableSortOrder[field] = 'desc';
    } else {
        teamPlayersTableSortOrder[field] = 'asc';
    }

    const isAscending = teamPlayersTableSortOrder[field] === 'asc';

    cards.sort((a, b) => {
        if (field === 'name') {
            const aVal = a.getAttribute('data-name');
            const bVal = b.getAttribute('data-name');
            return isAscending ? aVal.localeCompare(bVal, 'sv') : bVal.localeCompare(aVal, 'sv');
        } else {
            const attr = field === 'average' ? 'data-average' : field === 'singles_win_pct' ? 'data-singles-win-pct' : 'data-doubles-win-pct';
            const aVal = parseFloat(a.getAttribute(attr)) || 0;
            const bVal = parseFloat(b.getAttribute(attr)) || 0;
            return isAscending ? aVal - bVal : bVal - aVal;
        }
    });

    // Re-append sorted cards
    cards.forEach(card => container.appendChild(card));

    // Update button states and arrows
    buttons.forEach(btn => {
        btn.classList.remove('active');
        btn.querySelector('.sort-arrow').textContent = '‚Üï';
    });
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.querySelector('.sort-arrow').textContent = isAscending ? '‚Üë' : '‚Üì';
    }
}

// Funktion f√∂r att rensa spelarresultat
function clearPlayerResults() {
    document.getElementById('playerResultsSection').style.display = 'none';
    document.getElementById('playerResultsBody').innerHTML = '';
    document.getElementById('searchResultsList').style.display = 'none';
    document.getElementById('playerSearch').value = '';
    originalMatchesData = []; // Clear stored data
}

// Load top stats
let statsLoaded = false;
let seasonStatsLoaded = false;
let currentStatsView = 'season'; // Track current view: 'all' or 'season' - default to season
let cachedAllSeasonsData = null;
let cachedCurrentSeasonData = null;

function switchToAllSeasons() {
    if (currentStatsView === 'all') return; // Already showing all seasons

    // Update button states
    document.getElementById('allSeasonsBtn').classList.add('active');
    document.getElementById('currentSeasonBtn').classList.remove('active');

    // Update description
    document.getElementById('statsDescription').textContent = 'De mest imponerande prestationerna i alla inl√§sta s√§songer';

    currentStatsView = 'all';

    // If we have cached data, use it immediately
    if (cachedAllSeasonsData) {
        populateStatsWithData(cachedAllSeasonsData);
        document.getElementById('statsLoading').style.display = 'none';
        document.getElementById('statsContent').style.display = 'block';
    } else {
        // Show loading and fetch data
        document.getElementById('statsLoading').style.display = 'block';
        document.getElementById('statsContent').style.display = 'none';
        loadTopStats();
    }
}

function switchToCurrentSeason() {
    if (currentStatsView === 'season') return; // Already showing current season

    // Update button states
    document.getElementById('allSeasonsBtn').classList.remove('active');
    document.getElementById('currentSeasonBtn').classList.add('active');

    // Update description
    document.getElementById('statsDescription').textContent = 'De mest imponerande prestationerna under s√§songen 2025/2026';

    currentStatsView = 'season';

    // If we have cached data, use it immediately
    if (cachedCurrentSeasonData) {
        populateStatsWithData(cachedCurrentSeasonData);
        document.getElementById('statsLoading').style.display = 'none';
        document.getElementById('statsContent').style.display = 'block';
    } else {
        // Show loading and fetch data
        document.getElementById('statsLoading').style.display = 'block';
        document.getElementById('statsContent').style.display = 'none';
        loadCurrentSeasonStats();
    }
}

function populateStatsWithData(data) {
    // Populate top averages
    document.getElementById('topAverages').innerHTML = data.top_averages.map((item, index) => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-primary rounded-pill me-2">${index + 1}</span>
                    <strong>${item.player_name}</strong>
                    <br>
                    <small class="text-muted">${item.team_name} vs ${item.opponent_name} - ${item.match_date}</small>
                    <br>
                    <a href="/sub_match_throws?sub_match_id=${item.sub_match_id}&team=${item.team_number}${LEAGUE_PARAM ? '&' + LEAGUE_PARAM : ''}" class="small text-primary">Visa match ‚Üí</a>
                </div>
                <span class="badge bg-primary rounded-pill fs-5">${item.average.toFixed(2)}</span>
            </div>
        `).join('');

        // Populate top checkouts
        document.getElementById('topCheckouts').innerHTML = data.top_checkouts.map((item, index) => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-success rounded-pill me-2">${index + 1}</span>
                    <strong>${item.player_name}</strong>
                    <br>
                    <small class="text-muted">${item.team_name} vs ${item.opponent_name} - ${item.match_date}</small>
                    <br>
                    <a href="/sub_match_throws?sub_match_id=${item.sub_match_id}&team=${item.team_number}${LEAGUE_PARAM ? '&' + LEAGUE_PARAM : ''}" class="small text-primary">Visa match ‚Üí</a>
                </div>
                <span class="badge bg-success rounded-pill fs-5">${item.checkout}</span>
            </div>
        `).join('');

        // Populate shortest sets
        document.getElementById('topShortestSets').innerHTML = data.shortest_sets.map((item, index) => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-warning text-dark rounded-pill me-2">${index + 1}</span>
                    <strong>${item.player_name}</strong>
                    <br>
                    <small class="text-muted">${item.team_name} vs ${item.opponent_name} - ${item.match_date}</small>
                    <br>
                    <a href="/sub_match_throws?sub_match_id=${item.sub_match_id}&team=${item.team_number}${LEAGUE_PARAM ? '&' + LEAGUE_PARAM : ''}" class="small text-primary">Visa match ‚Üí</a>
                </div>
                <span class="badge bg-warning text-dark rounded-pill fs-5">${item.darts} pilar</span>
            </div>
        `).join('');

    // Populate most 180s
    document.getElementById('topMost180s').innerHTML = data.most_180s.map((item, index) => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <span class="badge bg-info rounded-pill me-2">${index + 1}</span>
                <strong>${item.player_name}</strong>
                <br>
                <small class="text-muted">${item.team_name} vs ${item.opponent_name} - ${item.match_date}</small>
                <br>
                <a href="/sub_match_throws?sub_match_id=${item.sub_match_id}&team=${item.team_number}${LEAGUE_PARAM ? '&' + LEAGUE_PARAM : ''}" class="small text-primary">Visa match ‚Üí</a>
            </div>
            <span class="badge bg-info rounded-pill fs-5">${item.count_180} st</span>
        </div>
    `).join('');
}

async function loadCurrentSeasonStats() {
    try {
        const response = await fetch('/api/top-stats?season=2025/2026');
        const data = await response.json();

        // Cache the data
        cachedCurrentSeasonData = data;

        // Hide loading, show content
        document.getElementById('statsLoading').style.display = 'none';
        document.getElementById('statsContent').style.display = 'block';

        // Populate with data
        populateStatsWithData(data);

        seasonStatsLoaded = true;
    } catch (error) {
        console.error('Kunde inte ladda s√§songstatistik:', error);
        document.getElementById('statsLoading').innerHTML = '<p class="text-danger">Kunde inte ladda statistik</p>';
    }
}

async function loadTopStats() {
    if (statsLoaded) return; // Only load once

    try {
        const response = await fetch('/api/top-stats');
        const data = await response.json();

        // Cache the data
        cachedAllSeasonsData = data;

        // Hide loading, show content
        document.getElementById('statsLoading').style.display = 'none';
        document.getElementById('statsContent').style.display = 'block';

        // Populate with data
        populateStatsWithData(data);

        statsLoaded = true;
    } catch (error) {
        console.error('Kunde inte ladda statistik:', error);
        document.getElementById('statsLoading').innerHTML = '<p class="text-danger">Kunde inte ladda statistik</p>';
    }
}

// Load weekly stats
let weeklyStatsLoaded = false;
let currentWeekOffset = 0;
let availableWeeks = [];
const IS_RIKSSERIEN = LEAGUE === 'riksserien';

async function loadWeeklyStats(division = null, weekOffset = null) {
    try {
        // Use provided weekOffset or current global offset
        if (weekOffset !== null) {
            currentWeekOffset = weekOffset;
        }

        // Build query string
        const params = new URLSearchParams();
        if (division) {
            params.append('division', division);
        }

        // Riksserien: use explicit date range from round data
        if (IS_RIKSSERIEN && availableWeeks.length > 0) {
            const currentRound = availableWeeks.find((w, i) => i === currentWeekOffset);
            if (currentRound) {
                params.append('date_start', currentRound.week_start);
                params.append('date_end', currentRound.week_end);
            } else {
                params.append('week_offset', currentWeekOffset);
            }
        } else {
            params.append('week_offset', currentWeekOffset);
        }
        const queryString = params.toString();
        const url = `/api/weekly-stats${queryString ? '?' + queryString : ''}`;

        const response = await fetch(url);
        const data = await response.json();

        // Hide loading, show content
        document.getElementById('weeklyLoading').style.display = 'none';
        document.getElementById('weeklyContent').style.display = 'block';

        // Update date range and match count
        const startDate = new Date(data.week_start);
        const endDate = new Date(data.week_end);
        const formatDate = (d) => d.toLocaleDateString('sv-SE', { month: 'short', day: 'numeric' });
        document.getElementById('weeklyDateRange').textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;

        // Update description based on week/round
        if (IS_RIKSSERIEN) {
            const roundLabel = availableWeeks.length > 0 && availableWeeks[currentWeekOffset]
                ? availableWeeks[currentWeekOffset].label : '';
            document.getElementById('weeklyDescription').textContent =
                currentWeekOffset === 0 ? 'De b√§sta prestationerna senaste omg√•ngen' : 'De b√§sta prestationerna';
        } else {
            const weekDescription = currentWeekOffset === 0 ? 'De b√§sta prestationerna denna vecka' : 'De b√§sta prestationerna';
            document.getElementById('weeklyDescription').textContent = weekDescription;
        }

        const periodText = IS_RIKSSERIEN
            ? (currentWeekOffset === 0 ? 'denna omg√•ng' : 'den omg√•ngen')
            : (currentWeekOffset === 0 ? 'denna vecka' : 'den veckan');
        if (data.total_matches === 0) {
            document.getElementById('weeklyMatchCount').textContent = `Inga matcher spelade ${periodText} √§nnu`;
        } else {
            document.getElementById('weeklyMatchCount').textContent = `${data.total_matches} matcher spelade ${periodText}`;
        }

        // Text for empty states
        const emptyWeekText = IS_RIKSSERIEN
            ? (currentWeekOffset === 0 ? 'denna omg√•ng √§nnu' : 'den omg√•ngen')
            : (currentWeekOffset === 0 ? 'denna vecka √§nnu' : 'den veckan');

        // Populate top averages
        const averagesHtml = data.top_averages.length > 0 ? data.top_averages.map((item, index) => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-primary rounded-pill me-2">${index + 1}</span>
                    <strong>${item.player_name}</strong>
                    <br>
                    <small class="text-muted">${item.team_name} vs ${item.opponent_name}</small>
                    <br>
                    <a href="/sub_match_throws?sub_match_id=${item.sub_match_id}&team=${item.team_number}${LEAGUE_PARAM ? '&' + LEAGUE_PARAM : ''}" class="small text-primary">Visa match ‚Üí</a>
                </div>
                <span class="badge bg-primary rounded-pill fs-5">${item.average.toFixed(2)}</span>
            </div>
        `).join('') : `<div class="text-muted text-center py-3">Inga singelmatcher ${emptyWeekText}</div>`;
        document.getElementById('weeklyTopAverages').innerHTML = averagesHtml;

        // Populate top checkouts
        const checkoutsHtml = data.top_checkouts.length > 0 ? data.top_checkouts.map((item, index) => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-success rounded-pill me-2">${index + 1}</span>
                    <strong>${item.player_name}</strong>
                    <br>
                    <small class="text-muted">${item.team_name} vs ${item.opponent_name}</small>
                    <br>
                    <a href="/sub_match_throws?sub_match_id=${item.sub_match_id}&team=${item.team_number}${LEAGUE_PARAM ? '&' + LEAGUE_PARAM : ''}" class="small text-primary">Visa match ‚Üí</a>
                </div>
                <span class="badge bg-success rounded-pill fs-5">${item.checkout}</span>
            </div>
        `).join('') : `<div class="text-muted text-center py-3">Inga utg√•ngar ${emptyWeekText}</div>`;
        document.getElementById('weeklyTopCheckouts').innerHTML = checkoutsHtml;

        // Populate shortest sets
        const shortestSetsHtml = data.shortest_sets.length > 0 ? data.shortest_sets.map((item, index) => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-warning text-dark rounded-pill me-2">${index + 1}</span>
                    <strong>${item.player_name}</strong>
                    <br>
                    <small class="text-muted">${item.team_name} vs ${item.opponent_name}</small>
                    <br>
                    <a href="/sub_match_throws?sub_match_id=${item.sub_match_id}&team=${item.team_number}${LEAGUE_PARAM ? '&' + LEAGUE_PARAM : ''}" class="small text-primary">Visa match ‚Üí</a>
                </div>
                <span class="badge bg-warning text-dark rounded-pill fs-5">${item.darts} pilar</span>
            </div>
        `).join('') : `<div class="text-muted text-center py-3">Inga korta legs ${emptyWeekText}</div>`;
        document.getElementById('weeklyShortestSets').innerHTML = shortestSetsHtml;

        // Populate most 100+ throws
        const most100plusHtml = data.most_100plus.length > 0 ? data.most_100plus.map((item, index) => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-info rounded-pill me-2">${index + 1}</span>
                    <strong>${item.player_name}</strong>
                    <br>
                    <small class="text-muted">${item.team_name} vs ${item.opponent_name}</small>
                    <br>
                    <a href="/sub_match_throws?sub_match_id=${item.sub_match_id}&team=${item.team_number}${LEAGUE_PARAM ? '&' + LEAGUE_PARAM : ''}" class="small text-primary">Visa match ‚Üí</a>
                </div>
                <span class="badge bg-info rounded-pill fs-5">${item.count_100plus} st</span>
            </div>
        `).join('') : `<div class="text-muted text-center py-3">Inga 100+ kast ${emptyWeekText}</div>`;
        document.getElementById('weeklyMost100plus').innerHTML = most100plusHtml;

        // Load divisions and available weeks on first load
        if (!weeklyStatsLoaded) {
            await loadWeeklyDivisions();
            await loadAvailableWeeks();
            weeklyStatsLoaded = true;

            // For riksserien, reload with correct date range now that rounds are loaded
            if (IS_RIKSSERIEN && availableWeeks.length > 0) {
                currentWeekOffset = 0;
                const division = document.getElementById('weeklyDivisionFilter').value;
                await loadWeeklyStats(division, 0);
                return;
            }
        }

        // Update navigation buttons (must be after availableWeeks is loaded)
        updateWeekNavigation();
    } catch (error) {
        console.error('Kunde inte ladda statistik:', error);
        document.getElementById('weeklyLoading').innerHTML = IS_RIKSSERIEN
            ? '<p class="text-danger">Kunde inte ladda omg√•ngens statistik</p>'
            : '<p class="text-danger">Kunde inte ladda veckans statistik</p>';
    }
}

// Load divisions for weekly filter
async function loadWeeklyDivisions() {
    try {
        const response = await fetch('/api/divisions');
        const divisions = await response.json();

        const select = document.getElementById('weeklyDivisionFilter');
        // Keep the "Alla divisioner" option
        select.innerHTML = '<option value="">Alla divisioner</option>';

        divisions.forEach(division => {
            const option = document.createElement('option');
            option.value = division;
            option.textContent = division;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Kunde inte ladda divisioner:', error);
    }
}

// Load available weeks (or rounds for riksserien) for dropdown
async function loadAvailableWeeks() {
    try {
        const response = await fetch('/api/available-weeks');
        const data = await response.json();
        availableWeeks = data.weeks;

        const select = document.getElementById('weeklyWeekSelector');
        select.innerHTML = '';

        availableWeeks.forEach((week, index) => {
            const option = document.createElement('option');
            option.value = IS_RIKSSERIEN ? index : week.week_offset;
            if (index === 0) {
                option.textContent = IS_RIKSSERIEN
                    ? `${week.label} (${week.match_count} matcher)`
                    : `Denna vecka (${week.match_count} matcher)`;
            } else {
                option.textContent = `${week.label} (${week.match_count} matcher)`;
            }
            select.appendChild(option);
        });

        // For riksserien, use index-based offset (0 = most recent round)
        if (IS_RIKSSERIEN) {
            currentWeekOffset = 0;
        }
        select.value = currentWeekOffset;
    } catch (error) {
        console.error('Kunde inte ladda tillg√§ngliga veckor:', error);
    }
}

// Navigate to previous/next week or round (only entries with data)
function navigateWeek(direction) {
    if (IS_RIKSSERIEN) {
        // Index-based: 0 = most recent, higher = older
        const newIndex = currentWeekOffset - direction;
        if (newIndex < 0 || newIndex >= availableWeeks.length) return;
        currentWeekOffset = newIndex;
    } else {
        // Offset-based for Stockholmsserien
        const currentIndex = availableWeeks.findIndex(w => w.week_offset === currentWeekOffset);
        if (currentIndex === -1) return;
        const newIndex = currentIndex - direction;
        if (newIndex < 0 || newIndex >= availableWeeks.length) return;
        currentWeekOffset = availableWeeks[newIndex].week_offset;
    }

    document.getElementById('weeklyWeekSelector').value = currentWeekOffset;

    // Show loading
    document.getElementById('weeklyLoading').style.display = 'block';
    document.getElementById('weeklyContent').style.display = 'none';

    const division = document.getElementById('weeklyDivisionFilter').value;
    loadWeeklyStats(division, currentWeekOffset);
}

// Select week/round from dropdown
function selectWeek() {
    const select = document.getElementById('weeklyWeekSelector');
    currentWeekOffset = parseInt(select.value, 10);

    // Show loading
    document.getElementById('weeklyLoading').style.display = 'block';
    document.getElementById('weeklyContent').style.display = 'none';

    const division = document.getElementById('weeklyDivisionFilter').value;
    loadWeeklyStats(division, currentWeekOffset);
}

// Update navigation button states
function updateWeekNavigation() {
    const prevBtn = document.getElementById('prevWeekBtn');
    const nextBtn = document.getElementById('nextWeekBtn');

    if (IS_RIKSSERIEN) {
        // Index-based: 0 = most recent, higher = older
        nextBtn.disabled = currentWeekOffset <= 0;
        prevBtn.disabled = currentWeekOffset >= availableWeeks.length - 1;
    } else {
        // Offset-based for Stockholmsserien
        const currentIndex = availableWeeks.findIndex(w => w.week_offset === currentWeekOffset);
        nextBtn.disabled = currentIndex <= 0;
        prevBtn.disabled = currentIndex >= availableWeeks.length - 1;
    }

    // Update selector value
    const selector = document.getElementById('weeklyWeekSelector');
    if (selector) {
        selector.value = currentWeekOffset;
    }
}

// Filter weekly stats by division
function filterWeeklyStats() {
    let division = document.getElementById('weeklyDivisionFilter').value;

    // Map display names back to database values
    if (division === "Mixed (X1)") {
        division = "Mixed";
    } else if (division === "Mixed (X2)") {
        division = "Mixed(";
    } else if (division === "SL6") {
        division = "Superligan";
    }

    // Show loading, hide content
    document.getElementById('weeklyLoading').style.display = 'block';
    document.getElementById('weeklyContent').style.display = 'none';

    // Reload with filter (keep current week offset)
    loadWeeklyStats(division, currentWeekOffset);
}

</script>
{% endblock %}
