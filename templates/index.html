{% extends "base.html" %}

{% block content %}
<!-- Filter Section -->
<div class="row justify-content-center mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="seasonFilter" class="form-label small mb-1">S√§song</label>
                        <select id="seasonFilter" class="form-select form-select-sm">
                            <option value="">Alla s√§songer</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="divisionFilter" class="form-label small mb-1">Liga</label>
                        <select id="divisionFilter" class="form-select form-select-sm">
                            <option value="">Alla ligor</option>
                        </select>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-muted" id="filterInfo">Visar data f√∂r alla s√§songer och ligor</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Section -->
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-lg">
            <div class="card-body p-4">
                <h3 class="card-title text-center mb-4">S√∂k Spelare</h3>
                <div class="input-group input-group-lg">
                    <input type="text" 
                           id="playerSearch" 
                           class="form-control" 
                           placeholder="Skriv spelarens namn..."
                           autocomplete="off">
                    <button class="btn btn-primary" type="button" onclick="searchPlayer()">
                        <i class="bi bi-search">üîç</i> S√∂k
                    </button>
                </div>
                <div id="searchSuggestions" class="list-group mt-2" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Player Results Modal -->
<div class="modal fade" id="playerModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="playerModalTitle">Spelarstatistik</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="playerModalBody">
                <!-- Player stats will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

// Global state
let currentFilters = {
    season: '',
    division: ''
};

// Load player list on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPlayerList();
    loadFilters();
    
    // Setup filter change handlers
    document.getElementById('seasonFilter').addEventListener('change', updateFilters);
    document.getElementById('divisionFilter').addEventListener('change', updateFilters);
    
    // Check for URL parameter for automatic player search
    const urlParams = new URLSearchParams(window.location.search);
    const playerParam = urlParams.get('player');
    if (playerParam) {
        document.getElementById('playerSearch').value = playerParam;
        searchPlayer();
    }
});

async function loadFilters() {
    try {
        const response = await fetch('/api/leagues');
        const data = await response.json();
        
        // Populate season filter
        const seasonSelect = document.getElementById('seasonFilter');
        data.seasons.forEach(season => {
            if (season && season !== 'Unknown') {
                const option = document.createElement('option');
                option.value = season;
                option.textContent = season;
                seasonSelect.appendChild(option);
            }
        });
        
        // Populate division filter  
        const divisionSelect = document.getElementById('divisionFilter');
        data.divisions.forEach(division => {
            if (division && division !== 'Unknown') {
                const option = document.createElement('option');
                option.value = division;
                option.textContent = division;
                divisionSelect.appendChild(option);
            }
        });
        
    } catch (error) {
        console.error('Failed to load filters:', error);
    }
}

function updateFilters() {
    currentFilters.season = document.getElementById('seasonFilter').value;
    currentFilters.division = document.getElementById('divisionFilter').value;
    
    // Update filter info text
    const filterInfo = document.getElementById('filterInfo');
    let infoText = 'Visar data f√∂r ';
    
    if (currentFilters.season && currentFilters.division) {
        infoText += `${currentFilters.season}, ${currentFilters.division}`;
    } else if (currentFilters.season) {
        infoText += `s√§song ${currentFilters.season}, alla ligor`;
    } else if (currentFilters.division) {
        infoText += `alla s√§songer, liga ${currentFilters.division}`;
    } else {
        infoText += 'alla s√§songer och ligor';
    }
    
    filterInfo.textContent = infoText;
    
    // If a player is currently searched, refresh their stats with new filters
    const currentPlayer = document.getElementById('playerSearch').value.trim();
    if (currentPlayer) {
        searchPlayer();
    }
}

let allPlayers = [];

async function loadPlayerList() {
    try {
        const response = await fetch('/api/players');
        allPlayers = await response.json();
    } catch (error) {
        console.error('Failed to load players:', error);
    }
}

// Search functionality
document.getElementById('playerSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    if (query.length < 2) {
        document.getElementById('searchSuggestions').style.display = 'none';
        return;
    }
    
    const suggestions = allPlayers.filter(player => 
        player.toLowerCase().includes(query)
    ).slice(0, 5);
    
    const suggestionsContainer = document.getElementById('searchSuggestions');
    if (suggestions.length > 0) {
        suggestionsContainer.innerHTML = suggestions.map(player => 
            `<button type="button" class="list-group-item list-group-item-action" onclick="selectPlayer('${player}')">${player}</button>`
        ).join('');
        suggestionsContainer.style.display = 'block';
    } else {
        suggestionsContainer.style.display = 'none';
    }
});

function selectPlayer(playerName) {
    document.getElementById('playerSearch').value = playerName;
    document.getElementById('searchSuggestions').style.display = 'none';
    searchPlayer();
}

async function searchPlayer() {
    const playerName = document.getElementById('playerSearch').value.trim();
    if (!playerName) return;
    
    try {
        // Build query parameters with filters
        const params = new URLSearchParams();
        if (currentFilters.season) params.append('season', currentFilters.season);
        if (currentFilters.division) params.append('division', currentFilters.division);
        
        const queryString = params.toString();
        const url = `/api/player/${encodeURIComponent(playerName)}${queryString ? '?' + queryString : ''}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (response.ok) {
            showPlayerStats(data);
        } else {
            alert(`Spelare hittades inte: ${data.error}`);
        }
    } catch (error) {
        console.error('Search failed:', error);
        alert('S√∂kfel');
    }
}

async function showPlayerStats(stats) {
    const modal = new bootstrap.Modal(document.getElementById('playerModal'));
    document.getElementById('playerModalTitle').textContent = `${stats.player_name} - Spelarstatistik`;
    
    const winPercentage = stats.total_matches > 0 ? ((stats.wins / stats.total_matches) * 100).toFixed(1) : 0;
    
    // First show modal with basic stats
    document.getElementById('playerModalBody').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laddar kast-analys...</span>
            </div>
            <p>H√§mtar detaljerad spelanalys...</p>
        </div>
    `;
    
    modal.show();
    
    // Then load throw analysis in background
    const throwData = await goldenStat.fetchThrowAnalysis(stats.player_name, currentFilters);
    
    console.log('Received throwData:', throwData); // Debug
    
    document.getElementById('playerModalBody').innerHTML = `
        <!-- Navigation tabs -->
        <ul class="nav nav-tabs nav-fill" id="playerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active small" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">√ñversikt</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link small" id="matches-tab" data-bs-toggle="tab" data-bs-target="#matches" type="button">Matcher</button>
            </li>
        </ul>
        
        <!-- Tab content -->
        <div class="tab-content mt-3" id="playerTabsContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <!-- Singles Statistics -->
                <div class="mb-3">
                    <h6 class="text-muted mb-2">üéØ Singlar</h6>
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-primary mb-1">${stats.singles.total_matches}</h5>
                                    <small class="card-text">Matcher</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-success mb-1">${stats.singles.wins}</h5>
                                    <small class="card-text">Vinster</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-warning mb-1">${stats.singles.win_percentage.toFixed(1)}%</h5>
                                    <small class="card-text">Vinstprocent</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-info mb-1">${stats.singles.average_score}</h5>
                                    <small class="card-text">Snitt-average</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Doubles Statistics -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">üë• Dubblar</h6>
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-primary mb-1">${stats.doubles.total_matches}</h5>
                                    <small class="card-text">Matcher</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-success mb-1">${stats.doubles.wins}</h5>
                                    <small class="card-text">Vinster</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-warning mb-1">${stats.doubles.win_percentage.toFixed(1)}%</h5>
                                    <small class="card-text">Vinstprocent</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-muted mb-1">-</h5>
                                    <small class="card-text">Snitt-average</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts row -->
                <div class="row g-2">
                    <div class="col-12 col-md-8 mb-2">
                        <div class="card">
                            <div class="card-body">
                                <canvas id="progressChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 mb-2">
                        <div class="card">
                            <div class="card-body">
                                <canvas id="throwDistributionChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${throwData && throwData.statistics && Object.keys(throwData.statistics).length > 0 ? `
                    <!-- Throw statistics row -->
                    <div class="row g-2 mb-3">
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-primary mb-1">${throwData.statistics.total_throws || 0}</h6>
                                    <small class="card-text">Totala kast</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-success mb-1">${throwData.statistics.average_score || 0}</h6>
                                    <small class="card-text">Snitt per kast</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-warning mb-1">${throwData.statistics.throws_over_100 || 0}</h6>
                                    <small class="card-text">100+ kast</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h6 class="text-info mb-1">${throwData.statistics.throws_180 || 0}</h6>
                                    <small class="card-text">180-kast</small>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            </div>
            <!-- Matches Tab -->
            <div class="tab-pane fade" id="matches" role="tabpanel">
                <div class="d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Motst√•nd</th>
                                    <th>Resultat</th>
                                    <th>Average</th>
                                    <th>Resultat</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stats.recent_matches.map(match => `
                                    <tr class="${match.sub_match_id ? 'table-row-clickable' : ''}" ${match.sub_match_id ? 'onclick="window.location.href=\'/sub_match_throws?sub_match_id=' + match.sub_match_id + '&player_name=' + encodeURIComponent(stats.player_name) + '\'" title="Klicka f√∂r att se kastomg√•ngar"' : ''}>
                                        <td><small style="white-space: nowrap;">${match.match_date ? new Date(match.match_date).toLocaleDateString('sv-SE') : 'N/A'}</small></td>
                                        <td><small>${goldenStat.makePlayerNameClickable(match.opponent || match.team1_name + ' vs ' + match.team2_name, (match.match_type === 'Doubles'))} <span class="text-muted">(${match.opponent_team || match.match_type})</span></small></td>
                                        <td><small>${match.team1_legs} - ${match.team2_legs}</small></td>
                                        <td><small>${match.player_avg ? match.player_avg.toFixed(2) : 'N/A'}</small></td>
                                        <td>
                                            ${match.won ? 
                                                `<span class="badge bg-success badge-sm">Vinst</span>` : 
                                                `<span class="badge bg-danger badge-sm">F√∂rlust</span>`
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Mobile view -->
                <div class="d-md-none">
                    ${stats.recent_matches.map(match => `
                        <div class="card mb-2 ${match.sub_match_id ? 'card-clickable' : ''}" ${match.sub_match_id ? 'title="Klicka f√∂r att se kastomg√•ngar"' : ''}>
                            <div class="card-body py-2" ${match.sub_match_id ? 'onclick="window.location.href=\'/sub_match_throws?sub_match_id=' + match.sub_match_id + '&player_name=' + encodeURIComponent(stats.player_name) + '\'"' : ''}>
                                <div class="row">
                                    <div class="col-8">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <small class="text-muted" style="white-space: nowrap;">${match.match_date ? new Date(match.match_date).toLocaleDateString('sv-SE') : 'N/A'}</small>
                                                <div><strong>${goldenStat.makePlayerNameClickable(match.opponent || match.team1_name + ' vs ' + match.team2_name, (match.match_type === 'Doubles'))}</strong> <small class="text-muted">(${match.opponent_team || match.match_type})</small></div>
                                                <div>
                                                    <span class="fw-bold">${match.team1_legs} - ${match.team2_legs}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div>
                                            ${match.won ? 
                                                `<span class="badge bg-success">Vinst</span>` : 
                                                `<span class="badge bg-danger">F√∂rlust</span>`
                                            }
                                        </div>
                                        <div><small class="text-muted">Average: ${match.player_avg ? match.player_avg.toFixed(2) : 'N/A'}</small></div>
                                        ${match.sub_match_id ? '<div><small class="text-primary">üéØ Visa kast</small></div>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Create charts after modal is shown
    setTimeout(() => {
        // Overview charts
        goldenStat.createProgressChart('progressChart', stats.recent_matches);
        
        // Throw distribution chart in overview
        if (throwData && throwData.statistics && throwData.statistics.score_ranges) {
            goldenStat.createThrowDistributionChart('throwDistributionChart', throwData.statistics.score_ranges);
        }
    }, 100);
}

// Handle Enter key in search
document.getElementById('playerSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('searchSuggestions').style.display = 'none';
        searchPlayer();
    }
});
</script>
{% endblock %}
