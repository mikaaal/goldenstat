{% extends "base.html" %}

{% block content %}

<!-- Informationssektion -->
<div class="row justify-content-center mb-5">
    <div class="col-md-10 col-lg-9">
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <div class="row align-items-center mb-3">
                    <div class="col-auto">
                    </div>
                </div>

                <div class="alert alert-warning alert-dismissible d-flex align-items-center py-2 mb-3" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div class="flex-grow-1">
                        <p class="text-muted mb-0">Statistik för spelade seriematcher baserat på data från nakka.com</p>
                        <strong>Betaversion:</strong> Det kan förekomma fel i hur data visas.
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-person-badge text-info me-2 mt-1"></i>
                            <div>
                                <h6 class="mb-1 text-info">Namnmappning</h6>
                                <small class="text-muted">
                                    Jag har försökt mappa olika namnvarianter för att visa en samlad spelarbild.
                                    Om ditt namn stavats olika kommer det visas som separata spelare.
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-people text-success me-2 mt-1"></i>
                            <div>
                                <h6 class="mb-1 text-success">Förnamnsmappning</h6>
                                <small class="text-muted">
                                    I många fall när bara förnamn angetts har jag mappat det till klubb,
                                    t.ex. "Jocke (Oilers)".
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-3">

                <div class="text-center">
                    <small class="text-muted">
                        <i class="bi bi-tools me-1"></i>
                        Mappningen förbättras kontinuerligt för bättre noggrannhet
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Söksektion -->
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-lg">
            <div class="card-body p-4">
                <!-- Search type tabs -->
                <ul class="nav nav-pills nav-fill mb-4" id="searchTypeTabs">
                    <li class="nav-item">
                        <button class="nav-link active" id="player-search-tab" onclick="switchSearchType('player')">
                            🎯 Sök Spelare
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="team-search-tab" onclick="switchSearchType('team')">
                            👥 Sök Lag
                        </button>
                    </li>
                </ul>
                
                <!-- Player search (existing) -->
                <div id="playerSearchSection">
                    <h5 class="text-center mb-3">Sök efter spelare</h5>
                <div class="input-group input-group-lg">
                    <input type="text" 
                           id="playerSearch" 
                           class="form-control" 
                           placeholder="Namn..."
                           autocomplete="off">
                    <button class="btn btn-primary" type="button" onclick="searchByText()">
                        <i class="bi bi-search">🔍</i> Sök
                    </button>
                </div>
                <div id="searchSuggestions" class="list-group mt-2" style="display: none; position: relative; z-index: 1050;"></div>
                
                <!-- Search Results List (for text search) -->
                <div id="searchResultsList" class="mt-3" style="display: none;">
                    <h6 class="text-muted mb-2">Sökresultat:</h6>
                    <div id="searchResultsContent" class="list-group"></div>
                </div>
                </div>
                
                <!-- Team search (new) -->
                <div id="teamSearchSection" style="display: none;">
                    <h5 class="text-center mb-3">Hitta laguppställning</h5>
                    <div class="input-group input-group-lg">
                        <input type="text" 
                               id="teamSearch" 
                               class="form-control" 
                               placeholder="Lagnamn..."
                               autocomplete="off">
                        <button class="btn btn-success" type="button" onclick="searchTeamByText()">
                            <i class="bi bi-search">🔍</i> Sök
                        </button>
                    </div>
                    <div id="teamSearchSuggestions" class="list-group mt-2" style="display: none; position: relative; z-index: 1050;"></div>
                    
                    <!-- Team Search Results List -->
                    <div id="teamSearchResultsList" class="mt-3" style="display: none;">
                        <h6 class="text-muted mb-2">Sökresultat:</h6>
                        <div id="teamSearchResultsContent" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtreringssektion för spelare -->
<div id="playerFilterSection" class="row justify-content-center mt-4" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label for="seasonFilter" class="form-label small mb-1">Säsong</label>
                        <select id="seasonFilter" class="form-select form-select-sm">
                            <option value="">Alla säsonger</option>
                        </select>
                    </div>
                    <div class="col-md-8 text-end">
                        <small class="text-muted" id="filterInfo">Visar data för alla säsonger</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Spelarresultatsektion -->
<div id="playerResultsSection" class="row justify-content-center mt-4" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="playerResultsTitle">Spelarstatistik</h5>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearPlayerResults()">
                    <i class="bi bi-x-lg"></i> Stäng
                </button>
            </div>
            <div class="card-body" id="playerResultsBody">
                <!-- Player stats will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Lagresultatsektion -->
<div id="teamResultsSection" class="row justify-content-center mt-4" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="teamResultsTitle">Laguppställning</h5>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearTeamResults()">
                    <i class="bi bi-x-lg"></i> Stäng
                </button>
            </div>
            <div class="card-body" id="teamResultsBody">
                <!-- Team lineup will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

// Globala variabler
let currentFilters = {
    season: ''
};
let allTeams = [];
let currentSearchType = 'player';

// Load player list on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPlayerList();
    loadTeamList();
    loadFilters();
    
    // Setup filter change handlers
    document.getElementById('seasonFilter').addEventListener('change', updateFilters);
    
    // Check for URL parameter for automatic player search
    const urlParams = new URLSearchParams(window.location.search);
    const playerParam = urlParams.get('player');
    if (playerParam) {
        document.getElementById('playerSearch').value = playerParam;
        searchPlayer();
    }
});

async function loadFilters() {
    try {
        const response = await fetch('/api/leagues');
        const data = await response.json();
        
        // Populate season filter
        const seasonSelect = document.getElementById('seasonFilter');
        data.seasons.forEach(season => {
            if (season && season !== 'Unknown') {
                const option = document.createElement('option');
                option.value = season;
                option.textContent = season;
                seasonSelect.appendChild(option);
            }
        });
        
        
    } catch (error) {
        console.error('Kunde inte ladda filter:', error);
    }
}

function updateFilters() {
    currentFilters.season = document.getElementById('seasonFilter').value;
    
    // Update filter info text
    const filterInfo = document.getElementById('filterInfo');
    let infoText = 'Visar data för ';
    
    if (currentFilters.season) {
        infoText += `säsong ${currentFilters.season}`;
    } else {
        infoText += 'alla säsonger';
    }
    
    filterInfo.textContent = infoText;
    
    // If a player is currently searched, refresh their stats with new filters
    const currentPlayer = document.getElementById('playerSearch').value.trim();
    if (currentPlayer) {
        searchPlayer();
    }
}

let allPlayers = [];

async function loadPlayerList() {
    try {
        const response = await fetch('/api/players');
        allPlayers = await response.json();
    } catch (error) {
        console.error('Kunde inte ladda spelare:', error);
    }
}

async function loadTeamList() {
    try {
        const response = await fetch('/api/teams');
        allTeams = await response.json();
    } catch (error) {
        console.error('Kunde inte ladda lag:', error);
    }
}

// Sökfunktionalitet
document.getElementById('playerSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    
    // Hide search results list when typing
    document.getElementById('searchResultsList').style.display = 'none';
    
    if (query.length < 2) {
        document.getElementById('searchSuggestions').style.display = 'none';
        return;
    }
    
    const suggestions = allPlayers.filter(player => 
        player.toLowerCase().includes(query)
    ).slice(0, 10);
    
    const suggestionsContainer = document.getElementById('searchSuggestions');
    if (suggestions.length > 0) {
        suggestionsContainer.innerHTML = suggestions.map(player => 
            `<button type="button" class="list-group-item list-group-item-action" onclick="selectPlayer('${player}')">${player}</button>`
        ).join('');
        suggestionsContainer.style.display = 'block';
    } else {
        suggestionsContainer.style.display = 'none';
    }
});

// New search function for text-based search
function searchByText() {
    const query = document.getElementById('playerSearch').value.trim().toLowerCase();
    if (query.length < 2) {
        alert('Skriv minst 2 tecken för att söka');
        return;
    }
    
    // Hide autocomplete suggestions
    document.getElementById('searchSuggestions').style.display = 'none';
    
    // Find all matching players
    const matchingPlayers = allPlayers.filter(player => 
        player.toLowerCase().includes(query)
    );
    
    if (matchingPlayers.length === 0) {
        alert('Inga spelare hittades som matchar din sökning');
        return;
    }
    
    if (matchingPlayers.length === 1) {
        // Only one match, select it directly
        selectPlayer(matchingPlayers[0]);
        return;
    }
    
    // Multiple matches, show list
    const resultsContainer = document.getElementById('searchResultsContent');
    resultsContainer.innerHTML = matchingPlayers.map(player => 
        `<button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="selectPlayer('${player}')">
            <span>${player}</span>
            <small class="text-primary">Visa statistik →</small>
        </button>`
    ).join('');
    
    document.getElementById('searchResultsList').style.display = 'block';
    
    // Scroll to results
    document.getElementById('searchResultsList').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
};

function selectPlayer(playerName) {
    document.getElementById('playerSearch').value = playerName;
    document.getElementById('searchSuggestions').style.display = 'none';
    document.getElementById('searchResultsList').style.display = 'none';
    searchPlayer();
}

async function searchPlayer() {
    const playerName = document.getElementById('playerSearch').value.trim();
    if (!playerName) return;
    
    try {
        // Build query parameters with filters
        const params = new URLSearchParams();
        if (currentFilters.season) params.append('season', currentFilters.season);
        
        const queryString = params.toString();
        const url = `/api/player/${encodeURIComponent(playerName)}${queryString ? '?' + queryString : ''}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (response.ok) {
            showPlayerStats(data);
        } else {
            alert(`Spelare hittades inte: ${data.error}`);
        }
    } catch (error) {
        console.error('Sökning misslyckades:', error);
        alert('Sökfel');
    }
}

async function showPlayerStats(stats) {
    // Store matches data for filtering/sorting
    storeMatchesData(stats.recent_matches);
    
    // Get the original searched player name (with team if applicable)
    const searchedPlayerName = document.getElementById('playerSearch').value.trim();
    
    // Uppdatera titel och visa laddning
    document.getElementById('playerResultsTitle').textContent = `${stats.player_name} - Spelarstatistik`;
    document.getElementById('playerResultsBody').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laddar kast-analys...</span>
            </div>
            <p>Hämtar detaljerad spelanalys...</p>
        </div>
    `;
    
    // Show the filter section and results section
    document.getElementById('playerFilterSection').style.display = 'block';
    document.getElementById('playerResultsSection').style.display = 'block';
    
    // Scroll to the results section
    document.getElementById('playerResultsSection').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
    
    // Ladda sedan kastanalys i bakgrunden - use original searched name for team filtering
    const throwData = await goldenStat.fetchThrowAnalysis(searchedPlayerName, currentFilters);
    
    console.log('Mottagen throwData:', throwData); // Debug
    
    document.getElementById('playerResultsBody').innerHTML = `
        <!-- Navigation tabs -->
        <ul class="nav nav-tabs nav-fill mb-3" id="playerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active fw-bold" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                    📊 Översikt
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold" id="matches-tab" data-bs-toggle="tab" data-bs-target="#matches" type="button">
                    🎯 Matcher (${stats.recent_matches.length})
                </button>
            </li>
        </ul>
        
        <!-- Flikinnehåll -->
        <div class="tab-content mt-3" id="playerTabsContent">
            <!-- Översiktsflik -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <!-- Tips för matchinteraktion -->
                <div class="alert alert-info alert-sm mb-3" role="alert">
                    <div class="d-flex align-items-center">
                        <span class="me-2">💡</span>
                        <small><strong>Tips:</strong>Klicka på "Matcher"-korten nedan eller växla till fliken "Matcher" för att se alla spelade matcher. Klicka sedan på en matchrad för detaljerade kastomgångar.</small>
                    </div>
                </div>
                
                <!-- Singlarstatistik -->
                <div class="mb-3">
                    <h6 class="text-muted mb-2">🎯 Singlar</h6>
                    <div class="row g-2">
                        <div class="col-12 col-md-6">
                            <div class="card bg-light h-100 card-clickable" onclick="switchToMatchesTab()" style="cursor: pointer;" title="Klicka för att se alla matcher">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="card-title mb-0">🎯 Matcher & Pilsnitt</h6>
                                        <small class="text-muted">📋 Visa alla</small>
                                    </div>
                                    <div class="row g-2 text-center">
                                        <div class="col-3">
                                            <h6 class="text-primary mb-0">${stats.singles.total_matches}</h6>
                                            <small class="text-muted">Matcher</small>
                                        </div>
                                        <div class="col-3">
                                            <h6 class="text-info mb-0">${throwData && throwData.statistics ? throwData.statistics.average_score : stats.singles.average_score}</h6>
                                            <small class="text-muted">Totalt</small>
                                        </div>
                                        <div class="col-3">
                                            <h6 class="text-success mb-0">${throwData && throwData.statistics ? throwData.statistics.average_score_won || '—' : '—'}</h6>
                                            <small class="text-muted">Vunna</small>
                                        </div>
                                        <div class="col-3">
                                            <h6 class="text-danger mb-0">${throwData && throwData.statistics ? throwData.statistics.average_score_lost || '—' : '—'}</h6>
                                            <small class="text-muted">Förlorade</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-success mb-1">${stats.singles.wins}</h5>
                                    <small class="card-text">Vinster</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-warning mb-1">${stats.singles.win_percentage.toFixed(1)}%</h5>
                                    <small class="card-text">Vinstprocent</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${throwData && throwData.statistics && Object.keys(throwData.statistics).length > 0 ? `
                    <!-- Kaststatistikrad -->
                    <div class="mb-3">
                        <div class="row g-2">
                            <div class="col-6 col-lg-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body py-2">
                                        <h6 class="text-warning mb-1">${throwData.statistics.throws_over_100 || 0}</h6>
                                        <small class="card-text">100+ kast</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-lg-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body py-2">
                                        <h6 class="text-primary mb-1">${throwData.statistics.throws_over_140 || 0}</h6>
                                        <small class="card-text">140+ kast</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-lg-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body py-2">
                                        <h6 class="text-danger mb-1">${throwData.statistics.throws_180 || 0}</h6>
                                        <small class="card-text">180-kast</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-lg-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body py-2">
                                        <h6 class="text-success mb-1">${throwData.statistics.high_finishes || 0}</h6>
                                        <small class="card-text">Höga utgångar</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Dubblarstatistik -->
                <div class="mb-4">
                    <h6 class="text-muted mb-2">👥 Dubblar</h6>
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100 card-clickable" onclick="switchToMatchesTab()" style="cursor: pointer;" title="Klicka för att se alla matcher">
                                <div class="card-body py-2">
                                    <h5 class="text-primary mb-1">${stats.doubles.total_matches}</h5>
                                    <small class="card-text">Matcher</small>
                                    <div><small class="text-muted">📋 Visa alla</small></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-success mb-1">${stats.doubles.wins}</h5>
                                    <small class="card-text">Vinster</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-warning mb-1">${stats.doubles.win_percentage.toFixed(1)}%</h5>
                                    <small class="card-text">Vinstprocent</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center bg-light h-100">
                                <div class="card-body py-2">
                                    <h5 class="text-muted mb-1">-</h5>
                                    <small class="card-text">Snitt-average</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Chart -->
                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <canvas id="progressChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Throw Distribution Chart -->
                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <canvas id="throwDistributionChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Match Position Chart -->
                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <canvas id="matchPositionChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <!-- Matcherflik -->
            <div class="tab-pane fade" id="matches" role="tabpanel">
                
                <!-- Match filter controls -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="matchTypeFilter" class="form-label small">Visa matchtyp</label>
                        <select id="matchTypeFilter" class="form-select form-select-sm" onchange="filterMatches()">
                            <option value="all">Alla matcher</option>
                            <option value="Singles">Endast singlar</option>
                            <option value="Doubles">Endast dubblar</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="matchSortOrder" class="form-label small">Sortering</label>
                        <select id="matchSortOrder" class="form-select form-select-sm" onchange="sortMatches()">
                            <option value="date-desc">Senaste först</option>
                            <option value="date-asc">Äldsta först</option>
                            <option value="average-desc">Högsta snitt först</option>
                            <option value="average-asc">Lägsta snitt först</option>
                        </select>
                    </div>
                </div>
                
                <div class="d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm" id="matchesTable">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Typ</th>
                                    <th>Motståndare</th>
                                    <th>Resultat</th>
                                    <th>Snitt</th>
                                    <th>Resultat</th>
                                </tr>
                            </thead>
                            <tbody id="matchesTableBody">
                                ${stats.recent_matches.map(match => `
                                    <tr class="${match.sub_match_id ? 'table-row-clickable' : ''}" ${match.sub_match_id ? 'onclick="window.location.href=\'/sub_match_throws?sub_match_id=' + match.sub_match_id + '&player_name=' + encodeURIComponent(stats.player_name) + '\'" title="Klicka för att se kastomgångar"' : ''} data-match-type="${match.match_type}" data-match-date="${match.match_date}" data-average="${match.player_avg || 0}">
                                        <td><small style="white-space: nowrap;">${match.match_date ? new Date(match.match_date).toLocaleDateString('sv-SE') : 'N/A'}</small></td>
                                        <td><small><span class="badge ${match.match_type === 'Singles' ? 'bg-primary' : 'bg-secondary'}">${match.match_name && match.match_name.includes(' AD') ? 'AD' : (match.match_type === 'Singles' ? 'S' : 'D')}</span></small></td>
                                        <td><small>
                                            ${match.match_type === 'Doubles' && match.teammate ?
                                                `<div><strong>Du spelade med:</strong> ${goldenStat.makePlayerNameClickable(match.teammate, false)}</div>` :
                                                ''
                                            }
                                            <div><strong>Motståndare:</strong> ${goldenStat.makePlayerNameClickable(match.opponent || match.team1_name + ' vs ' + match.team2_name, (match.match_type === 'Doubles'))}</div>
                                            <span class="text-muted">(${match.opponent_team || match.match_type})</span><br>
                                            <span class="text-muted" style="font-size: 0.8em;">(${match.player_team}${match.season ? ', ' + match.season : ''}${match.division && match.division !== 'Unknown' ? ', ' + match.division : ''})</span>
                                        </small></td>
                                        <td><small>${match.team1_legs} - ${match.team2_legs}</small></td>
                                        <td><small>${match.player_avg ? match.player_avg.toFixed(2) : 'N/A'}</small></td>
                                        <td>
                                            ${match.won ? 
                                                `<span class="badge bg-success badge-sm">Vinst</span>` : 
                                                `<span class="badge bg-danger badge-sm">Förlust</span>`
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Mobilvy -->
                <div class="d-md-none">
                    
                    <div id="mobileMatchesList">
                    ${stats.recent_matches.map(match => `
                        <div class="card mb-2 ${match.sub_match_id ? 'card-clickable' : ''}" ${match.sub_match_id ? 'title="Klicka för att se kastomgångar"' : ''} data-match-type="${match.match_type}" data-match-date="${match.match_date}" data-average="${match.player_avg || 0}">
                            <div class="card-body py-2" ${match.sub_match_id ? 'onclick="window.location.href=\'/sub_match_throws?sub_match_id=' + match.sub_match_id + '&player_name=' + encodeURIComponent(stats.player_name) + '\'"' : ''}>
                                <div class="row">
                                    <div class="col-8">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <small class="text-muted" style="white-space: nowrap;">${match.match_date ? new Date(match.match_date).toLocaleDateString('sv-SE') : 'N/A'}</small>
                                                    <span class="badge ${match.match_type === 'Singles' ? 'bg-primary' : 'bg-secondary'} badge-sm">${match.match_name && match.match_name.includes(' AD') ? 'AD' : (match.match_type === 'Singles' ? 'S' : 'D')}</span>
                                                </div>
                                                <div><strong>${goldenStat.makePlayerNameClickable(match.opponent || match.team1_name + ' vs ' + match.team2_name, (match.match_type === 'Doubles'))}</strong> <small class="text-muted">(${match.opponent_team || match.match_type})</small></div>
                                                <div><small class="text-muted" style="font-size: 0.8em;">(${match.player_team}${match.season ? ', ' + match.season : ''}${match.division && match.division !== 'Unknown' ? ', ' + match.division : ''})</small></div>
                                                <div>
                                                    <span class="fw-bold">${match.team1_legs} - ${match.team2_legs}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div>
                                            ${match.won ? 
                                                `<span class="badge bg-success">Vinst</span>` : 
                                                `<span class="badge bg-danger">Förlust</span>`
                                            }
                                        </div>
                                        <div><small class="text-muted">Snitt: ${match.player_avg ? match.player_avg.toFixed(2) : 'N/A'}</small></div>
                                        ${match.sub_match_id ? '<div><small class="text-primary">🎯 Visa kast</small></div>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Skapa diagram efter att innehåll har laddats
    setTimeout(() => {
        // Översiktsdiagram
        goldenStat.createProgressChart('progressChart', stats.recent_matches);
        
        // Kastfördelningsdiagram i översikt
        if (throwData && throwData.statistics && throwData.statistics.score_ranges) {
            goldenStat.createThrowDistributionChart('throwDistributionChart', throwData.statistics.score_ranges);
        }
        
        // Matchpositionsdiagram
        const positionStats = goldenStat.calculateMatchPositions(stats.recent_matches);
        goldenStat.createMatchPositionChart('matchPositionChart', positionStats);
    }, 100);
}

// Ladda och visa minnesvärda matcher
async function loadMemorableMatches(playerId) {
    try {
        const response = await fetch(`/api/player/${playerId}/memorable-matches`);
        const data = await response.json();

        if (response.ok && data.memorable_matches && data.memorable_matches.length > 0) {
            displayMemorableMatches(data.memorable_matches);
            document.getElementById('memorableMatchesSection').style.display = 'block';
        } else {
            // Dölj sektionen om inga matcher finns
            document.getElementById('memorableMatchesSection').style.display = 'none';
        }
    } catch (error) {
        console.error('Fel vid hämtning av minnesvärda matcher:', error);
        document.getElementById('memorableMatchesSection').style.display = 'none';
    }
}

// Visa minnesvärda matcher
function displayMemorableMatches(matches) {
    const container = document.getElementById('memorableMatchesList');

    if (!matches || matches.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3">Inga minnesvärda matcher hittades</div>';
        return;
    }

    const matchItems = matches.map((match, index) => {
        const date = new Date(match.date).toLocaleDateString('sv-SE');
        const resultIcon = match.won_match ? '🟢' : '🔴';
        const resultText = match.won_match ? 'Vinst' : 'Förlust';

        // Skapa statistikikoner
        const stats = [];
        if (match.average_score >= 45) stats.push(`🎯 ${match.average_score}`);
        if (match.short_sets > 0) stats.push(`⚡ ${match.short_sets} kort set`);
        if (match.high_finishes > 0) stats.push(`🔥 ${match.high_finishes} hög utgång`);

        const statsText = stats.length > 0 ? stats.join(' • ') : 'Bra prestanda';

        return `
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
                 style="cursor: pointer;" onclick="showSubMatchThrows(${match.sub_match_id})">
                <div class="ms-2 me-auto">
                    <div class="d-flex align-items-center mb-1">
                        <span class="badge bg-primary rounded-pill me-2">#${index + 1}</span>
                        <div class="fw-bold">${match.opponent_team}</div>
                        <span class="ms-2">${resultIcon} ${resultText}</span>
                    </div>
                    <small class="text-muted d-block">${date} • ${match.season || 'Okänd säsong'}</small>
                    <small class="text-info">${statsText}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-warning text-dark" title="Minnesvärdighetspoäng">
                        ${match.memorability_score}
                    </span>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = matchItems;
}

// Hantera Enter-tangent i sökning
document.getElementById('playerSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('searchSuggestions').style.display = 'none';
        
        // Check if there are visible suggestions, select first one
        const suggestions = document.querySelectorAll('#searchSuggestions .list-group-item');
        if (suggestions.length > 0 && document.getElementById('searchSuggestions').style.display !== 'none') {
            const firstSuggestion = suggestions[0].textContent;
            selectPlayer(firstSuggestion);
        } else {
            // No suggestions visible, do text search
            searchByText();
        }
    }
});

// Funktion för att växla till Matcher-fliken
function switchToMatchesTab() {
    const matchesTab = document.getElementById('matches-tab');
    if (matchesTab) {
        matchesTab.click();
        
        // Scroll to top of matches section
        setTimeout(() => {
            document.getElementById('playerTabs').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }, 100);
    }
}

// Global variable to store original matches data
let originalMatchesData = [];

// Store matches data when player stats are loaded
function storeMatchesData(matches) {
    originalMatchesData = matches.slice(); // Create a copy
}

// Filter matches by type
function filterMatches() {
    const filterValue = document.getElementById('matchTypeFilter').value;

    // Apply filter and then current sort
    let filteredMatches = originalMatchesData.slice();

    if (filterValue !== 'all') {
        filteredMatches = filteredMatches.filter(match => {
            // For Singles filter: exclude AD (Avgörande Dubbel) matches
            if (filterValue === 'Singles') {
                return match.match_type === 'Singles' && !(match.match_name && match.match_name.includes(' AD'));
            }
            // For Doubles filter: include all Doubles (including AD)
            return match.match_type === filterValue;
        });
    }
    
    // Apply current sort order
    const sortOrder = document.getElementById('matchSortOrder').value;
    filteredMatches = applySortToMatches(filteredMatches, sortOrder);
    
    // Update both desktop and mobile views
    updateMatchesDisplay(filteredMatches);
}

// Sort matches
function sortMatches() {
    const sortOrder = document.getElementById('matchSortOrder').value;
    const filterValue = document.getElementById('matchTypeFilter').value;

    // Apply current filter first
    let filteredMatches = originalMatchesData.slice();

    if (filterValue !== 'all') {
        filteredMatches = filteredMatches.filter(match => {
            // For Singles filter: exclude AD (Avgörande Dubbel) matches
            if (filterValue === 'Singles') {
                return match.match_type === 'Singles' && !(match.match_name && match.match_name.includes(' AD'));
            }
            // For Doubles filter: include all Doubles (including AD)
            return match.match_type === filterValue;
        });
    }
    
    // Apply sort
    filteredMatches = applySortToMatches(filteredMatches, sortOrder);
    
    // Update display
    updateMatchesDisplay(filteredMatches);
}

// Apply sorting logic
function applySortToMatches(matches, sortOrder) {
    return matches.sort((a, b) => {
        switch (sortOrder) {
            case 'date-desc':
                return new Date(b.match_date || 0) - new Date(a.match_date || 0);
            case 'date-asc':
                return new Date(a.match_date || 0) - new Date(b.match_date || 0);
            case 'average-desc':
                return (b.player_avg || 0) - (a.player_avg || 0);
            case 'average-asc':
                return (a.player_avg || 0) - (b.player_avg || 0);
            default:
                return 0;
        }
    });
}

// Update matches display with filtered/sorted data
function updateMatchesDisplay(matches) {
    const currentPlayerName = document.getElementById('playerSearch').value.trim();
    
    // Update desktop table
    const tableBody = document.getElementById('matchesTableBody');
    if (tableBody) {
        tableBody.innerHTML = matches.map(match => `
            <tr class="${match.sub_match_id ? 'table-row-clickable' : ''}" ${match.sub_match_id ? 'onclick="window.location.href=\'/sub_match_throws?sub_match_id=' + match.sub_match_id + '&player_name=' + encodeURIComponent(currentPlayerName) + '\'" title="Klicka för att se kastomgångar"' : ''} data-match-type="${match.match_type}" data-match-date="${match.match_date}" data-average="${match.player_avg || 0}">
                <td><small style="white-space: nowrap;">${match.match_date ? new Date(match.match_date).toLocaleDateString('sv-SE') : 'N/A'}</small></td>
                <td><small><span class="badge ${match.match_type === 'Singles' ? 'bg-primary' : 'bg-secondary'}">${match.match_name && match.match_name.includes(' AD') ? 'AD' : (match.match_type === 'Singles' ? 'S' : 'D')}</span></small></td>
                <td><small>${goldenStat.makePlayerNameClickable(match.opponent || match.team1_name + ' vs ' + match.team2_name, (match.match_type === 'Doubles'))} <span class="text-muted">(${match.opponent_team || match.match_type})</span><br><span class="text-muted" style="font-size: 0.8em;">(${match.player_team}${match.season ? ', ' + match.season : ''}${match.division && match.division !== 'Unknown' ? ', ' + match.division : ''})</span></small></td>
                <td><small>${match.team1_legs} - ${match.team2_legs}</small></td>
                <td><small>${match.player_avg ? match.player_avg.toFixed(2) : 'N/A'}</small></td>
                <td>
                    ${match.won ? 
                        '<span class="badge bg-success badge-sm">Vinst</span>' : 
                        '<span class="badge bg-danger badge-sm">Förlust</span>'
                    }
                </td>
            </tr>
        `).join('');
    }
    
    // Update mobile list
    const mobileList = document.getElementById('mobileMatchesList');
    if (mobileList) {
        mobileList.innerHTML = matches.map(match => `
            <div class="card mb-2 ${match.sub_match_id ? 'card-clickable' : ''}" ${match.sub_match_id ? 'title="Klicka för att se kastomgångar"' : ''} data-match-type="${match.match_type}" data-match-date="${match.match_date}" data-average="${match.player_avg || 0}">
                <div class="card-body py-2" ${match.sub_match_id ? 'onclick="window.location.href=\'/sub_match_throws?sub_match_id=' + match.sub_match_id + '&player_name=' + encodeURIComponent(currentPlayerName) + '\'"' : ''}>
                    <div class="row">
                        <div class="col-8">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <small class="text-muted" style="white-space: nowrap;">${match.match_date ? new Date(match.match_date).toLocaleDateString('sv-SE') : 'N/A'}</small>
                                        <span class="badge ${match.match_type === 'Singles' ? 'bg-primary' : 'bg-secondary'} badge-sm">${match.match_name && match.match_name.includes(' AD') ? 'AD' : (match.match_type === 'Singles' ? 'S' : 'D')}</span>
                                    </div>
                                    ${match.match_type === 'Doubles' && match.teammate ?
                                        `<div><small><strong>Med:</strong> ${goldenStat.makePlayerNameClickable(match.teammate, false)}</small></div>` :
                                        ''
                                    }
                                    <div><strong>Ni mötte:</strong> ${goldenStat.makePlayerNameClickable(match.opponent || match.team1_name + ' vs ' + match.team2_name, (match.match_type === 'Doubles'))} <small class="text-muted">(${match.opponent_team || match.match_type})</small></div>
                                    <div><small class="text-muted" style="font-size: 0.8em;">(${match.player_team}${match.season ? ', ' + match.season : ''}${match.division && match.division !== 'Unknown' ? ', ' + match.division : ''})</small></div>
                                    <div>
                                        <span class="fw-bold">${match.team1_legs} - ${match.team2_legs}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div>
                                ${match.won ? 
                                    '<span class="badge bg-success">Vinst</span>' : 
                                    '<span class="badge bg-danger">Förlust</span>'
                                }
                            </div>
                            <div><small class="text-muted">Snitt: ${match.player_avg ? match.player_avg.toFixed(2) : 'N/A'}</small></div>
                            ${match.sub_match_id ? '<div><small class="text-primary">🎯 Visa kast</small></div>' : ''}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
}

// Switch between search types
function switchSearchType(type) {
    currentSearchType = type;
    
    // Update tab appearance
    document.getElementById('player-search-tab').classList.toggle('active', type === 'player');
    document.getElementById('team-search-tab').classList.toggle('active', type === 'team');
    
    // Show/hide search sections
    document.getElementById('playerSearchSection').style.display = type === 'player' ? 'block' : 'none';
    document.getElementById('teamSearchSection').style.display = type === 'team' ? 'block' : 'none';
    
    // Clear previous results
    clearPlayerResults();
    clearTeamResults();
}

// Team search functionality
document.getElementById('teamSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    
    // Hide search results list when typing
    document.getElementById('teamSearchResultsList').style.display = 'none';
    
    if (query.length < 2) {
        document.getElementById('teamSearchSuggestions').style.display = 'none';
        return;
    }
    
    const suggestions = allTeams.filter(team => 
        team.toLowerCase().includes(query)
    ).slice(0, 10);
    
    const suggestionsContainer = document.getElementById('teamSearchSuggestions');
    if (suggestions.length > 0) {
        suggestionsContainer.innerHTML = suggestions.map(team => 
            `<button type="button" class="list-group-item list-group-item-action" onclick="selectTeam('${team}')">${team}</button>`
        ).join('');
        suggestionsContainer.style.display = 'block';
    } else {
        suggestionsContainer.style.display = 'none';
    }
});

// Team search by text
function searchTeamByText() {
    const query = document.getElementById('teamSearch').value.trim().toLowerCase();
    if (query.length < 2) {
        alert('Skriv minst 2 tecken för att söka');
        return;
    }
    
    // Hide autocomplete suggestions
    document.getElementById('teamSearchSuggestions').style.display = 'none';
    
    // Find all matching teams
    const matchingTeams = allTeams.filter(team => 
        team.toLowerCase().includes(query)
    );
    
    if (matchingTeams.length === 0) {
        alert('Inga lag hittades som matchar din sökning');
        return;
    }
    
    if (matchingTeams.length === 1) {
        // Only one match, select it directly
        selectTeam(matchingTeams[0]);
        return;
    }
    
    // Multiple matches, show list
    const resultsContainer = document.getElementById('teamSearchResultsContent');
    resultsContainer.innerHTML = matchingTeams.map(team => 
        `<button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="selectTeam('${team}')">
            <span>${team}</span>
            <small class="text-success">Visa uppställning →</small>
        </button>`
    ).join('');
    
    document.getElementById('teamSearchResultsList').style.display = 'block';
    
    // Scroll to results
    document.getElementById('teamSearchResultsList').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

function selectTeam(teamName) {
    document.getElementById('teamSearch').value = teamName;
    document.getElementById('teamSearchSuggestions').style.display = 'none';
    document.getElementById('teamSearchResultsList').style.display = 'none';
    searchTeam();
}

async function searchTeam() {
    const teamName = document.getElementById('teamSearch').value.trim();
    if (!teamName) return;
    
    try {
        // Build query parameters with filters
        const params = new URLSearchParams();
        if (currentFilters.season) params.append('season', currentFilters.season);
        
        const queryString = params.toString();
        const url = `/api/team/${encodeURIComponent(teamName)}/lineup${queryString ? '?' + queryString : ''}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (response.ok) {
            showTeamLineup(data);
        } else {
            alert(`Lag hittades inte: ${data.error}`);
        }
    } catch (error) {
        console.error('Sökning misslyckades:', error);
        alert('Sökfel');
    }
}

function showTeamLineup(data) {
    // Show the team results section
    document.getElementById('teamResultsSection').style.display = 'block';
    document.getElementById('teamResultsTitle').textContent = `${data.team_name} - Trolig uppställning`;
    
    // Hide player results and filter if showing
    document.getElementById('playerFilterSection').style.display = 'none';
    document.getElementById('playerResultsSection').style.display = 'none';
    
    document.getElementById('teamResultsBody').innerHTML = `
        <div class="text-center mb-4">
            <h6 class="text-muted">Baserat på ${data.total_matches} matcher${data.season ? ` i ${data.season}` : ''}${data.division ? ` (${data.division})` : ''}${!data.season && !data.division ? ' från alla säsonger' : ''}</h6>
        </div>
        
        <!-- Doubles positions -->
        <div class="mb-4">
            <h6 class="text-muted mb-3">👥 Dubblar</h6>
            <div class="row g-3">
                ${['D1', 'D2', 'D3'].map(position => {
                    const posData = data.positions[position];
                    return posData ? `
                        <div class="col-md-4">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">${position}</h6>
                                    <div class="mb-2">
                                        ${posData.players.map(p => 
                                            `<div><strong>${goldenStat.makePlayerNameClickable(p.name)}</strong></div>
                                             <small class="text-muted">${p.percentage}% (${p.matches} matcher)</small>`
                                        ).join('<hr class="my-2">')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="col-md-4">
                            <div class="card text-center h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-muted">${position}</h6>
                                    <small class="text-muted">Ingen data</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <!-- Singles positions -->
        <div class="mb-4">
            <h6 class="text-muted mb-3">🎯 Singlar</h6>
            <div class="row g-3">
                ${['S1', 'S2', 'S3', 'S4', 'S5', 'S6'].map(position => {
                    const posData = data.positions[position];
                    return posData ? `
                        <div class="col-md-4 col-lg-2">
                            <div class="card text-center h-100">
                                <div class="card-body py-2">
                                    <h6 class="card-title text-success">${position}</h6>
                                    <div>
                                        <strong>${goldenStat.makePlayerNameClickable(posData.top_player.name)}</strong>
                                    </div>
                                    <small class="text-muted">${posData.top_player.percentage}%</small>
                                    <div><small class="text-muted">${posData.top_player.matches} matcher</small></div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="col-md-4 col-lg-2">
                            <div class="card text-center h-100">
                                <div class="card-body py-2">
                                    <h6 class="card-title text-muted">${position}</h6>
                                    <small class="text-muted">Ingen data</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <!-- AD position if exists -->
        ${data.positions['AD'] ? `
            <div class="mb-4">
                <h6 class="text-muted mb-3">⚡ Avgörande dubbel (AD)</h6>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-title text-warning">AD</h6>
                                <div class="mb-2">
                                    ${data.positions['AD'].players.map(p => 
                                        `<div><strong>${goldenStat.makePlayerNameClickable(p.name)}</strong></div>
                                         <small class="text-muted">${p.percentage}% (${p.matches} matcher)</small>`
                                    ).join('<hr class="my-2">')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
    `;
    
    // Scroll to results
    document.getElementById('teamResultsSection').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// Team enter key handling
document.getElementById('teamSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('teamSearchSuggestions').style.display = 'none';
        
        // Check if there are visible suggestions, select first one
        const suggestions = document.querySelectorAll('#teamSearchSuggestions .list-group-item');
        if (suggestions.length > 0 && document.getElementById('teamSearchSuggestions').style.display !== 'none') {
            const firstSuggestion = suggestions[0].textContent;
            selectTeam(firstSuggestion);
        } else {
            // No suggestions visible, do text search
            searchTeamByText();
        }
    }
});

// Funktion för att rensa lagresultat
function clearTeamResults() {
    document.getElementById('teamResultsSection').style.display = 'none';
    document.getElementById('teamResultsBody').innerHTML = '';
    document.getElementById('teamSearchResultsList').style.display = 'none';
    document.getElementById('teamSearch').value = '';
}

// Funktion för att rensa spelarresultat
function clearPlayerResults() {
    document.getElementById('playerFilterSection').style.display = 'none';
    document.getElementById('playerResultsSection').style.display = 'none';
    document.getElementById('playerResultsBody').innerHTML = '';
    document.getElementById('searchResultsList').style.display = 'none';
    document.getElementById('playerSearch').value = '';
    originalMatchesData = []; // Clear stored data
}
</script>
{% endblock %}
