{% extends "base.html" %}

{% block title %}Seriematch{% endblock %}

{% block sticky_tabs %}
<!-- Sticky Tab Navigation -->
<div class="sticky-tabs">
    <div class="container">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/">
                    Spelare
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=teams">
                    Lag
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=stats">
                    Topplistor
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=weekly">
                    Veckans prestationer!
                </a>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">Seriematch</h1>
                <button onclick="window.history.back()" class="btn btn-primary">Tillbaka</button>
            </div>
            <div class="card-body">

                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laddar...</span>
                    </div>
                    <p class="mt-2 text-muted">Laddar matchinformation...</p>
                </div>

                <div id="error-message" class="alert alert-danger d-none">
                </div>

                <div id="match-content" class="d-none">
                    <!-- Match header with team names and total result -->
                    <div id="match-header" class="mb-4">
                        <!-- Populated by JavaScript -->
                    </div>

                    <!-- Sub-matches table -->
                    <div id="sub-matches-table" class="table-responsive">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sub-match-row {
    cursor: pointer;
    transition: background-color 0.2s;
}

.sub-match-row:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.winner-cell {
    background-color: rgba(40, 167, 69, 0.15);
}

.loser-cell {
    background-color: rgba(220, 53, 69, 0.08);
}

.position-badge {
    font-weight: bold;
    min-width: 40px;
    display: inline-block;
    text-align: center;
}

.position-singles {
    background-color: #17a2b8;
}

.position-doubles {
    background-color: #6f42c1;
}

.position-ad {
    background-color: #fd7e14;
}

.player-link {
    cursor: pointer;
    color: inherit;
    text-decoration: none;
}

.player-link:hover {
    text-decoration: underline;
    color: #007bff;
}
</style>

<script>
// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const matchId = urlParams.get('match_id');

function navigateToPlayer(playerName) {
    event.stopPropagation();
    window.location.href = `/?player=${encodeURIComponent(playerName)}`;
}

function navigateToSubMatch(subMatchId, playerName) {
    if (playerName && playerName.trim()) {
        // Get first player name if multiple (for doubles)
        const firstPlayer = playerName.split(' / ')[0].trim();
        window.location.href = `/sub_match_throws?sub_match_id=${subMatchId}&player_name=${encodeURIComponent(firstPlayer)}`;
    } else {
        window.location.href = `/sub_match_throws?sub_match_id=${subMatchId}`;
    }
}

function makePlayerNameClickable(playerName) {
    if (!playerName || playerName.trim() === '') {
        return '<span class="text-muted">-</span>';
    }

    if (playerName.includes(' / ')) {
        // Handle multiple players
        const players = playerName.split(' / ');
        return players.map(player => {
            const trimmedPlayer = player.trim();
            const escapedName = trimmedPlayer.replace(/'/g, "\\'");
            return `<span class="player-link" onclick="navigateToPlayer('${escapedName}')" title="Klicka for att se ${trimmedPlayer}">${trimmedPlayer}</span>`;
        }).join(' / ');
    } else {
        const escapedName = playerName.replace(/'/g, "\\'");
        return `<span class="player-link" onclick="navigateToPlayer('${escapedName}')" title="Klicka for att se ${playerName}">${playerName}</span>`;
    }
}

function getPositionBadgeClass(position) {
    if (position.startsWith('S')) return 'position-singles';
    if (position.startsWith('D')) return 'position-doubles';
    if (position === 'AD') return 'position-ad';
    return 'bg-secondary';
}

async function loadMatchOverview() {
    if (!matchId) {
        document.getElementById('error-message').innerHTML = 'Saknar match_id i URL';
        document.getElementById('error-message').classList.remove('d-none');
        document.getElementById('loading').classList.add('d-none');
        return;
    }

    try {
        const response = await fetch(`/api/match/${matchId}/overview`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Kunde inte ladda matchdata');
        }

        displayMatchOverview(data);
    } catch (error) {
        document.getElementById('error-message').innerHTML = `Fel: ${error.message}`;
        document.getElementById('error-message').classList.remove('d-none');
    } finally {
        document.getElementById('loading').classList.add('d-none');
    }
}

function displayMatchOverview(data) {
    const matchInfo = data.match_info;
    const subMatches = data.sub_matches;

    // Update page title
    document.title = `${matchInfo.team1_name} vs ${matchInfo.team2_name}`;

    // Determine winner
    const team1Won = matchInfo.team1_score > matchInfo.team2_score;
    const team2Won = matchInfo.team2_score > matchInfo.team1_score;
    const isDraw = matchInfo.team1_score === matchInfo.team2_score;

    const team1Style = team1Won ? 'border-success bg-success bg-opacity-10' :
                      team2Won ? 'border-danger bg-danger bg-opacity-10' :
                      'border-warning bg-warning bg-opacity-10';
    const team1TextColor = team1Won ? 'text-success' :
                          team2Won ? 'text-danger' :
                          'text-warning';

    const team2Style = team2Won ? 'border-success bg-success bg-opacity-10' :
                      team1Won ? 'border-danger bg-danger bg-opacity-10' :
                      'border-warning bg-warning bg-opacity-10';
    const team2TextColor = team2Won ? 'text-success' :
                          team1Won ? 'text-danger' :
                          'text-warning';

    // Match header - include both sub-match result and leg result
    const matchHeader = document.getElementById('match-header');
    matchHeader.innerHTML = `
        <div class="text-center mb-3">
            <span class="badge bg-secondary fs-6 px-3 py-2 me-2">${matchInfo.match_date ? new Date(matchInfo.match_date).toLocaleDateString('sv-SE') : 'Okant datum'}</span>
            <span class="badge bg-info fs-6 px-3 py-2 me-2">${matchInfo.season || ''}</span>
            <span class="badge bg-primary fs-6 px-3 py-2">${matchInfo.division || ''}</span>
        </div>
        <div class="row text-center mb-4">
            <div class="col-md-5">
                <div class="border ${team1Style} rounded p-3">
                    <h5 class="${team1TextColor} mb-0">${matchInfo.team1_name}${team1Won ? ' (V)' : ''}</h5>
                </div>
            </div>
            <div class="col-md-2 d-flex align-items-center justify-content-center">
                <div class="text-center">
                    <div class="h3 mb-0">${data.team1_sub_wins} - ${data.team2_sub_wins}</div>
                    <small class="text-muted">Delmatchar</small>
                    <div class="h5 mb-0 mt-1">(${matchInfo.team1_score} - ${matchInfo.team2_score})</div>
                    <small class="text-muted">Ben</small>
                </div>
            </div>
            <div class="col-md-5">
                <div class="border ${team2Style} rounded p-3">
                    <h5 class="${team2TextColor} mb-0">${matchInfo.team2_name}${team2Won ? ' (V)' : ''}</h5>
                </div>
            </div>
        </div>
    `;

    // Sub-matches table
    const tableContainer = document.getElementById('sub-matches-table');
    let tableHtml = `
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th class="text-center" style="width: 50px;">Match</th>
                    <th class="text-end" style="width: 38%;">${matchInfo.team1_name}</th>
                    <th class="text-center" style="width: 70px;">Resultat</th>
                    <th style="width: 38%;">${matchInfo.team2_name}</th>
                </tr>
            </thead>
            <tbody>
    `;

    subMatches.forEach(sm => {
        const team1Won = sm.team1_legs > sm.team2_legs;
        const team2Won = sm.team2_legs > sm.team1_legs;
        const notPlayed = sm.team1_legs === 0 && sm.team2_legs === 0 && !sm.team1_players && !sm.team2_players;

        const team1CellClass = team1Won ? 'winner-cell' : (team2Won ? 'loser-cell' : '');
        const team2CellClass = team2Won ? 'winner-cell' : (team1Won ? 'loser-cell' : '');

        const badgeClass = getPositionBadgeClass(sm.position);

        const resultDisplay = notPlayed ? '-' : `${sm.team1_legs}-${sm.team2_legs}`;

        // Format player names with averages
        const team1PlayerDisplay = sm.team1_players
            ? `${makePlayerNameClickable(sm.team1_players)}${sm.team1_avg ? `<br><small class="text-muted">${sm.team1_avg}</small>` : ''}`
            : '<span class="text-muted">-</span>';

        const team2PlayerDisplay = sm.team2_players
            ? `${makePlayerNameClickable(sm.team2_players)}${sm.team2_avg ? `<br><small class="text-muted">${sm.team2_avg}</small>` : ''}`
            : '<span class="text-muted">-</span>';

        tableHtml += `
            <tr class="sub-match-row" onclick="navigateToSubMatch(${sm.id}, '${(sm.team1_players || '').replace(/'/g, "\\'")}')">
                <td class="text-center align-middle">
                    <span class="badge ${badgeClass} position-badge">${sm.position}</span>
                </td>
                <td class="text-end ${team1CellClass} align-middle">
                    ${team1PlayerDisplay}
                </td>
                <td class="text-center fw-bold align-middle">
                    ${resultDisplay}
                </td>
                <td class="${team2CellClass} align-middle">
                    ${team2PlayerDisplay}
                </td>
            </tr>
        `;
    });

    tableHtml += `
            </tbody>
        </table>
    `;

    tableContainer.innerHTML = tableHtml;
    document.getElementById('match-content').classList.remove('d-none');
}

// Initialize
loadMatchOverview();

// Load last import info
async function loadLastImport() {
    try {
        const response = await fetch('/api/last-import');
        const data = await response.json();

        if (response.ok && data.end_time) {
            const badge = document.createElement('div');
            badge.className = 'last-update-badge';
            badge.textContent = `Uppdaterad\n${data.end_time.split(' ')[0]}`;
            document.body.appendChild(badge);
        }
    } catch (error) {
        console.error('Kunde inte ladda importinfo:', error);
    }
}

loadLastImport();
</script>
{% endblock %}
