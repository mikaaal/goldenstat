{% extends "base.html" %}

{% block title %}Seriematch{% endblock %}

{% block sticky_tabs %}
<!-- Sticky Tab Navigation -->
<div class="sticky-tabs">
    <div class="container">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/">
                    üë§ Spelare
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=teams">
                    üë• Lag
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/series_matches">
                    üìã Seriematcher
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=stats">
                    üéØ Topplistor
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=weekly">
                    ‚≠ê Veckans prestationer!
                </a>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                
                <button onclick="window.history.back()" class="btn btn-primary">Tillbaka</button>
            </div>
            <div class="card-body">

                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laddar...</span>
                    </div>
                    <p class="mt-2 text-muted">Laddar matchinformation...</p>
                </div>

                <div id="error-message" class="alert alert-danger d-none">
                </div>

                <div id="match-content" class="d-none">
                    <!-- Match header with team names and total result -->
                    <div id="match-header" class="mb-4">
                        <!-- Populated by JavaScript -->
                    </div>

                    <!-- Sub-matches table -->
                    <div id="sub-matches-table" class="table-responsive">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sub-match-row {
    cursor: pointer;
    transition: background-color 0.2s;
}

.sub-match-row:hover {
    background-color: rgba(0, 123, 255, 0.15);
}

.sub-match-row:hover .click-indicator {
    color: #007bff;
    transform: translateX(3px);
}

.click-indicator {
    font-size: 1.5rem;
    font-weight: bold;
    color: #adb5bd;
    transition: all 0.2s;
}

.winner-cell {
    background-color: rgba(40, 167, 69, 0.15);
}

.loser-cell {
    background-color: rgba(220, 53, 69, 0.08);
}

/* Cell dividers */
.sub-match-row td {
    border-right: 1px solid #e9ecef;
}

.sub-match-row td:last-child {
    border-right: none;
}

.table thead th {
    border-right: 1px solid #dee2e6;
}

.table thead th:last-child {
    border-right: none;
}

.position-badge {
    font-weight: bold;
    min-width: 40px;
    display: inline-block;
    text-align: center;
}

.position-singles {
    background-color: #5a9aa8;
}

.position-doubles {
    background-color: #7a6b99;
}

.position-ad {
    background-color: #c9956c;
}

.player-link {
    cursor: pointer;
    color: inherit;
    text-decoration: none;
}

.player-link:hover {
    text-decoration: underline;
    color: #000;
}

/* Team box styles */
.team-box {
    border-radius: 12px;
    padding: 1.25rem;
    position: relative;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.winner-box {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.15) 0%, rgba(40, 167, 69, 0.25) 100%);
    border-color: #28a745;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.winner-box .team-name {
    color: #1e7e34;
    font-weight: 700;
    font-size: 1.25rem;
}

.team-icon {
    display: block;
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
}

.loser-box {
    background: rgba(108, 117, 125, 0.08);
    border-color: #dee2e6;
}

.loser-box .team-name {
    color: #6c757d;
    font-weight: 500;
}

.result-box {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    border: 2px solid #adb5bd;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.result-score {
    font-size: 1.75rem;
    font-weight: 800;
    color: #212529;
}

.result-legs {
    font-size: 1rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.draw-box {
    background: rgba(255, 193, 7, 0.1);
    border-color: #ffc107;
}

.draw-box .team-name {
    color: #856404;
    font-weight: 600;
}

.running-score {
    font-weight: 700;
    color: #fff;
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    font-size: 0.95rem;
    box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
}

.avg-badge {
    font-weight: 700;
    color: #495057;
}

/* Mobile styles */
@media (max-width: 767px) {
    .match-info-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
    }

    .match-info-badges .badge {
        font-size: 0.75rem !important;
        padding: 0.4rem 0.6rem !important;
        margin: 0 !important;
    }

    .team-box {
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .team-icon {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
    }

    .winner-box .team-name,
    .loser-box .team-name,
    .draw-box .team-name {
        font-size: 1rem;
    }

    .result-box {
        padding: 0.75rem 1rem;
        margin: 0.5rem 0;
    }

    .result-score {
        font-size: 1.5rem;
    }

    .sub-match-row td {
        padding: 0.6rem 0.4rem;
        font-size: 0.85rem;
    }

    .position-badge {
        min-width: 32px;
        font-size: 0.8rem;
        padding: 0.25rem 0.4rem;
    }

    .running-score {
        font-size: 0.8rem;
        padding: 0.2rem 0.4rem;
    }

    .click-indicator {
        font-size: 1.2rem;
    }

    .avg-badge {
        font-size: 0.8rem;
    }

    .table thead th {
        font-size: 0.75rem;
        padding: 0.5rem 0.3rem;
    }
}
</style>

<script>
// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const matchId = urlParams.get('match_id');

function navigateToPlayer(playerName, e) {
    if (e) e.stopPropagation();
    if (!playerName) return;
    try {
        window.location.href = '/?player=' + encodeURIComponent(playerName);
    } catch (error) {
        console.error('Navigation error:', error);
    }
}

function navigateToSubMatch(subMatchId, playerName) {
    if (!subMatchId) return;
    try {
        if (playerName && playerName.trim()) {
            // Get first player name if multiple (for doubles)
            const firstPlayer = playerName.split(' / ')[0].trim();
            window.location.href = '/sub_match_throws?sub_match_id=' + subMatchId + '&player_name=' + encodeURIComponent(firstPlayer);
        } else {
            window.location.href = '/sub_match_throws?sub_match_id=' + subMatchId;
        }
    } catch (error) {
        console.error('Navigation error:', error);
    }
}

function makePlayerNameClickable(playerName) {
    if (!playerName || playerName.trim() === '') {
        return '<span class="text-muted">-</span>';
    }

    if (playerName.includes(' / ')) {
        // Handle multiple players
        const players = playerName.split(' / ');
        return players.map(player => {
            const trimmedPlayer = player.trim();
            const escapedName = trimmedPlayer.replace(/'/g, "\\'");
            return `<span class="player-link" onclick="navigateToPlayer('${escapedName}', event)" title="Klicka for att se ${trimmedPlayer}">${trimmedPlayer}</span>`;
        }).join(' / ');
    } else {
        const escapedName = playerName.replace(/'/g, "\\'");
        return `<span class="player-link" onclick="navigateToPlayer('${escapedName}', event)" title="Klicka for att se ${playerName}">${playerName}</span>`;
    }
}

function getPositionBadgeClass(position) {
    if (position.startsWith('S')) return 'position-singles';
    if (position.startsWith('D')) return 'position-doubles';
    if (position === 'AD') return 'position-ad';
    return 'bg-secondary';
}

async function loadMatchOverview() {
    if (!matchId) {
        document.getElementById('error-message').innerHTML = 'Saknar match_id i URL';
        document.getElementById('error-message').classList.remove('d-none');
        document.getElementById('loading').classList.add('d-none');
        return;
    }

    try {
        const response = await fetch(`/api/match/${matchId}/overview`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Kunde inte ladda matchdata');
        }

        displayMatchOverview(data);
    } catch (error) {
        document.getElementById('error-message').innerHTML = `Fel: ${error.message}`;
        document.getElementById('error-message').classList.remove('d-none');
    } finally {
        document.getElementById('loading').classList.add('d-none');
    }
}

function displayMatchOverview(data) {
    try {
        if (!data || !data.match_info) {
            throw new Error('Ingen matchdata mottagen');
        }

        const matchInfo = data.match_info;
        let subMatches = data.sub_matches || [];

    // Filter out AD if it wasn't actually played (0-0 legs)
    subMatches = subMatches.filter(sm => {
        if (sm.position !== 'AD') return true;
        // Only keep AD if it was actually played (at least one team has legs)
        return sm.team1_legs > 0 || sm.team2_legs > 0;
    });

    // Update page title
    document.title = `${matchInfo.team1_name} vs ${matchInfo.team2_name}`;

    // Determine winner based on sub-match wins
    const team1Won = data.team1_sub_wins > data.team2_sub_wins;
    const team2Won = data.team2_sub_wins > data.team1_sub_wins;
    const isDraw = data.team1_sub_wins === data.team2_sub_wins;

    // Check who won AD (for draws)
    const adMatch = subMatches.find(sm => sm.position === 'AD');
    const team1WonAD = adMatch && adMatch.team1_legs > adMatch.team2_legs;
    const team2WonAD = adMatch && adMatch.team2_legs > adMatch.team1_legs;

    const team1BoxClass = team1Won ? 'team-box winner-box' :
                         team2Won ? 'team-box loser-box' :
                         'team-box draw-box';
    const team2BoxClass = team2Won ? 'team-box winner-box' :
                         team1Won ? 'team-box loser-box' :
                         'team-box draw-box';

    // Emojis: trophy for winner, sad face for loser
    // For draws: happy face for AD winner, disappointed for AD loser, handshake if no AD
    let team1Icon, team2Icon;
    if (team1Won) {
        team1Icon = '&#129395;'; // party face
        team2Icon = '&#128546;'; // sad
    } else if (team2Won) {
        team1Icon = '&#128546;'; // sad
        team2Icon = '&#129395;'; // party face
    } else {
        // Draw - check AD winner
        if (team1WonAD) {
            team1Icon = '&#128524;'; // relieved face
            team2Icon = '&#128532;'; // disappointed
        } else if (team2WonAD) {
            team1Icon = '&#128532;'; // disappointed
            team2Icon = '&#128524;'; // relieved face
        } else {
            team1Icon = '&#129309;'; // handshake
            team2Icon = '&#129309;'; // handshake
        }
    }

    // Match header - include both sub-match result and leg result
    const matchHeader = document.getElementById('match-header');
    matchHeader.innerHTML = `
        <div class="text-center mb-3 match-info-badges">
            <span class="badge bg-secondary fs-6 px-3 py-2">${matchInfo.match_date ? new Date(matchInfo.match_date).toLocaleDateString('sv-SE') : 'Okant datum'}</span>
            <span class="badge bg-info fs-6 px-3 py-2">${matchInfo.season || ''}</span>
            <span class="badge bg-primary fs-6 px-3 py-2">${matchInfo.division || ''}</span>
        </div>
        <div class="row text-center mb-4 align-items-center">
            <div class="col-md-5">
                <div class="${team1BoxClass}">
                    <span class="team-icon">${team1Icon}</span>
                    <h5 class="team-name mb-0">${matchInfo.team1_name}</h5>
                </div>
            </div>
            <div class="col-md-2 d-flex align-items-center justify-content-center">
                <div class="result-box">
                    <div class="result-score">${data.team1_sub_wins} - ${data.team2_sub_wins}</div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="${team2BoxClass}">
                    <span class="team-icon">${team2Icon}</span>
                    <h5 class="team-name mb-0">${matchInfo.team2_name}</h5>
                </div>
            </div>
        </div>
    `;

    // Sub-matches table
    const tableContainer = document.getElementById('sub-matches-table');
    let tableHtml = `
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th class="text-center" style="width: 50px;">Match</th>
                    <th class="text-end">${matchInfo.team1_name}</th>
                    <th class="text-center" style="width: 70px;">Resultat</th>
                    <th>${matchInfo.team2_name}</th>
                    <th class="text-center" style="width: 70px;">St√§llning</th>
                    <th style="width: 30px;"></th>
                </tr>
            </thead>
            <tbody>
    `;

    // Track running score
    let runningTeam1Wins = 0;
    let runningTeam2Wins = 0;

    subMatches.forEach(sm => {
        const team1Won = sm.team1_legs > sm.team2_legs;
        const team2Won = sm.team2_legs > sm.team1_legs;
        const notPlayed = sm.team1_legs === 0 && sm.team2_legs === 0 && !sm.team1_players && !sm.team2_players;

        // Update running score
        if (team1Won) runningTeam1Wins++;
        if (team2Won) runningTeam2Wins++;

        const team1CellClass = team1Won ? 'winner-cell' : (team2Won ? 'loser-cell' : '');
        const team2CellClass = team2Won ? 'winner-cell' : (team1Won ? 'loser-cell' : '');

        const badgeClass = getPositionBadgeClass(sm.position);

        const resultDisplay = notPlayed ? '-' : `${sm.team1_legs}-${sm.team2_legs}`;
        const runningScoreDisplay = notPlayed ? '-' : `${runningTeam1Wins}-${runningTeam2Wins}`;

        // Format player names with averages (plain text, no links)
        const team1PlayerDisplay = sm.team1_players
            ? `${sm.team1_players}${sm.team1_avg ? `<br><span class="avg-badge">${sm.team1_avg}</span>` : ''}`
            : '<span class="text-muted">-</span>';

        const team2PlayerDisplay = sm.team2_players
            ? `${sm.team2_players}${sm.team2_avg ? `<br><span class="avg-badge">${sm.team2_avg}</span>` : ''}`
            : '<span class="text-muted">-</span>';

        tableHtml += `
            <tr class="sub-match-row" onclick="navigateToSubMatch(${sm.id}, '${(sm.team1_players || '').replace(/'/g, "\\'")}')">
                <td class="text-center align-middle">
                    <span class="badge ${badgeClass} position-badge">${sm.position}</span>
                </td>
                <td class="text-end ${team1CellClass} align-middle">
                    ${team1PlayerDisplay}
                </td>
                <td class="text-center fw-bold align-middle">
                    ${resultDisplay}
                </td>
                <td class="${team2CellClass} align-middle">
                    ${team2PlayerDisplay}
                </td>
                <td class="text-center align-middle">
                    <span class="running-score">${runningScoreDisplay}</span>
                </td>
                <td class="text-center align-middle">
                    <span class="click-indicator">‚Ä∫</span>
                </td>
            </tr>
        `;
    });

    tableHtml += `
            </tbody>
        </table>
    `;

    tableContainer.innerHTML = tableHtml;
    document.getElementById('match-content').classList.remove('d-none');
    } catch (error) {
        console.error('Error displaying match overview:', error);
        document.getElementById('error-message').innerHTML = 'Kunde inte visa matchdata. F√∂rs√∂k ladda om sidan.';
        document.getElementById('error-message').classList.remove('d-none');
    }
}

// Load last import info
async function loadLastImport() {
    try {
        const response = await fetch('/api/last-import');
        const data = await response.json();

        if (response.ok && data.end_time) {
            const badge = document.createElement('div');
            badge.className = 'last-update-badge';
            badge.textContent = 'Uppdaterad\n' + data.end_time.split(' ')[0];
            document.body.appendChild(badge);
        }
    } catch (error) {
        console.error('Kunde inte ladda importinfo:', error);
    }
}

// Initialize when DOM is ready
function initPage() {
    loadMatchOverview();
    loadLastImport();
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPage);
} else {
    initPage();
}
</script>
{% endblock %}
