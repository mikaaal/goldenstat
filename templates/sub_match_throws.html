{% extends "base.html" %}

{% block title %}Kastomg√•ngar{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">üé≤ Kastomg√•ngar</h1>
                <a href="/" class="btn btn-primary">‚Üê Tillbaka</a>
            </div>
            <div class="card-body">
                
                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laddar...</span>
                    </div>
                    <p class="mt-2 text-muted">Laddar kastomg√•ngar...</p>
                </div>
                
                <div id="error-message" class="alert alert-danger d-none">
                </div>
                
                <div id="throws-content" class="d-none">
                    <!-- Match info -->
                    <div id="match-info" class="card mb-4">
                        <div class="card-body bg-light">
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div id="statistics" class="card mb-4">
                        <div class="card-body bg-primary bg-opacity-10">
                        </div>
                    </div>
                    
                    <!-- Legs with throws -->
                    <div id="legs-container">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const subMatchId = urlParams.get('sub_match_id');
const playerName = urlParams.get('player_name');

if (!subMatchId || !playerName) {
    document.getElementById('error-message').innerHTML = 'Felaktiga parametrar i URL';
    document.getElementById('error-message').classList.remove('d-none');
    document.getElementById('loading').classList.add('d-none');
} else {
    loadThrowData();
}

async function loadThrowData() {
    try {
        const response = await fetch(`/api/sub_match/${subMatchId}/throws/${encodeURIComponent(playerName)}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Kunde inte ladda data');
        }
        
        displayThrowData(data);
    } catch (error) {
        document.getElementById('error-message').innerHTML = `Fel: ${error.message}`;
        document.getElementById('error-message').classList.remove('d-none');
    } finally {
        document.getElementById('loading').classList.add('d-none');
    }
}

function displayThrowData(data) {
    // Update page title
    document.title = `Kastomg√•ngar - ${data.player_name}`;
    
    // Display match info
    const matchInfo = data.sub_match_info;
    document.getElementById('match-info').querySelector('.card-body').innerHTML = `
        <h5 class="card-title mb-3">üìä Delmatch Information</h5>
        <div class="row g-3">
            <div class="col-md-3 col-6"><strong>Spelare:</strong> ${data.player_name}</div>
            <div class="col-md-3 col-6"><strong>Motst√•nd:</strong> ${data.opponent_names}</div>
            <div class="col-md-3 col-6"><strong>Typ:</strong> ${matchInfo.match_type}</div>
            <div class="col-md-3 col-6"><strong>Match:</strong> ${matchInfo.match_name}</div>
            <div class="col-md-3 col-6"><strong>Datum:</strong> ${matchInfo.match_date ? new Date(matchInfo.match_date).toLocaleDateString('sv-SE') : 'Ok√§nt'}</div>
            <div class="col-md-3 col-6"><strong>Lag 1:</strong> ${matchInfo.team1_name}</div>
            <div class="col-md-3 col-6"><strong>Lag 2:</strong> ${matchInfo.team2_name}</div>
            <div class="col-md-3 col-6"><strong>Resultat:</strong> ${matchInfo.team1_legs}-${matchInfo.team2_legs}</div>
            <div class="col-md-3 col-6"><strong>Snitt:</strong> ${matchInfo.player_avg ? matchInfo.player_avg.toFixed(2) : 'N/A'}</div>
        </div>
    `;
    
    // Display statistics for both players
    const playerStats = data.player_statistics;
    const opponentStats = data.opponent_statistics;
    
    document.getElementById('statistics').querySelector('.card-body').innerHTML = `
        <h5 class="card-title mb-3 text-center">üìà Statistik - J√§mf√∂relse</h5>
        
        <div class="row">
            <div class="col-md-6">
                <div class="border border-primary rounded p-3">
                    <h6 class="text-primary text-center mb-3">${data.player_name}</h6>
                    <div class="row g-2 text-center">
                    <div class="col-4">
                        <div class="h5 text-primary mb-0">${playerStats.total_throws}</div>
                        <small class="text-muted">Totalt kast</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 text-success mb-0">${playerStats.average_score}</div>
                        <small class="text-muted">Snitt</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 text-danger mb-0">${playerStats.max_score}</div>
                        <small class="text-muted">H√∂gsta</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 text-warning mb-0">${playerStats.legs_won}</div>
                        <small class="text-muted">Legs</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 text-info mb-0">${playerStats.throws_100_139}</div>
                        <small class="text-muted">100+</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 text-dark mb-0">${playerStats.throws_140_179}</div>
                        <small class="text-muted">140+</small>
                    </div>
                    <div class="col-4">
                        <div class="h6 text-muted mb-0">${playerStats.throws_180}</div>
                        <small class="text-muted">180</small>
                    </div>
                    <div class="col-4">
                        <div class="h6 text-primary mb-0">${playerStats.total_checkouts}</div>
                        <small class="text-muted">Checkouts</small>
                    </div>
                    <div class="col-4">
                        <div class="h6 text-secondary mb-0">${playerStats.throws_100_plus_total}</div>
                        <small class="text-muted">Tot 100+</small>
                    </div>
                    <div class="col-6">
                        <div class="h6 text-success mb-0">${playerStats.short_legs}</div>
                        <small class="text-muted">Korta legs (‚â§18 pilar)</small>
                    </div>
                    <div class="col-6">
                        <div class="h6 text-warning mb-0">${playerStats.high_finishes}</div>
                        <small class="text-muted">H√∂ga utg√•ngar (‚â•100)</small>
                    </div>
                    <div class="col-12">
                        <div class="h6 text-info mb-0">${playerStats.first_9_dart_avg}</div>
                        <small class="text-muted">F√∂rsta 9 pil</small>
                    </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="border border-danger rounded p-3">
                    <h6 class="text-danger text-center mb-3">${data.opponent_names}</h6>
                    <div class="row g-2 text-center">
                    <div class="col-4">
                        <div class="h5 text-primary mb-0">${opponentStats.total_throws}</div>
                        <small class="text-muted">Totalt kast</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 text-success mb-0">${opponentStats.average_score}</div>
                        <small class="text-muted">Snitt</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 text-danger mb-0">${opponentStats.max_score}</div>
                        <small class="text-muted">H√∂gsta</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 text-warning mb-0">${opponentStats.legs_won}</div>
                        <small class="text-muted">Legs</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 text-info mb-0">${opponentStats.throws_100_139}</div>
                        <small class="text-muted">100+</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 text-dark mb-0">${opponentStats.throws_140_179}</div>
                        <small class="text-muted">140+</small>
                    </div>
                    <div class="col-4">
                        <div class="h6 text-muted mb-0">${opponentStats.throws_180}</div>
                        <small class="text-muted">180</small>
                    </div>
                    <div class="col-4">
                        <div class="h6 text-primary mb-0">${opponentStats.total_checkouts}</div>
                        <small class="text-muted">Checkouts</small>
                    </div>
                    <div class="col-4">
                        <div class="h6 text-secondary mb-0">${opponentStats.throws_100_plus_total}</div>
                        <small class="text-muted">Tot 100+</small>
                    </div>
                    <div class="col-6">
                        <div class="h6 text-success mb-0">${opponentStats.short_legs}</div>
                        <small class="text-muted">Korta legs (‚â§18 pilar)</small>
                    </div>
                    <div class="col-6">
                        <div class="h6 text-warning mb-0">${opponentStats.high_finishes}</div>
                        <small class="text-muted">H√∂ga utg√•ngar (‚â•100)</small>
                    </div>
                    <div class="col-12">
                        <div class="h6 text-info mb-0">${opponentStats.first_9_dart_avg}</div>
                        <small class="text-muted">F√∂rsta 9 pil</small>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Display legs with throws
    let legsHtml = '<h5 class="mb-4">üéØ Legs och Kastomg√•ngar</h5>';
    
    data.legs.forEach(leg => {
        const legWonClass = leg.player_won_leg ? 'border-success' : 'border-danger';
        const legWonBg = leg.player_won_leg ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10';
        const legWonText = leg.player_won_leg ? 'VANN' : 'F√ñRLORADE';
        const legWonIcon = leg.player_won_leg ? 'üèÜ' : '‚ùå';
        const legWonBadge = leg.player_won_leg ? 'bg-success' : 'bg-danger';
        
        legsHtml += `
            <div class="card mb-4 ${legWonClass}">
                <div class="card-header ${legWonBg} d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Leg ${leg.leg_number} ${legWonIcon}</h6>
                    <span class="badge ${legWonBadge}">${legWonText}</span>
                </div>
                <div class="card-body">
                    <div class="row g-2 mb-3">
        `;
        
        // Create table-like layout with rows for each throw round
        const maxRounds = Math.max(leg.player_throws.length, leg.opponent_throws.length);
        
        legsHtml += `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th class="text-primary text-center" style="width: 40%">${data.player_name}</th>
                            <th class="text-center bg-light" style="width: 20%">Pilar</th>
                            <th class="text-danger text-center" style="width: 40%">${data.opponent_names}</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (let round = 0; round < maxRounds; round++) {
            const playerThrow = leg.player_throws[round];
            const opponentThrow = leg.opponent_throws[round];
            const dartCount = (round + 1) * 3; // 3, 6, 9, 12, etc.
            
            legsHtml += '<tr>';
            
            // Player throw
            if (playerThrow) {
                const scoreClass = getScoreClass(playerThrow.score);
                const isWinningThrow = playerThrow.score < 0;
                const displayScore = isWinningThrow ? `${Math.abs(playerThrow.score)} pilar (VANN)` : playerThrow.score;
                const winningClass = isWinningThrow ? 'bg-success bg-opacity-25' : '';
                
                legsHtml += `
                    <td class="text-center ${winningClass}">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="card ${scoreClass} px-2 py-1 me-2" style="min-width: 60px;">
                                <div class="fw-bold">${displayScore}</div>
                            </div>
                            <small class="text-muted">${playerThrow.remaining_score}</small>
                        </div>
                    </td>
                `;
            } else {
                legsHtml += '<td></td>';
            }
            
            // Dart count
            legsHtml += `<td class="text-center bg-light fw-bold">${dartCount}</td>`;
            
            // Opponent throw
            if (opponentThrow) {
                const scoreClass = getScoreClass(opponentThrow.score);
                const isWinningThrow = opponentThrow.score < 0;
                const displayScore = isWinningThrow ? `${Math.abs(opponentThrow.score)} pilar (VANN)` : opponentThrow.score;
                const winningClass = isWinningThrow ? 'bg-success bg-opacity-25' : '';
                
                legsHtml += `
                    <td class="text-center ${winningClass}">
                        <div class="d-flex justify-content-center align-items-center">
                            <small class="text-muted me-2">${opponentThrow.remaining_score}</small>
                            <div class="card ${scoreClass} px-2 py-1" style="min-width: 60px;">
                                <div class="fw-bold">${displayScore}</div>
                            </div>
                        </div>
                    </td>
                `;
            } else {
                legsHtml += '<td></td>';
            }
            
            legsHtml += '</tr>';
        }
        
        legsHtml += `
                    </tbody>
                </table>
            </div>
        `;
        
        legsHtml += `
                    </div>
                    <div class="text-muted small">
                        <strong>${data.player_name}:</strong> ${leg.player_throws.length} omg√•ngar, ${calculateTotalDarts(leg.player_throws)} pilar |
                        <strong>${data.opponent_names}:</strong> ${leg.opponent_throws.length} omg√•ngar, ${calculateTotalDarts(leg.opponent_throws)} pilar
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('legs-container').innerHTML = legsHtml;
    document.getElementById('throws-content').classList.remove('d-none');
}

function getScoreClass(score) {
    // Ignore negative scores for color classification
    const absScore = Math.abs(score);
    if (absScore >= 140) return 'bg-danger bg-opacity-25 border-danger';           // 140+ r√∂d
    if (absScore >= 100) return 'bg-warning bg-opacity-25 border-warning';         // 100-139 orange
    if (absScore >= 85) return 'bg-primary bg-opacity-25 border-primary';          // 85-99 bl√•
    if (absScore >= 61) return 'bg-warning bg-opacity-10 border-warning';          // 61-84 ljusgul
    if (absScore === 60) return 'bg-info bg-opacity-25 border-info';               // 60 ljusbl√•
    return 'bg-light border-light';                                                // <60 ingen f√§rg
}

function calculateTotalDarts(throws) {
    let totalDarts = 0;
    throws.forEach(throwData => {
        if (throwData.score < 0) {
            // Negative score means they used that many darts to win
            totalDarts += Math.abs(throwData.score);
        } else {
            // Normal throw, use darts_used (default 3 if not specified)
            totalDarts += throwData.darts_used || 3;
        }
    });
    return totalDarts;
}
</script>
{% endblock %}