{% extends "base.html" %}

{% block sticky_tabs %}
<!-- Sticky Tab Navigation -->
<div class="sticky-tabs">
    <div class="container">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/{% if league == 'riksserien' %}?league=riksserien{% endif %}">
                    üë§ Spelare
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=teams{% if league == 'riksserien' %}&league=riksserien{% endif %}">
                    üë• Lag
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/series_matches{% if league == 'riksserien' %}?league=riksserien{% endif %}">
                    üìã Seriematcher
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=stats{% if league == 'riksserien' %}&league=riksserien{% endif %}">
                    üéØ Topplistor
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=weekly{% if league == 'riksserien' %}&league=riksserien{% endif %}">
                    ‚≠ê {% if league == 'riksserien' %}Omg√•ngens b√§sta{% else %}Veckans prestationer!{% endif %}
                </a>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex flex-wrap justify-content-end gap-2">
                    <button onclick="navigateToMatchOverview()" class="btn btn-match-overview">üìã Se hela seriematchen</button>
                    <button onclick="window.history.back()" class="btn btn-outline-secondary">Tillbaka</button>
                </div>
            </div>
            <div class="card-body">
                
                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laddar...</span>
                    </div>
                    <p class="mt-2 text-muted">Laddar kastomg√•ngar...</p>
                </div>
                
                <div id="error-message" class="alert alert-danger d-none">
                </div>
                
                <div id="throws-content" class="d-none">
                    <!-- Match overview with stats -->
                    <div id="match-overview" class="mb-4">
                        <!-- This will be populated by JavaScript -->
                    </div>
                    
                    <!-- Legs with throws -->
                    <div id="legs-container">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.btn-match-overview {
    background: linear-gradient(135deg, #5a9bd5 0%, #4a87c0 100%);
    border: none;
    color: #fff;
    font-weight: 600;
}

.btn-match-overview:hover {
    background: linear-gradient(135deg, #4a8bc5 0%, #3a77b0 100%);
    color: #fff;
}

/* Stats card styling */
.stats-card {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    height: 100%;
}

.stats-card-winner {
    border: 2px solid #2e7d32;
}

.stats-card-loser {
    border: 2px solid #c62828;
}

.stats-card-draw {
    border: 2px solid #f9a825;
}

.stats-card-header {
    padding: 0.75rem 1rem;
    font-weight: 700;
    text-align: center;
    color: #fff;
}

.stats-card-winner .stats-card-header {
    background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
}

.stats-card-loser .stats-card-header {
    background: linear-gradient(135deg, #ef5350 0%, #c62828 100%);
}

.stats-card-draw .stats-card-header {
    background: linear-gradient(135deg, #ffca28 0%, #f9a825 100%);
    color: #212529;
}

.stats-card-body {
    padding: 1rem;
    background: #fff;
}

.player-names {
    font-size: 1.1rem;
    font-weight: 600;
    color: #212529;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #e9ecef;
}

.stat-highlight {
    text-align: center;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 0.75rem;
}

.stat-highlight .stat-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: #212529;
    display: block;
}

.stat-highlight .stat-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.stat-row:last-child {
    margin-bottom: 0;
}

.stat-item {
    flex: 1;
    text-align: center;
    padding: 0.25rem;
}

.stat-item .stat-value {
    font-size: 1rem;
    font-weight: 700;
    color: #212529;
    display: block;
}

.stat-item .stat-label {
    font-size: 0.65rem;
    color: #6c757d;
    display: block;
}

.result-center {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.result-score-large {
    font-size: 2.5rem;
    font-weight: 800;
    color: #212529;
}

.result-label {
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
}

.position-badge-large {
    font-size: 1.1rem;
    font-weight: 700;
    color: #fff;
    background: linear-gradient(135deg, #5a9bd5 0%, #4a87c0 100%);
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.short-set-container {
    background: linear-gradient(135deg, #ff6b6b, #ffd93d, #6bcf7f, #4d4ae8, #ff6b6b);
    background-size: 400% 400%;
    border-radius: 8px;
    padding: 4px;
    animation: shortSetGlow 2s ease-in-out infinite;
    position: relative;
    overflow: hidden;
}

.short-set-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shortSetShine 2s ease-in-out infinite;
}

.short-set-inner {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 4px;
    padding: 2px;
    position: relative;
    z-index: 1;
}

@keyframes shortSetGlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

@keyframes shortSetShine {
    0% { left: -100%; }
    100% { left: 100%; }
}

.short-set-text {
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
    font-weight: bold;
    color: #d4af37 !important;
}

.high-finish-container {
    background: linear-gradient(45deg, #ff4757, #ff6348, #ff7675, #fd79a8, #fdcb6e, #f39c12);
    background-size: 300% 300%;
    border-radius: 8px;
    padding: 4px;
    animation: highFinishPulse 1.5s ease-in-out infinite;
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
}

.high-finish-container::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
    animation: highFinishRotate 3s linear infinite;
}

.high-finish-inner {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 4px;
    padding: 2px;
    position: relative;
    z-index: 1;
}

@keyframes highFinishPulse {
    0%, 100% {
        background-position: 0% 50%;
        box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
    }
    50% {
        background-position: 100% 50%;
        box-shadow: 0 0 30px rgba(255, 71, 87, 0.8);
    }
}

@keyframes highFinishRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.high-finish-text {
    text-shadow: 0 0 8px rgba(255, 71, 87, 0.9);
    font-weight: bold;
    color: #e74c3c !important;
}
</style>

<script>
// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const subMatchId = urlParams.get('sub_match_id');
const teamNumber = urlParams.get('team') || '1';
let playerName = null;


function pluralizeDarts(count) {
    return count === 1 ? 'pil' : 'pilar';
}

function makePlayerNameClickable(playerName, isDoubles = false) {
    // Always check if the string contains multiple players separated by ' / '
    if (playerName.includes(' / ')) {
        // Handle multiple players - make each player individually clickable
        const players = playerName.split(' / ');
        return players.map(player => {
            const trimmedPlayer = player.trim();
            const escapedName = trimmedPlayer.replace(/'/g, "\\'");
            return `<span class="player-link" onclick="navigateToPlayer('${escapedName}')" title="Klicka f√∂r att se ${trimmedPlayer}">${trimmedPlayer}</span>`;
        }).join(' / ');
    } else {
        // Single player
        const escapedName = playerName.replace(/'/g, "\\'");
        return `<span class="player-link" onclick="navigateToPlayer('${escapedName}')" title="Klicka f√∂r att se ${playerName}">${playerName}</span>`;
    }
}

function navigateToPlayer(playerName) {
    // Navigate back to main page and trigger search
    navigateTo(`/?player=${encodeURIComponent(playerName)}`);
}

async function navigateToMatchOverview() {
    if (!subMatchId) {
        alert('Kan inte navigera: saknar sub_match_id');
        return;
    }

    try {
        const response = await fetch(`/api/sub_match/${subMatchId}/match_id`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Kunde inte hamta match-id');
        }

        navigateTo(`/match_overview?match_id=${data.match_id}`);
    } catch (error) {
        console.error('Error navigating to match overview:', error);
        alert('Kunde inte navigera till matchoversikt: ' + error.message);
    }
}


async function initPage() {
    if (!subMatchId) {
        document.getElementById('error-message').innerHTML = 'Felaktiga parametrar i URL';
        document.getElementById('error-message').classList.remove('d-none');
        document.getElementById('loading').classList.add('d-none');
    } else {
        // Load match info first to show correct player names and determine player
        const matchData = await loadMatchInfo();

        // Determine player name from team participants
        if (matchData) {
            const teamPlayers = teamNumber === '2' ? matchData.team2_players : matchData.team1_players;
            if (teamPlayers && teamPlayers.length > 0) {
                playerName = teamPlayers[0].name;
            }
        }

        // Load detailed throw data
        if (playerName) {
            loadThrowData();
        } else {
            document.getElementById('loading').classList.add('d-none');
        }
    }
}

// Initialize page
initPage();

async function loadMatchInfo() {
    try {
        const response = await fetch(`/api/sub_match/${subMatchId}`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Kunde inte ladda matchinfo');
        }

        displayMatchInfo(data);
        return data;
    } catch (error) {
        console.error('Error loading match info:', error);
        return null;
    }
}

function displayMatchInfo(data) {
    // Show the throws-content div
    document.getElementById('throws-content').classList.remove('d-none');

    // Update match display with canonical player names
    const matchInfo = data.sub_match_info;
    const team1Players = data.team1_players.map(p => p.name).join(' / ');
    const team2Players = data.team2_players.map(p => p.name).join(' / ');

    // Determine winner
    const team1Won = matchInfo.team1_legs > matchInfo.team2_legs;
    const team2Won = matchInfo.team2_legs > matchInfo.team1_legs;

    // Parse position from match_name (e.g., "Team A vs Team B Doubles1" -> "D1")
    function parseMatchPosition(matchName) {
        if (!matchName) return '';
        if (matchName.includes(' AD')) return 'AD';
        const singlesMatch = matchName.match(/Singles(\d+)/);
        if (singlesMatch) return 'S' + singlesMatch[1];
        const doublesMatch = matchName.match(/Doubles(\d+)/);
        if (doublesMatch) return 'D' + doublesMatch[1];
        return '';
    }

    const position = parseMatchPosition(matchInfo.match_name);

    // Store team player data globally for use in displayThrowData
    window.matchTeamData = {
        team1_name: matchInfo.team1_name,
        team2_name: matchInfo.team2_name,
        team1_players: team1Players,
        team2_players: team2Players,
        team1_legs: matchInfo.team1_legs,
        team2_legs: matchInfo.team2_legs,
        team1_won: team1Won,
        team2_won: team2Won,
        position: position
    };

    // Match overview will be populated by displayThrowData with statistics
}

async function loadThrowData() {
    try {
        const response = await fetch(`/api/sub_match/${subMatchId}/throws/${encodeURIComponent(playerName)}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Kunde inte ladda data');
        }
        
        displayThrowData(data);
    } catch (error) {
        document.getElementById('error-message').innerHTML = `Fel: ${error.message}`;
        document.getElementById('error-message').classList.remove('d-none');
    } finally {
        document.getElementById('loading').classList.add('d-none');
    }
}

function displayThrowData(data) {
    // Update page title
    document.title = `Kastomg√•ngar - ${data.player_name}`;
    
    // Display match info
    const matchInfo = data.sub_match_info;
    // Display statistics for both players
    const playerStats = data.player_statistics;
    const opponentStats = data.opponent_statistics;
    
    // Use consistent team logic - determine which team the current player belongs to
    const playerTeamNumber = data.sub_match_info.team_number;
    const isPlayerTeam1 = playerTeamNumber === 1;
    
    // Determine statistics and names for each team position
    const team1Stats = isPlayerTeam1 ? playerStats : opponentStats;
    const team2Stats = isPlayerTeam1 ? opponentStats : playerStats;
    
    // Determine card classes based on winner (sub-matches always have a winner)
    const team1CardClass = window.matchTeamData.team1_won ? 'stats-card-winner' : 'stats-card-loser';
    const team2CardClass = window.matchTeamData.team2_won ? 'stats-card-winner' : 'stats-card-loser';

    const team1Icon = window.matchTeamData.team1_won ? 'ü•≥' : 'üò¢';
    const team2Icon = window.matchTeamData.team2_won ? 'ü•≥' : 'üò¢';

    const matchOverviewHtml = `
        <div class="row g-3 align-items-stretch">
            <div class="col-md-5">
                <div class="stats-card ${team1CardClass}">
                    <div class="stats-card-header">
                        <span class="me-2">${team1Icon}</span>
                        ${window.matchTeamData.team1_name}
                    </div>
                    <div class="stats-card-body">
                        <div class="player-names text-center">${window.matchTeamData.team1_players}</div>
                        <div class="stat-item stat-highlight">
                            <span class="stat-value">${team1Stats.average_score ? parseFloat(team1Stats.average_score).toFixed(2) : 'N/A'}</span>
                            <span class="stat-label">Snitt</span>
                        </div>
                        <div class="stat-row">
                            <div class="stat-item">
                                <span class="stat-value">${team1Stats.throws_100_139}</span>
                                <span class="stat-label">100+</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${team1Stats.throws_140_179}</span>
                                <span class="stat-label">140+</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${team1Stats.throws_180}</span>
                                <span class="stat-label">180</span>
                            </div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-item">
                                <span class="stat-value">${team1Stats.first_9_dart_avg}</span>
                                <span class="stat-label">F√∂rsta 9</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${team1Stats.short_legs_detail && team1Stats.short_legs_detail.length > 0 ? team1Stats.short_legs_detail.join(', ') : '-'}</span>
                                <span class="stat-label">Korta legs</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${team1Stats.high_finishes_detail && team1Stats.high_finishes_detail.length > 0 ? team1Stats.high_finishes_detail.join(', ') : '-'}</span>
                                <span class="stat-label">H√∂ga utg.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-2">
                <div class="result-center h-100">
                    ${window.matchTeamData.position ? `<div class="position-badge-large">${window.matchTeamData.position}</div>` : ''}
                    <div class="result-score-large">${window.matchTeamData.team1_legs} - ${window.matchTeamData.team2_legs}</div>
                    <div class="result-label">Resultat</div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="stats-card ${team2CardClass}">
                    <div class="stats-card-header">
                        <span class="me-2">${team2Icon}</span>
                        ${window.matchTeamData.team2_name}
                    </div>
                    <div class="stats-card-body">
                        <div class="player-names text-center">${window.matchTeamData.team2_players}</div>
                        <div class="stat-item stat-highlight">
                            <span class="stat-value">${team2Stats.average_score ? parseFloat(team2Stats.average_score).toFixed(2) : 'N/A'}</span>
                            <span class="stat-label">Snitt</span>
                        </div>
                        <div class="stat-row">
                            <div class="stat-item">
                                <span class="stat-value">${team2Stats.throws_100_139}</span>
                                <span class="stat-label">100+</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${team2Stats.throws_140_179}</span>
                                <span class="stat-label">140+</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${team2Stats.throws_180}</span>
                                <span class="stat-label">180</span>
                            </div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-item">
                                <span class="stat-value">${team2Stats.first_9_dart_avg}</span>
                                <span class="stat-label">F√∂rsta 9</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${team2Stats.short_legs_detail && team2Stats.short_legs_detail.length > 0 ? team2Stats.short_legs_detail.join(', ') : '-'}</span>
                                <span class="stat-label">Korta legs</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${team2Stats.high_finishes_detail && team2Stats.high_finishes_detail.length > 0 ? team2Stats.high_finishes_detail.join(', ') : '-'}</span>
                                <span class="stat-label">H√∂ga utg.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('match-overview').innerHTML = matchOverviewHtml;
    
    // Display legs with throws  
    let legsHtml = '';
    
    data.legs.forEach(leg => {
        const winningTeamName = leg.player_won_leg ?
            (isPlayerTeam1 ? window.matchTeamData.team1_name : window.matchTeamData.team2_name) :
            (isPlayerTeam1 ? window.matchTeamData.team2_name : window.matchTeamData.team1_name);
        
        
        legsHtml += `
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Leg ${leg.leg_number}</h6>
                        <span class="badge bg-success">${winningTeamName}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-2 mb-3">
        `;
        
        // Create table-like layout with rows for each throw round
        const maxRounds = Math.max(leg.player_throws.length, leg.opponent_throws.length);
        
        legsHtml += `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th class="text-primary text-center" style="width: 40%">${makePlayerNameClickable(window.matchTeamData.team1_players)}</th>
                            <th class="text-center bg-light" style="width: 20%">Pilar</th>
                            <th class="text-danger text-center" style="width: 40%">${makePlayerNameClickable(window.matchTeamData.team2_players)}</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (let round = 0; round < maxRounds; round++) {
            const playerThrow = leg.player_throws[round];
            const opponentThrow = leg.opponent_throws[round];
            const dartCount = (round + 1) * 3; // 3, 6, 9, 12, etc.
            
            // Determine which throw goes in which column based on team positions
            const team1Throw = isPlayerTeam1 ? playerThrow : opponentThrow;
            const team2Throw = isPlayerTeam1 ? opponentThrow : playerThrow;
            const team1ThrowsArray = isPlayerTeam1 ? leg.player_throws : leg.opponent_throws;
            const team2ThrowsArray = isPlayerTeam1 ? leg.opponent_throws : leg.player_throws;
            
            legsHtml += '<tr>';
            
            // Team 1 throw (left column)
            if (team1Throw) {
                const scoreClass = getScoreClass(team1Throw.score);
                const isWinningThrow = team1Throw.remaining_score === 0;
                const displayScore = isWinningThrow ? `üèÜ ${team1Throw.darts_used || 3} ${pluralizeDarts(team1Throw.darts_used || 3)}` : team1Throw.score;
                const winningClass = isWinningThrow ? 'bg-success bg-opacity-25' : '';

                let dartInfo = '';
                let containerClass = 'd-flex justify-content-center align-items-center';
                let textClass = 'text-muted';
                let isSpecial = false;
                let isShort = false;
                let isHigh = false;

                if (isWinningThrow) {
                    const totalDarts = calculateTotalDarts(team1ThrowsArray);
                    isShort = isShortSet(totalDarts);
                    isHigh = isHighFinish(team1Throw.score);

                    const shortSetIndicator = isShort ? ' ‚ö°' : '';
                    const highFinishIndicator = isHigh ? ' üî•' : '';
                    dartInfo = `üéØ ${totalDarts} ${pluralizeDarts(totalDarts)}${shortSetIndicator}${highFinishIndicator}`;

                    if (isShort) {
                        containerClass = 'short-set-container';
                        textClass = 'short-set-text';
                        isSpecial = true;
                    } else if (isHigh) {
                        containerClass = 'high-finish-container';
                        textClass = 'high-finish-text';
                        isSpecial = true;
                    }
                } else {
                    dartInfo = team1Throw.remaining_score;
                }

                const innerContent = `
                    <div class="card ${scoreClass} px-2 py-1 me-2" style="min-width: 60px;">
                        <div class="fw-bold">${displayScore}</div>
                    </div>
                    <small class="${textClass}">${dartInfo}</small>
                `;

                legsHtml += `
                    <td class="text-center ${winningClass}">
                        <div class="${containerClass}">
                            ${isWinningThrow && isSpecial ?
                                `<div class="${isShort ? 'short-set-inner' : 'high-finish-inner'} d-flex justify-content-center align-items-center">${innerContent}</div>` :
                                innerContent
                            }
                        </div>
                    </td>
                `;
            } else {
                legsHtml += '<td></td>';
            }
            
            // Dart count
            legsHtml += `<td class="text-center bg-light fw-bold">${dartCount}</td>`;
            
            // Team 2 throw (right column)
            if (team2Throw) {
                const scoreClass = getScoreClass(team2Throw.score);
                const isWinningThrow = team2Throw.remaining_score === 0;
                const displayScore = isWinningThrow ? `üèÜ ${team2Throw.darts_used || 3} ${pluralizeDarts(team2Throw.darts_used || 3)}` : team2Throw.score;
                const winningClass = isWinningThrow ? 'bg-success bg-opacity-25' : '';

                let dartInfo = '';
                let containerClass = 'd-flex justify-content-center align-items-center';
                let textClass = 'text-muted me-2';
                let isSpecial = false;
                let isShort = false;
                let isHigh = false;

                if (isWinningThrow) {
                    const totalDarts = calculateTotalDarts(team2ThrowsArray);
                    isShort = isShortSet(totalDarts);
                    isHigh = isHighFinish(team2Throw.score);

                    const shortSetIndicator = isShort ? ' ‚ö°' : '';
                    const highFinishIndicator = isHigh ? ' üî•' : '';
                    dartInfo = `üéØ ${totalDarts} ${pluralizeDarts(totalDarts)}${shortSetIndicator}${highFinishIndicator}`;

                    if (isShort) {
                        containerClass = 'short-set-container';
                        textClass = 'short-set-text me-2';
                        isSpecial = true;
                    } else if (isHigh) {
                        containerClass = 'high-finish-container';
                        textClass = 'high-finish-text me-2';
                        isSpecial = true;
                    }
                } else {
                    dartInfo = team2Throw.remaining_score;
                }

                const innerContent = `
                    <small class="${textClass}">${dartInfo}</small>
                    <div class="card ${scoreClass} px-2 py-1" style="min-width: 60px;">
                        <div class="fw-bold">${displayScore}</div>
                    </div>
                `;

                legsHtml += `
                    <td class="text-center ${winningClass}">
                        <div class="${containerClass}">
                            ${isWinningThrow && isSpecial ?
                                `<div class="${isShort ? 'short-set-inner' : 'high-finish-inner'} d-flex justify-content-center align-items-center">${innerContent}</div>` :
                                innerContent
                            }
                        </div>
                    </td>
                `;
            } else {
                legsHtml += '<td></td>';
            }
            
            legsHtml += '</tr>';
        }
        
        legsHtml += `
                    </tbody>
                </table>
            </div>
        `;
        
        legsHtml += `
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('legs-container').innerHTML = legsHtml;
    document.getElementById('throws-content').classList.remove('d-none');
}

function getScoreClass(score) {
    // Ignore negative scores for color classification
    const absScore = Math.abs(score);
    if (absScore === 180) return 'score-180';              // 180 - b√§sta f√§rgen (gr√∂n gradient)
    if (absScore >= 140) return 'score-140-179';           // 140-179 - √§nnu mer positiv (bl√• gradient)  
    if (absScore >= 101) return 'score-101-139';           // 101-139 - v√§ldigt positiv (ljusbl√• gradient)
    if (absScore === 100) return 'score-100';              // 100 - positiv (gul gradient)
    if (absScore >= 61) return 'score-61-99';              // 61-99 - ganska positiv (orange/gul)
    if (absScore === 60) return 'score-60';               // 60 - bra (gr√∂n)  
    return 'score-under-60';                               // <60 - neutral f√§rg
}

function calculateTotalDarts(throws) {
    let totalDarts = 0;
    throws.forEach(throwData => {
        if (throwData.score < 0) {
            // Negative score means they used that many darts to win
            totalDarts += Math.abs(throwData.score);
        } else {
            // Normal throw, use darts_used (default 3 if not specified)
            totalDarts += throwData.darts_used || 3;
        }
    });
    return totalDarts;
}

function isShortSet(totalDarts) {
    return totalDarts <= 18;
}

function isHighFinish(score) {
    return Math.abs(score) >= 100;
}

</script>
{% endblock %}