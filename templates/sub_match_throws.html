{% extends "base.html" %}

{% block title %}Kastomg√•ngar{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">Kastomg√•ngar</h1>
                <button onclick="window.history.back()" class="btn btn-primary">‚Üê Tillbaka</button>
            </div>
            <div class="card-body">
                
                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laddar...</span>
                    </div>
                    <p class="mt-2 text-muted">Laddar kastomg√•ngar...</p>
                </div>
                
                <div id="error-message" class="alert alert-danger d-none">
                </div>
                
                <div id="throws-content" class="d-none">
                    <!-- Match info -->
                    <div id="match-info" class="card mb-4">
                        <div class="card-body bg-light">
                        </div>
                    </div>
                    
                    <!-- Tips f√∂r scrollning -->
                    <div class="alert alert-info alert-sm mb-4" role="alert">
                        <div class="d-flex align-items-center">
                            <span class="me-2">üí°</span>
                            <small><strong>Tips:</strong> Scrolla ner f√∂r att se detaljerade leg-f√∂r-leg statistik och alla kastomg√•ngar f√∂r denna match.</small>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div id="statistics" class="card mb-4">
                        <div class="card-body bg-primary bg-opacity-10">
                        </div>
                    </div>
                    
                    <!-- Legs with throws -->
                    <div id="legs-container">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const subMatchId = urlParams.get('sub_match_id');
const playerName = urlParams.get('player_name');


function pluralizeDarts(count) {
    return count === 1 ? 'pil' : 'pilar';
}

function makePlayerNameClickable(playerName, isDoubles = false) {
    const escapedName = playerName.replace(/'/g, "\\'");
    if (isDoubles && (playerName.includes(' + ') || playerName.includes(' / '))) {
        // Handle doubles - make each player clickable
        const separator = playerName.includes(' + ') ? ' + ' : ' / ';
        const players = playerName.split(separator);
        const newSeparator = ' / ';
        return players.map(player => 
            `<span class="player-link" onclick="navigateToPlayer('${player.trim().replace(/'/g, "\\'")}')" title="Klicka f√∂r att se ${player.trim()}">${player.trim()}</span>`
        ).join(newSeparator);
    } else {
        return `<span class="player-link" onclick="navigateToPlayer('${escapedName}')" title="Klicka f√∂r att se ${playerName}">${playerName}</span>`;
    }
}

function navigateToPlayer(playerName) {
    // Navigate back to main page and trigger search
    window.location.href = `/?player=${encodeURIComponent(playerName)}`;
}


async function initPage() {
    if (!subMatchId || !playerName) {
        document.getElementById('error-message').innerHTML = 'Felaktiga parametrar i URL';
        document.getElementById('error-message').classList.remove('d-none');
        document.getElementById('loading').classList.add('d-none');
    } else {
        loadThrowData();
    }
}

// Initialize page
initPage();

async function loadThrowData() {
    try {
        const response = await fetch(`/api/sub_match/${subMatchId}/throws/${encodeURIComponent(playerName)}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Kunde inte ladda data');
        }
        
        displayThrowData(data);
    } catch (error) {
        document.getElementById('error-message').innerHTML = `Fel: ${error.message}`;
        document.getElementById('error-message').classList.remove('d-none');
    } finally {
        document.getElementById('loading').classList.add('d-none');
    }
}

function displayThrowData(data) {
    // Update page title
    document.title = `Kastomg√•ngar - ${data.player_name}`;
    
    // Display match info
    const matchInfo = data.sub_match_info;
    // Function to format match name to short format
    function formatMatchName(matchName, matchType) {
        if (!matchName) return 'N/A';
        
        // Check for AD first (before other doubles)
        if (matchName.includes(' AD')) {
            return 'AD';
        }
        
        // Extract Singles1, Doubles3 etc from match name
        if (matchName.includes('Singles')) {
            const match = matchName.match(/Singles(\d+)/);
            return match ? `S${match[1]}` : 'S1';
        } else if (matchName.includes('Doubles')) {
            const match = matchName.match(/Doubles(\d+)/);
            return match ? `D${match[1]}` : 'D1';
        }
        
        // Fallback
        return matchType === 'Singles' ? 'S1' : 'D1';
    }

    const matchInfoHtml = `
        <div class="text-center mb-3">
            <div class="badge bg-secondary fs-6 px-3 py-2">${matchInfo.match_date ? new Date(matchInfo.match_date).toLocaleDateString('sv-SE') : 'Ok√§nt datum'}</div>
        </div>
        <h5 class="card-title mb-3 text-center">üìä ${formatMatchName(matchInfo.match_name, matchInfo.match_type)}</h5>
        <div class="row g-3">
            <div class="col-md-6">
                <div class="text-center">
                    <h6 class="text-primary mb-2">${matchInfo.team1_name}</h6>
                    <div>${makePlayerNameClickable(data.player_name)}${data.teammate_names ? ' / ' + makePlayerNameClickable(data.teammate_names) : ''}</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="text-center">
                    <h6 class="text-danger mb-2">${matchInfo.team2_name}</h6>
                    <div>${makePlayerNameClickable(data.opponent_names, true)}</div>
                </div>
            </div>
            <div class="col-12 text-center"><strong>Resultat:</strong> ${matchInfo.team1_legs}-${matchInfo.team2_legs}</div>
        </div>
    `;
    document.getElementById('match-info').querySelector('.card-body').innerHTML = matchInfoHtml;
    
    // Display statistics for both players
    const playerStats = data.player_statistics;
    const opponentStats = data.opponent_statistics;
    
    const statisticsHtml = `
        <h5 class="card-title mb-3 text-center">üìà Statistik - J√§mf√∂relse</h5>
        
        <div class="row">
            <div class="col-md-6">
                <div class="border border-primary rounded p-3">
                    <h6 class="text-primary text-center mb-3">${makePlayerNameClickable(data.player_name)}${data.teammate_names ? ' / ' + makePlayerNameClickable(data.teammate_names) : ''}</h6>
                    <div class="row g-2 text-center">
                    <div class="col-4">
                        <small class="text-muted">Snitt</small>
                        <div class="h5 text-success mb-0">${playerStats.average_score ? parseFloat(playerStats.average_score).toFixed(2) : 'N/A'}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">100+</small>
                        <div class="h5 text-info mb-0">${playerStats.throws_100_139}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">140+</small>
                        <div class="h5 text-dark mb-0">${playerStats.throws_140_179}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">180</small>
                        <div class="h6 text-muted mb-0">${playerStats.throws_180}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">Tot 100+</small>
                        <div class="h6 text-secondary mb-0">${playerStats.throws_100_plus_total}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">F√∂rsta 9 pil</small>
                        <div class="h6 text-info mb-0">${playerStats.first_9_dart_avg}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Korta legs (pilar)</small>
                        <div class="h6 text-success mb-0">${playerStats.short_legs_detail && playerStats.short_legs_detail.length > 0 ? playerStats.short_legs_detail.join(', ') : '0'}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">H√∂ga utg√•ngar (po√§ng)</small>
                        <div class="h6 text-warning mb-0">${playerStats.high_finishes_detail && playerStats.high_finishes_detail.length > 0 ? playerStats.high_finishes_detail.join(', ') : '0'}</div>
                    </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="border border-danger rounded p-3">
                    <h6 class="text-danger text-center mb-3">${makePlayerNameClickable(data.opponent_names, true)}</h6>
                    <div class="row g-2 text-center">
                    <div class="col-4">
                        <small class="text-muted">Snitt</small>
                        <div class="h5 text-success mb-0">${opponentStats.average_score ? parseFloat(opponentStats.average_score).toFixed(2) : 'N/A'}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">100+</small>
                        <div class="h5 text-info mb-0">${opponentStats.throws_100_139}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">140+</small>
                        <div class="h5 text-dark mb-0">${opponentStats.throws_140_179}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">180</small>
                        <div class="h6 text-muted mb-0">${opponentStats.throws_180}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">Tot 100+</small>
                        <div class="h6 text-secondary mb-0">${opponentStats.throws_100_plus_total}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">F√∂rsta 9 pil</small>
                        <div class="h6 text-info mb-0">${opponentStats.first_9_dart_avg}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Korta legs (pilar)</small>
                        <div class="h6 text-success mb-0">${opponentStats.short_legs_detail && opponentStats.short_legs_detail.length > 0 ? opponentStats.short_legs_detail.join(', ') : '0'}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">H√∂ga utg√•ngar (po√§ng)</small>
                        <div class="h6 text-warning mb-0">${opponentStats.high_finishes_detail && opponentStats.high_finishes_detail.length > 0 ? opponentStats.high_finishes_detail.join(', ') : '0'}</div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('statistics').querySelector('.card-body').innerHTML = statisticsHtml;
    
    // Display legs with throws  
    let legsHtml = '<h5 class="mb-4">üéØ Legs och Kastomg√•ngar</h5>';
    
    data.legs.forEach(leg => {
        const legWonClass = leg.player_won_leg ? 'border-success' : 'border-danger';
        const legWonBg = leg.player_won_leg ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10';
        const legWonText = leg.player_won_leg ? 'VANN' : 'F√ñRLORADE';
        const legWonIcon = leg.player_won_leg ? 'üèÜ' : '‚ùå';
        const legWonBadge = leg.player_won_leg ? 'bg-success' : 'bg-danger';
        
        
        legsHtml += `
            <div class="card mb-4 ${legWonClass}">
                <div class="card-header ${legWonBg}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Leg ${leg.leg_number} ${legWonIcon}</h6>
                        <span class="badge ${legWonBadge}">${legWonText}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-2 mb-3">
        `;
        
        // Create table-like layout with rows for each throw round
        const maxRounds = Math.max(leg.player_throws.length, leg.opponent_throws.length);
        
        legsHtml += `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th class="text-primary text-center" style="width: 40%">${makePlayerNameClickable(data.player_name)}${data.teammate_names ? ' / ' + makePlayerNameClickable(data.teammate_names) : ''}</th>
                            <th class="text-center bg-light" style="width: 20%">Pilar</th>
                            <th class="text-danger text-center" style="width: 40%">${makePlayerNameClickable(data.opponent_names, true)}</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (let round = 0; round < maxRounds; round++) {
            const playerThrow = leg.player_throws[round];
            const opponentThrow = leg.opponent_throws[round];
            const dartCount = (round + 1) * 3; // 3, 6, 9, 12, etc.
            
            legsHtml += '<tr>';
            
            // Player throw
            if (playerThrow) {
                const scoreClass = getScoreClass(playerThrow.score);
                const isWinningThrow = playerThrow.remaining_score === 0;
                const displayScore = isWinningThrow ? `üèÜ ${playerThrow.darts_used || 3} ${pluralizeDarts(playerThrow.darts_used || 3)}` : playerThrow.score;
                const winningClass = isWinningThrow ? 'bg-success bg-opacity-25' : '';
                
                legsHtml += `
                    <td class="text-center ${winningClass}">
                        <div class="d-flex justify-content-center align-items-center">
                            <div class="card ${scoreClass} px-2 py-1 me-2" style="min-width: 60px;">
                                <div class="fw-bold">${displayScore}</div>
                            </div>
                            <small class="text-muted">${isWinningThrow ? `üéØ ${calculateTotalDarts(leg.player_throws)} ${pluralizeDarts(calculateTotalDarts(leg.player_throws))}` : playerThrow.remaining_score}</small>
                        </div>
                    </td>
                `;
            } else {
                legsHtml += '<td></td>';
            }
            
            // Dart count
            legsHtml += `<td class="text-center bg-light fw-bold">${dartCount}</td>`;
            
            // Opponent throw
            if (opponentThrow) {
                const scoreClass = getScoreClass(opponentThrow.score);
                const isWinningThrow = opponentThrow.remaining_score === 0;
                const displayScore = isWinningThrow ? `üèÜ ${opponentThrow.darts_used || 3} ${pluralizeDarts(opponentThrow.darts_used || 3)}` : opponentThrow.score;
                const winningClass = isWinningThrow ? 'bg-success bg-opacity-25' : '';
                
                legsHtml += `
                    <td class="text-center ${winningClass}">
                        <div class="d-flex justify-content-center align-items-center">
                            <small class="text-muted me-2">${isWinningThrow ? `üéØ ${calculateTotalDarts(leg.opponent_throws)} ${pluralizeDarts(calculateTotalDarts(leg.opponent_throws))}` : opponentThrow.remaining_score}</small>
                            <div class="card ${scoreClass} px-2 py-1" style="min-width: 60px;">
                                <div class="fw-bold">${displayScore}</div>
                            </div>
                        </div>
                    </td>
                `;
            } else {
                legsHtml += '<td></td>';
            }
            
            legsHtml += '</tr>';
        }
        
        legsHtml += `
                    </tbody>
                </table>
            </div>
        `;
        
        legsHtml += `
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('legs-container').innerHTML = legsHtml;
    document.getElementById('throws-content').classList.remove('d-none');
}

function getScoreClass(score) {
    // Ignore negative scores for color classification
    const absScore = Math.abs(score);
    if (absScore === 180) return 'score-180';              // 180 - b√§sta f√§rgen (gr√∂n gradient)
    if (absScore >= 140) return 'score-140-179';           // 140-179 - √§nnu mer positiv (bl√• gradient)  
    if (absScore >= 101) return 'score-101-139';           // 101-139 - v√§ldigt positiv (ljusbl√• gradient)
    if (absScore === 100) return 'score-100';              // 100 - positiv (gul gradient)
    if (absScore >= 61) return 'score-61-99';              // 61-99 - ganska positiv (orange/gul)
    if (absScore === 60) return 'score-60';               // 60 - bra (gr√∂n)  
    return 'score-under-60';                               // <60 - neutral f√§rg
}

function calculateTotalDarts(throws) {
    let totalDarts = 0;
    throws.forEach(throwData => {
        if (throwData.score < 0) {
            // Negative score means they used that many darts to win
            totalDarts += Math.abs(throwData.score);
        } else {
            // Normal throw, use darts_used (default 3 if not specified)
            totalDarts += throwData.darts_used || 3;
        }
    });
    return totalDarts;
}
</script>
{% endblock %}