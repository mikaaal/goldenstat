{% extends "base.html" %}

{% block title %}Kastomg√•ngar{% endblock %}

{% block sticky_tabs %}
<!-- Sticky Tab Navigation -->
<div class="sticky-tabs">
    <div class="container">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/">
                    üë§ Spelare
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=teams">
                    üë• Lag
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/?tab=stats">
                    üéØ Topplistor
                </a>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">Kastomg√•ngar</h1>
                <button onclick="window.history.back()" class="btn btn-primary">‚Üê Tillbaka</button>
            </div>
            <div class="card-body">
                
                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laddar...</span>
                    </div>
                    <p class="mt-2 text-muted">Laddar kastomg√•ngar...</p>
                </div>
                
                <div id="error-message" class="alert alert-danger d-none">
                </div>
                
                <div id="throws-content" class="d-none">
                    <!-- Match overview with correct player names -->
                    <div id="match-overview" class="mb-4">
                        <!-- This will be populated by JavaScript -->
                    </div>
                    
                    <!-- Match info -->
                    <div id="match-info" class="card mb-4">
                        <div class="card-body bg-light">
                        </div>
                    </div>
                    
                    <!-- Tips f√∂r scrollning -->
                    <div class="alert alert-info alert-sm mb-4" role="alert">
                        <div class="d-flex align-items-center">
                            <span class="me-2">üí°</span>
                            <small><strong>Tips:</strong> Scrolla ner f√∂r att se detaljerade leg-f√∂r-leg statistik och alla kastomg√•ngar f√∂r denna match.</small>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div id="statistics" class="card mb-4">
                        <div class="card-body bg-primary bg-opacity-10">
                        </div>
                    </div>
                    
                    <!-- Legs with throws -->
                    <div id="legs-container">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.short-set-container {
    background: linear-gradient(135deg, #ff6b6b, #ffd93d, #6bcf7f, #4d4ae8, #ff6b6b);
    background-size: 400% 400%;
    border-radius: 8px;
    padding: 4px;
    animation: shortSetGlow 2s ease-in-out infinite;
    position: relative;
    overflow: hidden;
}

.short-set-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shortSetShine 2s ease-in-out infinite;
}

.short-set-inner {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 4px;
    padding: 2px;
    position: relative;
    z-index: 1;
}

@keyframes shortSetGlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

@keyframes shortSetShine {
    0% { left: -100%; }
    100% { left: 100%; }
}

.short-set-text {
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
    font-weight: bold;
    color: #d4af37 !important;
}

.high-finish-container {
    background: linear-gradient(45deg, #ff4757, #ff6348, #ff7675, #fd79a8, #fdcb6e, #f39c12);
    background-size: 300% 300%;
    border-radius: 8px;
    padding: 4px;
    animation: highFinishPulse 1.5s ease-in-out infinite;
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
}

.high-finish-container::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
    animation: highFinishRotate 3s linear infinite;
}

.high-finish-inner {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 4px;
    padding: 2px;
    position: relative;
    z-index: 1;
}

@keyframes highFinishPulse {
    0%, 100% {
        background-position: 0% 50%;
        box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
    }
    50% {
        background-position: 100% 50%;
        box-shadow: 0 0 30px rgba(255, 71, 87, 0.8);
    }
}

@keyframes highFinishRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.high-finish-text {
    text-shadow: 0 0 8px rgba(255, 71, 87, 0.9);
    font-weight: bold;
    color: #e74c3c !important;
}
</style>

<script>
// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const subMatchId = urlParams.get('sub_match_id');
const playerName = urlParams.get('player_name');


function pluralizeDarts(count) {
    return count === 1 ? 'pil' : 'pilar';
}

function makePlayerNameClickable(playerName, isDoubles = false) {
    // Always check if the string contains multiple players separated by ' / '
    if (playerName.includes(' / ')) {
        // Handle multiple players - make each player individually clickable
        const players = playerName.split(' / ');
        return players.map(player => {
            const trimmedPlayer = player.trim();
            const escapedName = trimmedPlayer.replace(/'/g, "\\'");
            return `<span class="player-link" onclick="navigateToPlayer('${escapedName}')" title="Klicka f√∂r att se ${trimmedPlayer}">${trimmedPlayer}</span>`;
        }).join(' / ');
    } else {
        // Single player
        const escapedName = playerName.replace(/'/g, "\\'");
        return `<span class="player-link" onclick="navigateToPlayer('${escapedName}')" title="Klicka f√∂r att se ${playerName}">${playerName}</span>`;
    }
}

function navigateToPlayer(playerName) {
    // Navigate back to main page and trigger search
    window.location.href = `/?player=${encodeURIComponent(playerName)}`;
}


async function initPage() {
    if (!subMatchId) {
        document.getElementById('error-message').innerHTML = 'Felaktiga parametrar i URL';
        document.getElementById('error-message').classList.remove('d-none');
        document.getElementById('loading').classList.add('d-none');
    } else {
        // Load match info first to show correct player names
        await loadMatchInfo();
        
        // Then load detailed throw data if player is specified
        if (playerName) {
            loadThrowData();
        } else {
            document.getElementById('loading').classList.add('d-none');
        }
    }
}

// Initialize page
initPage();

async function loadMatchInfo() {
    try {
        const response = await fetch(`/api/sub_match/${subMatchId}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Kunde inte ladda matchinfo');
        }
        
        displayMatchInfo(data);
    } catch (error) {
        console.error('Error loading match info:', error);
    }
}

function displayMatchInfo(data) {
    // Show the throws-content div
    document.getElementById('throws-content').classList.remove('d-none');
    
    // Update match display with canonical player names
    const matchInfo = data.sub_match_info;
    const team1Players = data.team1_players.map(p => p.name).join(' / ');
    const team2Players = data.team2_players.map(p => p.name).join(' / ');
    
    // Store team player data globally for use in displayThrowData
    window.matchTeamData = {
        team1_name: matchInfo.team1_name,
        team2_name: matchInfo.team2_name,
        team1_players: team1Players,
        team2_players: team2Players
    };
    
    // Update the match overview display with winner/loser color coding
    const matchOverview = document.getElementById('match-overview');
    if (matchOverview) {
        // Determine winner - team with more legs wins
        const team1Won = matchInfo.team1_legs > matchInfo.team2_legs;
        const team2Won = matchInfo.team2_legs > matchInfo.team1_legs;
        const isDraw = matchInfo.team1_legs === matchInfo.team2_legs;

        // Set colors based on result
        const team1Style = team1Won ? 'border-success bg-success bg-opacity-10' :
                          team2Won ? 'border-danger bg-danger bg-opacity-10' :
                          'border-warning bg-warning bg-opacity-10';
        const team1TextColor = team1Won ? 'text-success' :
                              team2Won ? 'text-danger' :
                              'text-warning';

        const team2Style = team2Won ? 'border-success bg-success bg-opacity-10' :
                          team1Won ? 'border-danger bg-danger bg-opacity-10' :
                          'border-warning bg-warning bg-opacity-10';
        const team2TextColor = team2Won ? 'text-success' :
                              team1Won ? 'text-danger' :
                              'text-warning';

        matchOverview.innerHTML = `
            <div class="row text-center mb-4">
                <div class="col-md-5">
                    <div class="border ${team1Style} rounded p-3">
                        <h6 class="${team1TextColor} mb-2">${matchInfo.team1_name}${team1Won ? ' üèÜ' : ''}</h6>
                        <div>${team1Players}</div>
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                    <div class="text-center">
                        <div class="h4 mb-0">${matchInfo.team1_legs} - ${matchInfo.team2_legs}</div>
                        <small class="text-muted">Resultat</small>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="border ${team2Style} rounded p-3">
                        <h6 class="${team2TextColor} mb-2">${matchInfo.team2_name}${team2Won ? ' üèÜ' : ''}</h6>
                        <div>${team2Players}</div>
                    </div>
                </div>
            </div>
        `;
    }
}

async function loadThrowData() {
    try {
        const response = await fetch(`/api/sub_match/${subMatchId}/throws/${encodeURIComponent(playerName)}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Kunde inte ladda data');
        }
        
        displayThrowData(data);
    } catch (error) {
        document.getElementById('error-message').innerHTML = `Fel: ${error.message}`;
        document.getElementById('error-message').classList.remove('d-none');
    } finally {
        document.getElementById('loading').classList.add('d-none');
    }
}

function displayThrowData(data) {
    // Update page title
    document.title = `Kastomg√•ngar - ${data.player_name}`;
    
    // Display match info
    const matchInfo = data.sub_match_info;
    // Function to format match name to short format
    function formatMatchName(matchName, matchType) {
        if (!matchName) return 'N/A';
        
        // Check for AD first (before other doubles)
        if (matchName.includes(' AD')) {
            return 'AD';
        }
        
        // Extract Singles1, Doubles3 etc from match name
        if (matchName.includes('Singles')) {
            const match = matchName.match(/Singles(\d+)/);
            return match ? `S${match[1]}` : 'S1';
        } else if (matchName.includes('Doubles')) {
            const match = matchName.match(/Doubles(\d+)/);
            return match ? `D${match[1]}` : 'D1';
        }
        
        // Fallback
        return matchType === 'Singles' ? 'S1' : 'D1';
    }

    const matchInfoHtml = `
        <div class="text-center">
            <span class="badge bg-secondary fs-6 px-3 py-2 me-3">${matchInfo.match_date ? new Date(matchInfo.match_date).toLocaleDateString('sv-SE') : 'Ok√§nt datum'}</span>
            <span class="badge bg-primary fs-6 px-3 py-2">${formatMatchName(matchInfo.match_name, matchInfo.match_type)}</span>
        </div>
    `;
    document.getElementById('match-info').querySelector('.card-body').innerHTML = matchInfoHtml;
    
    // Display statistics for both players
    const playerStats = data.player_statistics;
    const opponentStats = data.opponent_statistics;
    
    // Use consistent team logic - determine which team the current player belongs to
    const playerTeamNumber = data.sub_match_info.team_number;
    const isPlayerTeam1 = playerTeamNumber === 1;
    
    // Determine statistics and names for each team position
    const team1Stats = isPlayerTeam1 ? playerStats : opponentStats;
    const team2Stats = isPlayerTeam1 ? opponentStats : playerStats;
    
    const statisticsHtml = `
        <h5 class="card-title mb-3 text-center">üìà Statistik - J√§mf√∂relse</h5>
        
        <div class="row">
            <div class="col-md-6">
                <div class="border border-primary rounded p-3">
                    <h6 class="text-primary text-center mb-3">${makePlayerNameClickable(window.matchTeamData.team1_players)}</h6>
                    <div class="row g-2 text-center">
                    <div class="col-4">
                        <small class="text-muted">Snitt</small>
                        <div class="h5 text-success mb-0">${team1Stats.average_score ? parseFloat(team1Stats.average_score).toFixed(2) : 'N/A'}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">100+</small>
                        <div class="h5 text-info mb-0">${team1Stats.throws_100_139}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">140+</small>
                        <div class="h5 text-dark mb-0">${team1Stats.throws_140_179}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">180</small>
                        <div class="h6 text-muted mb-0">${team1Stats.throws_180}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">Tot 100+</small>
                        <div class="h6 text-secondary mb-0">${team1Stats.throws_100_plus_total}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">F√∂rsta 9 pil</small>
                        <div class="h6 text-info mb-0">${team1Stats.first_9_dart_avg}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Korta legs (pilar)</small>
                        <div class="h6 text-success mb-0">${team1Stats.short_legs_detail && team1Stats.short_legs_detail.length > 0 ? team1Stats.short_legs_detail.join(', ') : '0'}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">H√∂ga utg√•ngar (po√§ng)</small>
                        <div class="h6 text-warning mb-0">${team1Stats.high_finishes_detail && team1Stats.high_finishes_detail.length > 0 ? team1Stats.high_finishes_detail.join(', ') : '0'}</div>
                    </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="border border-danger rounded p-3">
                    <h6 class="text-danger text-center mb-3">${makePlayerNameClickable(window.matchTeamData.team2_players)}</h6>
                    <div class="row g-2 text-center">
                    <div class="col-4">
                        <small class="text-muted">Snitt</small>
                        <div class="h5 text-success mb-0">${team2Stats.average_score ? parseFloat(team2Stats.average_score).toFixed(2) : 'N/A'}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">100+</small>
                        <div class="h5 text-info mb-0">${team2Stats.throws_100_139}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">140+</small>
                        <div class="h5 text-dark mb-0">${team2Stats.throws_140_179}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">180</small>
                        <div class="h6 text-muted mb-0">${team2Stats.throws_180}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">Tot 100+</small>
                        <div class="h6 text-secondary mb-0">${team2Stats.throws_100_plus_total}</div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted">F√∂rsta 9 pil</small>
                        <div class="h6 text-info mb-0">${team2Stats.first_9_dart_avg}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Korta legs (pilar)</small>
                        <div class="h6 text-success mb-0">${team2Stats.short_legs_detail && team2Stats.short_legs_detail.length > 0 ? team2Stats.short_legs_detail.join(', ') : '0'}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">H√∂ga utg√•ngar (po√§ng)</small>
                        <div class="h6 text-warning mb-0">${team2Stats.high_finishes_detail && team2Stats.high_finishes_detail.length > 0 ? team2Stats.high_finishes_detail.join(', ') : '0'}</div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('statistics').querySelector('.card-body').innerHTML = statisticsHtml;
    
    // Display legs with throws  
    let legsHtml = '<h5 class="mb-4">üéØ Legs och Kastomg√•ngar</h5>';
    
    data.legs.forEach(leg => {
        const legWonClass = leg.player_won_leg ? 'border-success' : 'border-danger';
        const legWonBg = leg.player_won_leg ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10';
        const legWonText = leg.player_won_leg ? 'VANN' : 'F√ñRLORADE';
        const legWonIcon = leg.player_won_leg ? 'üèÜ' : '‚ùå';
        const legWonBadge = leg.player_won_leg ? 'bg-success' : 'bg-danger';
        
        
        legsHtml += `
            <div class="card mb-4 ${legWonClass}">
                <div class="card-header ${legWonBg}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Leg ${leg.leg_number} ${legWonIcon}</h6>
                        <span class="badge ${legWonBadge}">${legWonText}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-2 mb-3">
        `;
        
        // Create table-like layout with rows for each throw round
        const maxRounds = Math.max(leg.player_throws.length, leg.opponent_throws.length);
        
        legsHtml += `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th class="text-primary text-center" style="width: 40%">${makePlayerNameClickable(window.matchTeamData.team1_players)}</th>
                            <th class="text-center bg-light" style="width: 20%">Pilar</th>
                            <th class="text-danger text-center" style="width: 40%">${makePlayerNameClickable(window.matchTeamData.team2_players)}</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (let round = 0; round < maxRounds; round++) {
            const playerThrow = leg.player_throws[round];
            const opponentThrow = leg.opponent_throws[round];
            const dartCount = (round + 1) * 3; // 3, 6, 9, 12, etc.
            
            // Determine which throw goes in which column based on team positions
            const team1Throw = isPlayerTeam1 ? playerThrow : opponentThrow;
            const team2Throw = isPlayerTeam1 ? opponentThrow : playerThrow;
            const team1ThrowsArray = isPlayerTeam1 ? leg.player_throws : leg.opponent_throws;
            const team2ThrowsArray = isPlayerTeam1 ? leg.opponent_throws : leg.player_throws;
            
            legsHtml += '<tr>';
            
            // Team 1 throw (left column)
            if (team1Throw) {
                const scoreClass = getScoreClass(team1Throw.score);
                const isWinningThrow = team1Throw.remaining_score === 0;
                const displayScore = isWinningThrow ? `üèÜ ${team1Throw.darts_used || 3} ${pluralizeDarts(team1Throw.darts_used || 3)}` : team1Throw.score;
                const winningClass = isWinningThrow ? 'bg-success bg-opacity-25' : '';

                let dartInfo = '';
                let containerClass = 'd-flex justify-content-center align-items-center';
                let textClass = 'text-muted';
                let isSpecial = false;
                let isShort = false;
                let isHigh = false;

                if (isWinningThrow) {
                    const totalDarts = calculateTotalDarts(team1ThrowsArray);
                    isShort = isShortSet(totalDarts);
                    isHigh = isHighFinish(team1Throw.score);

                    const shortSetIndicator = isShort ? ' ‚ö°' : '';
                    const highFinishIndicator = isHigh ? ' üî•' : '';
                    dartInfo = `üéØ ${totalDarts} ${pluralizeDarts(totalDarts)}${shortSetIndicator}${highFinishIndicator}`;

                    if (isShort) {
                        containerClass = 'short-set-container';
                        textClass = 'short-set-text';
                        isSpecial = true;
                    } else if (isHigh) {
                        containerClass = 'high-finish-container';
                        textClass = 'high-finish-text';
                        isSpecial = true;
                    }
                } else {
                    dartInfo = team1Throw.remaining_score;
                }

                const innerContent = `
                    <div class="card ${scoreClass} px-2 py-1 me-2" style="min-width: 60px;">
                        <div class="fw-bold">${displayScore}</div>
                    </div>
                    <small class="${textClass}">${dartInfo}</small>
                `;

                legsHtml += `
                    <td class="text-center ${winningClass}">
                        <div class="${containerClass}">
                            ${isWinningThrow && isSpecial ?
                                `<div class="${isShort ? 'short-set-inner' : 'high-finish-inner'} d-flex justify-content-center align-items-center">${innerContent}</div>` :
                                innerContent
                            }
                        </div>
                    </td>
                `;
            } else {
                legsHtml += '<td></td>';
            }
            
            // Dart count
            legsHtml += `<td class="text-center bg-light fw-bold">${dartCount}</td>`;
            
            // Team 2 throw (right column)
            if (team2Throw) {
                const scoreClass = getScoreClass(team2Throw.score);
                const isWinningThrow = team2Throw.remaining_score === 0;
                const displayScore = isWinningThrow ? `üèÜ ${team2Throw.darts_used || 3} ${pluralizeDarts(team2Throw.darts_used || 3)}` : team2Throw.score;
                const winningClass = isWinningThrow ? 'bg-success bg-opacity-25' : '';

                let dartInfo = '';
                let containerClass = 'd-flex justify-content-center align-items-center';
                let textClass = 'text-muted me-2';
                let isSpecial = false;
                let isShort = false;
                let isHigh = false;

                if (isWinningThrow) {
                    const totalDarts = calculateTotalDarts(team2ThrowsArray);
                    isShort = isShortSet(totalDarts);
                    isHigh = isHighFinish(team2Throw.score);

                    const shortSetIndicator = isShort ? ' ‚ö°' : '';
                    const highFinishIndicator = isHigh ? ' üî•' : '';
                    dartInfo = `üéØ ${totalDarts} ${pluralizeDarts(totalDarts)}${shortSetIndicator}${highFinishIndicator}`;

                    if (isShort) {
                        containerClass = 'short-set-container';
                        textClass = 'short-set-text me-2';
                        isSpecial = true;
                    } else if (isHigh) {
                        containerClass = 'high-finish-container';
                        textClass = 'high-finish-text me-2';
                        isSpecial = true;
                    }
                } else {
                    dartInfo = team2Throw.remaining_score;
                }

                const innerContent = `
                    <small class="${textClass}">${dartInfo}</small>
                    <div class="card ${scoreClass} px-2 py-1" style="min-width: 60px;">
                        <div class="fw-bold">${displayScore}</div>
                    </div>
                `;

                legsHtml += `
                    <td class="text-center ${winningClass}">
                        <div class="${containerClass}">
                            ${isWinningThrow && isSpecial ?
                                `<div class="${isShort ? 'short-set-inner' : 'high-finish-inner'} d-flex justify-content-center align-items-center">${innerContent}</div>` :
                                innerContent
                            }
                        </div>
                    </td>
                `;
            } else {
                legsHtml += '<td></td>';
            }
            
            legsHtml += '</tr>';
        }
        
        legsHtml += `
                    </tbody>
                </table>
            </div>
        `;
        
        legsHtml += `
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('legs-container').innerHTML = legsHtml;
    document.getElementById('throws-content').classList.remove('d-none');
}

function getScoreClass(score) {
    // Ignore negative scores for color classification
    const absScore = Math.abs(score);
    if (absScore === 180) return 'score-180';              // 180 - b√§sta f√§rgen (gr√∂n gradient)
    if (absScore >= 140) return 'score-140-179';           // 140-179 - √§nnu mer positiv (bl√• gradient)  
    if (absScore >= 101) return 'score-101-139';           // 101-139 - v√§ldigt positiv (ljusbl√• gradient)
    if (absScore === 100) return 'score-100';              // 100 - positiv (gul gradient)
    if (absScore >= 61) return 'score-61-99';              // 61-99 - ganska positiv (orange/gul)
    if (absScore === 60) return 'score-60';               // 60 - bra (gr√∂n)  
    return 'score-under-60';                               // <60 - neutral f√§rg
}

function calculateTotalDarts(throws) {
    let totalDarts = 0;
    throws.forEach(throwData => {
        if (throwData.score < 0) {
            // Negative score means they used that many darts to win
            totalDarts += Math.abs(throwData.score);
        } else {
            // Normal throw, use darts_used (default 3 if not specified)
            totalDarts += throwData.darts_used || 3;
        }
    });
    return totalDarts;
}

function isShortSet(totalDarts) {
    return totalDarts <= 18;
}

function isHighFinish(score) {
    return Math.abs(score) >= 100;
}

// Load last import info
async function loadLastImport() {
    try {
        const response = await fetch('/api/last-import');
        const data = await response.json();

        if (response.ok && data.end_time) {
            const badge = document.createElement('div');
            badge.className = 'last-update-badge';
            badge.textContent = `Uppdaterad\n${data.end_time.split(' ')[0]}`;
            document.body.appendChild(badge);
        }
    } catch (error) {
        console.error('Kunde inte ladda importinfo:', error);
    }
}

// Load last import on page load
loadLastImport();
</script>
{% endblock %}